@model Homer_MVC.IcebergModel.apareja_auditoriainv
@{
    ViewBag.Title = "Asignación Parejas";
    ViewBag.Icono = "fa fa-male" + "fa fa-male";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/Vendor/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Vendor/bootstrap-toggle-master/css/bootstrap-toggle.min.css" rel="stylesheet" />
    <link href="~/Vendor/BootstrapMultiselect/multiselect.css" rel="stylesheet" />

}

<div class="panel-body">
    <div class="panel-heading" style="background-color:white;  border:solid 1px; border-color:#e4e5e7">
        <div class="panel-body">

            <div id="hbreadcrumb" class="pull-right">

                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Enlaces" data-content="<ul>@ViewBag.nombreEnlaces</ul>" data-html="true">
                    <i class="text-info fa fa-tags"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Documentos" data-content="<ul></i><a href=''>Documento 1</a></ul>  <ul></i><a href=''>Documento 2</a></ul> <ul></i><a href=''>Documento 3</a></ul>" data-html="true">
                    <i class="text-primary fa fa-files-o"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Favoritos" data-content="@ViewBag.Favoritos" data-html="true">
                    <i class="text-warning fa fa-star"></i>
                </button>

            </div>
            <h3 class="font-light m-b-xs">
                <i class="fa fa-male"></i>&nbsp;<i class="fa fa-male"></i>&nbsp;&nbsp;@ViewBag.Title
            </h3>
            <small>Registro @ViewBag.Title</small>
        </div>
    </div>
</div>
<div class="panel-body" style="padding-top:0px;">
    <div class="hpanel">
        @if (TempData["mensaje"] != null)
        {
            <div class="alert alert-success  alert-dismissible" id="mensaje">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p><i class="fa fa-check fa-2x"></i>  @TempData["mensaje"]</p>
            </div>
        }

        @if (TempData["mensaje_error"] != null)
        {
            <div class="alert alert-danger  alert-dismissible" id="mensaje_error">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p><i class="fa fa-times fa-2x"></i> @TempData["mensaje_error"]</p>
            </div>
        }

        <div id="tabs" class="tab-content">

            <div class="m float-e-margins text-right">
                <div class="tooltip-demo">

                    <div id="div-mensaje"></div>

                </div>
            </div>

            <ul id="tabs-bloquear" class="nav nav-tabs">
                <li class=""><a data-toggle="tab" href="#buscar"><i class="fa fa-search"></i>&nbsp;&nbsp;Auditorías</a></li>
                <li class="active"><a data-toggle="tab" href="#parejas"><i class="fa fa-male"></i>&nbsp;<i class="fa fa-male"></i>&nbsp;&nbsp;Asignación Parejas</a></li>
                @*<li class=""><a data-toggle="tab" href="@Url.Action("Inventario","InventarioFisico")"><i class="fa fa-file-pdf-o"></i>&nbsp;&nbsp;Bloquear</a></li>
                    <li class=""><a data-toggle="tab" onclick="encabezado()"><i class="fa fa-align-left"></i>&nbsp;&nbsp;Auditoría Inventario</a></li>
                        <li class=""><a href="@Url.Action("asignacionParejas","InventarioFisico")"><i class="fa fa-male"></i><i class="fa fa-male"></i>&nbsp;&nbsp;Asignar Parejas</a></li>
                        <li class=""><a href="@Url.Action("desbloquear","InventarioFisico")"><i class="fa fa-unlock"></i>&nbsp;&nbsp;Desbloquear</a></li>
                        <li class=""><a href="@Url.Action("ConteoInventario","InventarioFisico")"><i class="fa fa-hand-pointer-o"></i>&nbsp;&nbsp;Conteo</a></li>*@
            </ul>

            <div id="parejas" class="tab-pane active">
                <div class="panel-body">
                    <div class="alert alert-danger" id="errorPermiso" style="display:none" role="alert">El usuario no tiene permiso de bloquear el inventario</div>
                    @using (Html.BeginForm())
                    {
                        <div class="panel-body-btns text-right">
                            <button id="botonGuardar" name="botonGuardar" class="btn btn-info" type="button"><i class="fa fa-save"></i>&nbsp;&nbsp; Guardar Grupos</button>
                            @*<button id="ubi" name="ubi" onclick="ubica()" class="btn btn-warning" type="button"><i class="fa fa-location-arrow"></i>&nbsp;&nbsp; Asignar Ubicaciones</button>*@
                            <button id="finalizar" name="finalizar" class="btn btn-info" type="submit" style="display:none"></button>

                        </div>

                        @Html.AntiForgeryToken()
                        @Html.Hidden("menu")

                        <div class="form-horizontal">

                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="hpanel" id="panelHabeasData">
                                <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                                    </div>
                                    <i class="fa fa-male"></i>&nbsp;<i class="fa fa-male"></i>&nbsp;&nbsp;&nbsp;Datos generales
                                </div>
                                <div class="panel-body">

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="control-label col-md-2">Encabezado:</label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" name="encabezado" id="encabezado" readonly value="@ViewBag.encabezado" />
                                                    <input type="hidden" name="encabezado_id" id="encabezado_id" value="@ViewBag.id_encabezado" />
                                                    <input type="hidden" name="contador" id="contador" value="" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Persona 1:&nbsp;<i class="text-danger">*</i></label>
                                                <div class="col-md-8">
                                                    @Html.DropDownList("usuarios_1", null, "Seleccione", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Persona 2:&nbsp;</label>
                                                <div class="col-md-8">
                                                    @Html.DropDownList("usuarios_2", null, "Seleccione", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-success" type="button" id="btnAsignar" name="btnAsignar"><i class="fa fa-plus"></i>&nbsp;Asignar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                                    </div>
                                    <i class="fa fa-male"></i>&nbsp;<i class="fa fa-plus"></i>&nbsp;<i class="fa fa-male"></i>&nbsp;&nbsp;&nbsp;Parejas Asignadas
                                </div>
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover" id="parejasAsignadas">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align:center">Número</th>
                                                        <th style="text-align:center">Persona 1</th>
                                                        <th style="text-align:center">Persona 2</th>
                                                        <th style="text-align:center">Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div id="buscar" class="tab-pane">
                <div class="panel-body">
                    <div class="panel-body-busqueda">
                        <div class="table-responsive">
                            <div id="div-mensaje-buscar"></div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="col-md-5">
                                        <button class="form-control btn btn-info" type="button" id="crear_nuevo_btn">Crear nueva auditoría</button>
                                    </div>
                                </div>
                            </div>
                            <table class="table table-striped table-bordered table-hover" id="tablaPaginada">
                                <thead>
                                    <tr>
                                        <th style="text-align:center">Nombre</th>
                                        <th style="text-align:center">Fecha Inicio</th>
                                        <th style="text-align:center">Fecha Fin</th>
                                        <th style="text-align:center">Tipo Conteo</th>
                                        <th style="text-align:center">Conteo 1</th>
                                        <th style="text-align:center">Conteo 2</th>
                                        <th style="text-align:center">Bodega</th>
                                        <th style="text-align:center">Estado</th>
                                        <th style="text-align:center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade hmodal-primary" id="modal_editar_progreso" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Edición de Conteo</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="control-label col-md-4">Parejas:&nbsp;</label>
                            <div class="col-md-8">
                                <select class="form-control" id="select_parejas_modal" name="select_parejas_modal"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="table_editar_progreso">
                        <thead>
                            <tr>
                                <th style="text-align:center">Ubicación</th>
                                <th style="text-align:center">Referencia</th>
                                <th style="text-align:center">Conteo 1</th>
                                <th style="text-align:center">Conteo 2</th>
                                <th style="text-align:center">Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3>Conteo Extra</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="table_editar_progreso_extra">
                        <thead>
                            <tr>
                                <th style="text-align:center">Ubicación</th>
                                <th style="text-align:center">Referencia</th>
                                <th style="text-align:center">Conteo Extra</th>
                                <th style="text-align:center">Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Vendor/BootstrapMultiselect/multiselect.js"></script>
    <script src="~/Vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Vendor/datatablesExcelExport/dataTable1.4.0-buttons.js"></script>
    <script src="~/Vendor/datatablesExcelExport/JSZip3.1.3.min.js"></script>
    <script src="~/Vendor/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/Vendor/pdfmake/build/vfs_fonts.js"></script>
    <script src="~/Vendor/datatablesExcelExport/jsZipDataTables.js"></script>

    <script src="~/Vendor/moment/min/moment-with-locales.min.js"></script>
    <script src="~/Vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="~/Vendor/bootstrap-toggle-master/js/bootstrap-toggle.min.js"></script>



    <script type="text/javascript">
        var numero = 1;
        var cont = 0;
        var idTabla = [];
        var contador = 0;
        contadorId = 0;

        $(document).ready(function () {
            $('#usuarios_1').select2()
            $('#usuarios_2').select2()
            $('#select_parejas_modal').select2()
            browser()
            buscarParejas()
        });

        $('#crear_nuevo_btn').click(function () {
            window.location.href = '@Url.Action("encabezado", "InventarioFisico")'
        })

        function parejas(id){
            window.location.href = '@Url.Action("asignacionParejas", "InventarioFisico")?id=' + id;
        }

        function browser() {
            $.ajax({
                url: '/InventarioFisico/browserEncabezado',
                data: {},
                type: 'POST',
                cache: false,
                success: function (data) {
                    for (var i = 0; i < data.length; i++) {

                        $('#tablaPaginada').find('tbody').append(
                                '<tr>'
                                    + '<td align="left">' + data[i].encabezado + '</td>'
                                    + '<td align="right">' + data[i].fechaInicia + '</td>'
                                    + '<td align="right">' + data[i].fechaFinal + '</td>'
                                    + '<td align="left">' + data[i].tipo + '</td>'
                                    + '<td align="right">' + data[i].progreso_1 + '%</td>'
                                    + '<td align="right">' + data[i].progreso_2 + '%</td>'
                                    + '<td align="left">' + data[i].bodega + '</td>'
                                    + '<td align="left">' + data[i].estado + '</td>'
                                    + '<td align="center">'
                                        + '<button type="button" class="btn btn-xs btn-success" id="asig_parejas' + i + '" title="Asignar Parejas" onclick="parejas(' + data[i].id_encabezado + ')"><i class="fa fa-male"></i>&nbsp;<i class="fa fa-male"></i></button>&nbsp;'
                                        + '<button type="button" class="btn btn-xs btn-info" onclick="valida(' + data[i].id_encabezado + ')">Ver</button>&nbsp;'
                                        + '<button type="button" class="btn btn-xs btn-warning" id="editarProgreso' + i + '" style="display:none" title="Editar Progreso" onclick="cargarLista(' + data[i].id_encabezado + ')"><i class="fa fa-pencil"></i></button>&nbsp;'
                                        + '<button type="button" class="btn btn-xs btn-primary" id="informe' + i + '" style="display:none" title="Informe" onclick="Informe(' + data[i].id_encabezado + ')"><i class="fa fa-align-left"></i></button>&nbsp;'
                                        + '<button type="button" class="btn btn-xs btn-success" id="excel' + i + '" style="display:none" title="Informe Excel" onclick="generarExcel(' + data[i].id_encabezado + ')"><i class="fa fa-file-excel-o"></i></button>'
                                   + '</td>'
                                + '</tr>'
                            )
                        if (data[i].estado == "Activo") {
                            $('#editarProgreso' + i).show()
                            $('#informe' + i).show()
                            $('#asig_parejas' + i).hide()
                            $('#informe' + i).show()
                        }
                        if (data[i].estado == "Finalizado") {
                            $('#editarProgreso' + i).hide()
                            $('#asig_parejas' + i).hide()
                            $('#excel' + i).show()
                            $('#informe' + i).hide()
                        }
                        var fechaHoy = '@DateTime.Now.Date.ToString("yyyy/MM/dd")';
                        if (data[i].fechaFinal <= fechaHoy) {
                            if (data[i].fechaFinal < fechaHoy && data[i].estado == "Inactivo") {
                                $('#informe' + i).hide()
                                $('#asig_parejas' + i).hide()
                            }
                        }
                    }
                }
            })
        };

        function generarExcel(id){
            $.ajax({
                url:'/InventarioFisico/generarExcel',
                data:{
                    id_encab :id
                },
                success: function(data){
                    if (data.carga == 1) {
                        var link = "/Informes Inventario/"+ data.nombre
                        window.location.href = link;
                    }
                    else {
                        swal("Error","No fue posible generar el archivo, valide que si hay información en el inventario","error")    
                    }
                }
            })
        }

        function cargarLista(id) {
            $.ajax({
                url: '/InventarioFisico/cargarListaPareja',
                data: {
                    id_encab: id,
                },
                cache: false,
                type: 'post',
                success: function (data) {
                    $('#select_parejas_modal').empty()
                    for (var i = 0; i < data.length; i++) {
                        $('#select_parejas_modal').append('<option value="' + data[i].value + '">' + data[i].text + '')
                    }
                    $('#modal_editar_progreso').modal('show')
                    //$('body').removeClass('modal-open')
                    $('body').attr('style','width:100%')
                    $('#select_parejas_modal').val('').trigger('change')
                }
            })
        }

        $('#select_parejas_modal').change(function () {
            $('#table_editar_progreso').dataTable().fnDestroy();
            $('#table_editar_progreso').find('tbody').empty();
            $('#table_editar_progreso_extra').dataTable().fnDestroy();
            $('#table_editar_progreso_extra').find('tbody').empty();
            $.ajax({
                url: '/InventarioFisico/CargarTablaDatos',
                data: {
                    id: $('#select_parejas_modal').val()
                },
                type: 'post',
                cache: false,
                success: function (data) {
                    var arreglo = [data.buscar.length]
                    for (var i = 0; i < data.buscar.length; i++) {

                        $('#table_editar_progreso').find('tbody').append(
                                '<tr>'
                                    + '<td>' + data.buscar[i].ubicacion + '</td>'
                                    + '<td>' + data.buscar[i].referencia + '</td>'
                                    + '<td style="width: 10%">'
                                        + '<input id="inputConteo1' + i + '" style="text-align:right" class="form-control col-md-3" value="' + data.buscar[i].conteo_1 + '"/>'
                                        + '<input id="inputConteo1Hidden' + i + '" type="hidden" style="text-align:right" class="form-control col-md-3" value="' + data.buscar[i].conteo_1 + '"/>'
                                    + '</td>'
                                    + '<td>'
                                        + '<input id="inputConteo2' + i + '" style="text-align:right" class="form-control col-md-3" value="' + data.buscar[i].conteo_2 + '"/>'
                                        + '<input id="inputConteo2Hidden' + i + '" type="hidden" style="text-align:right" class="form-control col-md-3" value="' + data.buscar[i].conteo_2 + '"/>'
                                    + '</td>'
                                    + '<td align="center" style="width: 5%">'
                                        + '<button type="button" class="btn btn-info btn-sm form-control" onclick="guardarCambios(' + data.buscar[i].id + ',' + i + ')" title="Guardar Cambios"><i class="fa fa-save"></i></button>'
                                    + '</td>'
                                + '</tr>'
                            )
                        if (data.buscar[i].conteo_1 == 0) {
                            $('#inputConteo1' + i).prop('disabled', true)
                            $('#inputConteo1Hidden' + i).prop('disabled', true)
                        }
                        if (data.buscar[i].conteo_2 == 0) {
                            $('#inputConteo2' + i).prop('disabled', true)
                            $('#inputConteo2Hidden' + i).prop('disabled', true)
                        }
                        arreglo[i] = {
                            id: data.buscar[i].id,
                            input1: $('#inputConteo1' + i).val(),
                            inputH1: $('#inputConteo1Hidden' + i).val(),
                            input2: $('#inputConteo2' + i).val(),
                            inputH2: $('#inputConteo2Hidden' + i).val(),
                        }

                    }
                    for (var i = 0; i < data.extra.length; i++) {

                        $('#table_editar_progreso_extra').find('tbody').append(
                                '<tr>'
                                    + '<td>' + data.extra[i].ubicacion + '</td>'
                                    + '<td>' +'('+ data.extra[i].ref_codigo +')' + data.extra[i].referencia + '</td>'
                                    + '<td style="width: 10%">'
                                        + '<input id="inputConteo3' + i + '" style="text-align:right" class="form-control col-md-3" value="' + data.extra[i].conteo3 + '"/>'
                                        + '<input id="inputConteo3Hidden' + i + '" type="hidden" style="text-align:right" class="form-control col-md-3" value="' + data.extra[i].conteo3 + '"/>'
                                    + '</td>'
                                    + '<td align="center" style="width: 5%">'
                                        + '<button type="button" class="btn btn-info btn-sm form-control" onclick="guardarCambios2(' + data.extra[i].id_conteo + ',' + i + ')" title="Guardar Cambios"><i class="fa fa-save"></i></button>'
                                    + '</td>'
                                + '</tr>'
                            )
                        //if (data.extra[i].conteo3 == 0) {
                        //    $('#inputConteo3' + i).prop('disabled', true)
                        //    $('#inputConteo3Hidden' + i).prop('disabled', true)
                        //}

                        arreglo[i] = {
                            id: data.extra[i].id,
                            input1: $('#inputConteo3' + i).val(),
                            inputH1: $('#inputConteo3Hidden' + i).val(),
                        }

                    }

                },
                complete: function (data) {
                    $('#table_editar_progreso').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[5, 10, 15, -1], [5, 10, 15, "All"]],
                        buttons: []
                    });
                    $('#table_editar_progreso_extra').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[5, 10, 15, -1], [5, 10, 15, "All"]],
                        buttons: []
                    });
                }
            })
        })

        function guardarCambios2(id, i) {
            var conteo3 = $('#inputConteo3' + i).val();
            var conteo3_hiden = $('#inputConteo3Hidden' + i).val();
            $.ajax({
                url: '/InventarioFisico/guardarCambios2',
                data: {
                    id: id,
                    conteo_3_nuevo: conteo3,
                    conteo_3_antiguo: conteo3_hiden,
                    pareja: $('#select_parejas_modal').val()
                },
                type: 'post',
                cache: false,
                success: function (data) {
                    if (data == true) {
                        swal("Modificación realizada con éxito", "", "success")
                        setTimeout(function(){
                            location.reload()
                        },1000)
                    }
                    else {
                        swal("No hizo modificaciones para actualizar", "", "error")
                    }
                }
            })
        }

        function guardarCambios(id, i) {
            var conteo1 = $('#inputConteo1' + i).val();
            var conteo1_hiden = $('#inputConteo1Hidden' + i).val();
            var conteo2 = $('#inputConteo2' + i).val();
            var conteo2_hiden = $('#inputConteo2Hidden' + i).val();
            $.ajax({
                url: '/InventarioFisico/guardarCambios',
                data: {
                    id: id,
                    conteo_1_nuevo: conteo1,
                    conteo_1_antiguo: conteo1_hiden,
                    conteo_2_nuevo: conteo2,
                    conteo_2_antiguo: conteo2_hiden
                },
                type: 'post',
                cache: false,
                success: function (data) {
                    if (data == true) {
                        swal("Modificación realizada con éxito", "", "success")
                    }
                    else {
                        swal("No hizo modificaciones para actualizar", "", "error")
                    }
                }
            })
        }

        function Informe(id) {
            window.location.href = '@Url.Action("Informe", "InventarioFisico")?id=' + id;
        }

        function encabezado() {
            window.location.href = '@Url.Action("encabezado", "InventarioFisico")'
        }

        function eliminar(id) {
            $('#fila' + id).remove()
            enviarTabla()
        }

        function eliminarBD(id) {
            swal({
                title: "Confirme",
                text: "¿Está seguro que desea eliminar esta pareja ya asignada?",
                type: "warning",
                confirmButtonColor: "#62cb31",
                confirmButtonText: "Aceptar",
                showCancelButton: true,
                cancelButtonText: "Cancelar",
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    $.ajax({
                        url:'/InventarioFisico/eliminarParejas',
                        data: {id:id},
                        success: function(data){
                            $('#parejasAsignadas').find('tbody').empty()
                            buscarParejas()
                            setTimeout(function(){
                                swal("Pareja eliminada con éxito","","warning")
                            },500)
                            enviarTabla()

                        }
                    })
                }
            }

            )
        }

        function enviarTabla() {

            $('.personasAsignadas').each(function () {
                idTabla[cont] = $(this).val()
                cont++
            })
            cont = 0
            $('#usuarios_1').empty().select2()
            $('#usuarios_2').empty().select2()

            $.ajax({
                url: '/InventarioFisico/refrescarParejas',
                data: {
                    usuario_2: $('#usuarios_2').val(),
                    tabla: idTabla,
                    act_lista_1: false,
                    act_lista_2: false,
                },
                type: 'POST',
                cache: false,
                success: function (data) {
                    if ($('#usuarios_2').val() == "" || $('#usuarios_2').val() == null) {
                        $('#usuarios_2').empty()
                        $('#usuarios_2').append('<option value="">Seleccione')
                        for (var i = 0; i < data.usuarios.length; i++) {
                            $('#usuarios_2').append('<option value="' + data.usuarios[i].value + '">' + data.usuarios[i].text + '')
                        }
                    }
                    if ($('#usuarios_1').val() == "" || $('#usuarios_1').val() == null) {
                        $('#usuarios_1').empty()
                        $('#usuarios_1').append('<option value="">Seleccione')
                        for (var i = 0; i < data.usuarios.length; i++) {
                            $('#usuarios_1').append('<option value="' + data.usuarios[i].value + '">' + data.usuarios[i].text + '')
                        }
                    }
                    $('#usuarios_1').select2()
                    $('#usuarios_2').select2()
                }
            })
        }

        function buscarParejas() {
            $.ajax({
                url: '/InventarioFisico/buscarParejas',
                data: {
                    id: @ViewBag.id_encabezado,
                },
                type: 'POST',
                cache: false,
                success: function (data) {
                    var max = 0;
                    for (var i = 0; i < data.length; i++) {
                        max = data[i].numero
                    }
                    for (var i = 0; i < data.length; i++) {

                        $('#parejasAsignadas').find('tbody').append(
                            '<tr id="fila' + contador + '">'
                                + '<td align="right">'
                                     + '<input type="hidden" class="personasAsignadas" name="parejaId_' + i + '" id="parejaId_' + i + '" value="' + data[i].id_pareja + '" />' + data[i].numero
                                     + '<input type="hidden" name="parejaId_bd' + i + '" id="parejaId_bd' + i + '" value="' + data[i].id_pareja + '" />'
                                + '</td>'
                                + '<td>'
                                    + '<input type="hidden" class="personasAsignadas" name="personas1_' + i + '" id="personas1_' + i + '" value="' + data[i].id_persona_1 + '" />' + data[i].persona_1
                                + '</td>'
                                + '<td>'
                                    + '<input type="hidden" class="personasAsignadas" name="personas2_' + i + '" id="personas2_' + i + '" value="' + data[i].id_persona_2 + '" />' + data[i].persona_2 +
                                '</td>'
                                + '<td align="center">'
                                    + '<button type="button" class="btn btn-sm btn-circle btn-danger" onclick="eliminarBD(' +  data[i].id_pareja + ')"><i class="fa fa-close" title="Eliminar Pareja"></i></button>'
                                + '</td>'
                            + '</tr>'
                        )
                        contador++
                        numero = max+1

                    }

                    enviarTabla()
                }
            })
        }

        function valida(id){
            window.location.href = '@Url.Action("edit", "InventarioFisico")?id=' + id;
        }

        function ubica(){
            window.location.href = '@Url.Action("edit", "InventarioFisico")?id=' + @ViewBag.id_encabezado;
        }

        $('#btnAsignar').click(function () {
            var usuario_2 = ""
            if ($('#usuarios_1').val() == "" || $('#usuarios_1').val() == null) {
                swal("Persona 1 es obligatorio", "", "warning")
            } else {
                if ($('#usuarios_2').val() == "" || $('#usuarios_2').val() == null) {
                    usuario_2 = ""
                } else {
                    usuario_2 = $('#usuarios_2 option:selected').text()
                }
                $('#parejasAsignadas').find('tbody').append(
                        '<tr id="fila' + contador + '">'
                            + '<td align="right">'
                                 + '<input type="hidden" class="personasAsignadas" name="parejaId_' + contador + '" id="parejaId_' + contador + '" value="' + numero + '" />' + numero
                                 + '<input type="hidden" name="parejaId_bd' + contador + '" id="parejaId_bd' + contador + '" value="" />'
                            + '</td>'
                            + '<td>'
                                + '<input type="hidden" class="personasAsignadas" name="personas1_' + contador + '" id="personas1_' + contador + '" value="' + $('#usuarios_1').val() + '" />' + $('#usuarios_1 option:selected').text()
                            + '</td>'
                            + '<td>'
                                + '<input type="hidden" class="personasAsignadas" name="personas2_' + contador + '" id="personas2_' + contador + '" value="' + $('#usuarios_2').val() + '" />' + usuario_2 +
                            '</td>'
                            + '<td align="center">'
                                + '<button type="button" class="btn btn-sm btn-circle btn-danger" onclick="eliminar(' + contador + ')"><i class="fa fa-close" title="Eliminar Pareja"></i></button>'
                            + '</td>'
                        + '</tr>'
                    )

                contador++
                numero++
                enviarTabla()
            }
        })

        $('#usuarios_1').change(function () {
            $('.personasAsignadas').each(function () {
                idTabla[cont] = $(this).val()
                cont++
            })
            cont = 0
            $.ajax({
                url: '/InventarioFisico/refrescarParejas',
                data: {
                    usuario_1: $('#usuarios_1').val(),
                    act_lista_1: false,
                    act_lista_2: true,
                    tabla: idTabla
                },
                type: 'POST',
                cache: false,
                success: function (data) {
                    if (data.act_lista_2 == true && ($('#usuarios_2').val() == "") || $('#usuarios_2').val() == null) {
                        $('#usuarios_2').empty()
                        $('#usuarios_2').append('<option value="">Seleccione')
                        for (var i = 0; i < data.usuarios.length; i++) {
                            $('#usuarios_2').append('<option value="' + data.usuarios[i].value + '">' + data.usuarios[i].text + '')
                        }
                    }

                }
            })
        })

        $('#usuarios_2').change(function () {
            $('.personasAsignadas').each(function () {
                idTabla[cont] = $(this).val()
                cont++
            })
            cont=0
            $.ajax({
                url: '/InventarioFisico/refrescarParejas',
                data: {
                    usuario_2: $('#usuarios_2').val(),
                    act_lista_1: true,
                    act_lista_2: false,
                    tabla: idTabla
                },
                type: 'POST',
                cache: false,
                success: function (data) {
                    if (data.act_lista_1 == true && ($('#usuarios_1').val() == "") || $('#usuarios_1').val() == null) {
                        $('#usuarios_1').empty()
                        $('#usuarios_1').append('<option value="">Seleccione')
                        for (var i = 0; i < data.usuarios.length; i++) {
                            $('#usuarios_1').append('<option value="' + data.usuarios[i].value + '">' + data.usuarios[i].text + '')
                        }
                    }
                }
            })
        })

        $('#botonGuardar').click(function () {
            swal({
                title: "Guardar",
                text: "¿Está seguro que desea finalizar?",
                type: "warning",
                confirmButtonColor: "#62cb31",
                confirmButtonText: "Aceptar",
                showCancelButton: true,
                cancelButtonText: "Cancelar",
                closeOnCancel: true


            },
            function (isConfirm) {
                if (isConfirm) {
                    $('#contador').val(contador)
                    //ubica()
                    $('#finalizar').trigger('click')

                }
            }

            )
        })




    </script>

}
