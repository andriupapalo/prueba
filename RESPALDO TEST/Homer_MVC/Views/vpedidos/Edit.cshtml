@model Homer_MVC.IcebergModel.VehiculoPedidoModel
@* jairo01 *@
@{
    ViewBag.Title = "Pedido Vehículos";
    ViewBag.Icono = "fa fa-file-text-o";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/Vendor/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/Vendor/metisMenu/dist/metisMenu.css" />
    <link rel="stylesheet" href="~/Vendor/sweetalert/lib/sweet-alert.css" />
    <link href="~/Vendor/bootstrap-toggle-master/css/bootstrap-toggle.min.css" rel="stylesheet" />

    @Styles.Render("~/bundles/select2/css")
}

<style>
    .disabledbutton {
        opacity: 0.8;
        pointer-events: none;
    }
</style>

<div class="panel-body">

    <div class="panel-heading" style="background-color: white; border: solid 1px; border-color: #e4e5e7">
        <div class="panel-body">

            <div id="hbreadcrumb" class="pull-right">

                <button type="button" class="btn btn-mini btn-default" style="border-radius: 25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Enlaces" data-content="<ul>@ViewBag.nombreEnlaces</ul>" data-html="true">
                    <i class="text-info fa fa-tags"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius: 25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Documentos" data-content="<ul></i><a href=''>Documento 1</a></ul>  <ul></i><a href=''>Documento 2</a></ul> <ul></i><a href=''>Documento 3</a></ul>" data-html="true">
                    <i class="text-primary fa fa-files-o"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius: 25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Favoritos" data-content="@ViewBag.Favoritos" data-html="true">
                    <i class="text-warning fa fa-star"></i>
                </button>

            </div>
            <h3 class="font-light m-b-xs">
                <i class="text-info @ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title
            </h3>
            <small>Registro @ViewBag.Title</small>
        </div>
    </div>
</div>

<div class="panel-body" style="padding-top: 0px;">
    <div class="hpanel">
        @if (TempData["mensaje"] != null)
        {
            <br />
            <div class="alert alert-success  alert-dismissible" id="mensaje">
                <button type="button" class="close" data-dismiss="alert" arial-label="close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <p>
                    <i class="fa fa-check fa-2x"></i> @TempData["mensaje"]
                </p>
            </div>
        }

        @if (TempData["mensaje_error"] != null)
        {
            <br />
            <div class="alert alert-danger  alert-dismissible" id="mensaje_error">
                <button type="button" class="close" data-dismiss="alert" arial-label="close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <p>
                    <i class="fa fa-times fa-2x"></i> @TempData["mensaje_error"]
                </p>
            </div>
        }

        <div id="tabs" class="tab-content">

            <div class="m float-e-margins text-right">
                <div class="tooltip-demo">
                    <div id="div-mensaje"></div>
                </div>
            </div>

            <ul id="tabs-crear" class="nav nav-tabs">
                <li class="active">
                    <a data-toggle="tab" href="#crear"><i class="@ViewBag.Icono"></i>&nbsp;&nbsp;Editar</a>
                </li>
                <li class="" id="buscarA" onclick="buscarDatos()">
                    <a data-toggle="tab" href="#buscar"><i class="fa fa-search"></i>&nbsp;&nbsp;Búsquedas</a>
                </li>
                <li class="" id="buscarBa" onclick="buscarDatosBackOffice()">
                    <a data-toggle="tab"><i class="fa fa-search"></i>&nbsp;&nbsp;BrowserBackOffice </a>
                </li>
            </ul>

            <div id="crear" class="tab-pane active">
                <div class="panel-body" id="contentedit">
                    <div class="row" id="botones_traking">
                        @{
                            if (Request.QueryString["id"] != null)
                            {
                                @Html.Action("submenuBackOffice", "vpedidos", new { id = Request.QueryString["id"] })
                            }
                        }
                    </div>
                    <br>

                    @using (Html.BeginForm())
                    {
                        <div class="panel-body-btns text-right">
                            @if (Model.planmayor == null && Model.facturado == false && Model.numfactura == null && Model.anulado == false)
                            {
                                <button class="btn btn-danger btnModal" id="btnAnular" type="button"><i class="fa fa-times"></i>&nbsp;&nbsp;&nbsp;Anular</button>
                            }
                            @*<button class="btn btn-success" type="button" id="btnabrirCotDigital"><i class="fa fa-file-pdf-o"></i>&nbsp;&nbsp;&nbsp;CotDigital</button>&nbsp;&nbsp;*@
                            <button class="btn btn-success ocultable" type="button" id="btnGenerarPDFPedido"><i class="fa fa-file-pdf-o"></i>&nbsp;&nbsp;&nbsp;Generar PDF</button>&nbsp;&nbsp;
                            <button class="btn btn-primary ocultable" type="button" id="btnFacturaProforma"><i class="fa fa-file-text-o"></i>&nbsp;&nbsp;&nbsp;Factura Proforma</button>&nbsp;&nbsp;
                            <a class="btn btn-info" id="btnNuevo" href="../../vpedidos?menu=@ViewBag.id_menu"><i class="@ViewBag.Icono"></i>&nbsp;&nbsp;&nbsp;Crear nuevo</a>&nbsp;&nbsp;
                            <a class="btn btn-info" id="btnVolver" href="../../vpedidos/BrowserFlotas" hidden><i class="fa fa-chevron-circle-left"></i>&nbsp;&nbsp;&nbsp;Volver</a>&nbsp;&nbsp;

                            @if (Model.facturado != false)
                            {
                                <div class="alert alert-warning">
                                    <strong>Atención!</strong> Este pedido ya se encuentra facturado.
                                </div>
                            }

                            @if (Model.facturado == false)
                            {
                                <button class="btn btn-info ocultable" id="btnGuardarSimulacion" type="button" onclick="validarObligatorios()"><i class="fa fa-save"></i>&nbsp;&nbsp;&nbsp;Actualizar</button>
                                <button class="btn btn-info" id="btnGuardar" style="display: none" type="submit"><i class="fa fa-save"></i>&nbsp;&nbsp;&nbsp;Actualizar</button>
                                if (ViewBag.asignado == 1 && ViewBag.facturar == false && ViewBag.facturado == false)
                                {
                                    <button class="btn btn-primary2" type="button" id="btnConfirmarFacturar"><i class="fa fa-file-text-o"></i>&nbsp;&nbsp;&nbsp;Marcar para Facturar</button>
                                }
                            }
                        </div>
                        <input type="hidden" id="rol_id" value="" />
                        @Html.AntiForgeryToken()
                        @Html.Hidden("menu")
                        @Html.HiddenFor(x => x.id)
                        @Html.HiddenFor(x => x.numero)
                        @Html.HiddenFor(x => x.usado)
                        @Html.HiddenFor(x => x.bodega)
                        @Html.HiddenFor(x => x.fecha)
                        @Html.HiddenFor(x => x.idcotizacion)
                        @Html.HiddenFor(x => x.nit)
                        @*@Html.HiddenFor(x => x.marcvh_id)*@
                        @Html.HiddenFor(x => x.nuevo)
                        @Html.HiddenFor(x => x.usado)
                        @Html.HiddenFor(x => x.userid_creacion)
                        @Html.HiddenFor(x => x.fec_creacion)
                        //@Html.HiddenFor(x => x.valor_unitario)

                        <div class="form-horizontal">

                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-user"></i> Datos Generales
                                </div>
                                <div class="panel-body">

                                    <div class="col-sm-10">
                                        <div class="form-group">
                                            <input type="number" style="visibility: hidden" id="idTercero" />
                                            <label class="control-label label label-info" style="font-size: 13px">Número Pedido: @ViewBag.numpedido&nbsp;</label>
                                            <div class="col-md-6">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-5">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Número de Cotización: &nbsp;</label>
                                                <div class="col-md-6">
                                                    @Html.EditorFor(model => model.numerocotizacion, new { htmlAttributes = new { @class = "form-control", @readonly = "" } })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-5">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Cédula / Nit:&nbsp;<span class="text-danger">*</span></label>
                                                <div class="col-md-6">
                                                    @Html.EditorFor(model => model.numeroIdentificacion, new { htmlAttributes = new { @class = "form-control", @readonly = "" } })
                                                    @Html.ValidationMessageFor(model => model.nit, "", new { @class = "text-danger", id = "nit" })
                                                </div>
                                            </div>
                                        </div>

                                        @*<div class="col-sm-2">
                                                <div class="form-group">
                                                    <div class="col-md-5">
                                                        <button type="button" class="btn btn-primary form-control" onclick="abril_modal_creditos()" title="Ver Créditos Tercero">
                                                            <i class="fa fa-credit-card"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>*@
                                    </div>

                                    <div class="col-sm-12">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered table-hover" id="tablaterceros">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align: center">Nombre</th>
                                                        <th style="text-align: center">Teléfono</th>
                                                        <th style="text-align: center">Correo</th>
                                                        <th style="text-align: center">Celular</th>
                                                        <th style="text-align: center">Ciudad</th>
                                                        <th style="text-align: center">Dirección</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="col-sm-6" id="divNit2">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Cédula / Nit Asegurado:</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("nit_asegurado", null, "Seleccione", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @Html.ValidationMessageFor(model => model.nit_asegurado, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6" id="divNit2">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Cédula / Nit 2:</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("nit2", null, "Seleccione", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @Html.ValidationMessageFor(model => model.nit2, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6" id="divNit3">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Cédula / Nit 3:</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("nit3", null, "Seleccione", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @Html.ValidationMessageFor(model => model.nit3, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6" id="divNit3">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Cédula / Nit 4:</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("nit4", null, "Seleccione", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @Html.ValidationMessageFor(model => model.nit4, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6" id="divNit3">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Cédula / Nit 5:</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("nit5", null, "Seleccione", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @Html.ValidationMessageFor(model => model.nit5, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Asesor:&nbsp;<span class="text-danger">*</span></label>
                                            <div class="col-md-6">
                                                @if (ViewBag.Permiso2 == 1)
                                                {
                                                    @Html.DropDownList("vendedor", null, "", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                    @Html.ValidationMessageFor(model => model.vendedor, "", new { @class = "text-danger" })
                                                }
                                                else
                                                {
                                                    @Html.HiddenFor(model => model.vendedor, new { @class = "form-control" })
                                                    @Html.Editor("nombreAsesor", new { htmlAttributes = new { @class = "form-control", @readonly = "readonly", placeholder = ViewBag.nombreAsesor } })
                                                }

                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Código Flota:&nbsp;</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("codflota", null, "", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @*<select class="form-control js-source-states" name="codflota" id="codflota">
                                                        <option value="">Seleccione</option>
                                                        @foreach (var item in ViewBag.codflota)
                                                        {
                                                            <option value="@item.id">@item.codigo  @item.Descripcion</option>
                                                        }
                                                    </select>*@
                                            </div>
                                            <span class="control-label col-md-6" id="nitFlota"></span>
                                        </div>
                                    </div>

                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Número Flota:&nbsp;</label>
                                            <div class="col-md-6">
                                                @Html.DropDownList("flota", null, "", new { @class = "form-control js-source-states", placeholder = "Seleccione" })
                                                @Html.ValidationMessageFor(model => model.flota, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hpanel" id="div_datospedido">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-check-square" aria-hidden="true"></i> Datos Pedido
                                </div>
                                <div class="panel-body" id="vehiculo1">
                                    <div id="vehiculo">
                                        <div class="row" id="vhcotizado">
                                            <div class="col-lg-3 text-center">
                                                <i class="fa fa-car big-icon text-muted"></i>
                                                <p class="small m-t-md">Registre los datos del vehículo</p><br />
                                                <div class="vhcotizado">
                                                    <label>Tipo Vehículo:&nbsp;</label>
                                                    <h4 id="tipo_vh">@ViewBag.tipovh</h4>
                                                </div>
                                            </div>
                                            <div class="col-lg-9">
                                                <div class="row">
                                                    <div class="col-lg-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Plan Venta: </label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("plan_venta", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Plan Mayor:&nbsp;<span class="text-danger">*</span></label>
                                                            <div class="col-md-6">
                                                                @Html.EditorFor(model => model.planmayor, new { htmlAttributes = new { @class = "form-control datos_pediodo_input" } })
                                                            </div>

                                                            <div class="col-md-1" id="btnPlanMayor">
                                                                @if (Model.planmayor == null)
                                                                {
                                                                    <button type="button" class="btn btn-success btn-circle botonAccion" onclick="buscarVhDisponibles()">
                                                                        <i class="fa fa-search"></i>
                                                                    </button>
                                                                }
                                                                else if (Model.facturado)
                                                                {
                                                                }
                                                                else if (Model.planmayor != null)
                                                                {
                                                                    <button type="button" class="btn btn-danger btn-circle botonAccion" id="btnEliminarPlanMayor" onclick="eliminar_plan_mayor(0)">
                                                                        <i class="fa fa-times"></i>
                                                                    </button>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div id="VehiculoPedidoInicial">
                                                    <div class="row">
                                                        <div class="col-sm-6" @*style="display: none"*@>
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Serie:&nbsp;<span class="text-danger">*</span></label>
                                                                <div class="col-md-8">
                                                                    @Html.EditorFor(model => model.serie, new { htmlAttributes = new { @class = "form-control datos_pediodo_input", @readonly = "readonly" } })
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Color: </label>
                                                                <div class="col-md-8">
                                                                    @Html.EditorFor(model => model.color, new { htmlAttributes = new { @class = "form-control datos_pediodo_input", @readonly = "readonly" } })
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-sm-6">
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Marca:&nbsp;<span class="text-danger">*</span></label>
                                                                <div class="col-md-8">
                                                                    @Html.DropDownList("marcvh_id", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione", required = "required", @readonly = "" })
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Modelo: </label>
                                                                <div class="col-md-8">
                                                                    @Html.DropDownList("modelo", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                                    @Html.Hidden("modelosele")
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Año Modelo: </label>
                                                                <div class="col-md-8">
                                                                    @Html.DropDownList("id_anio_modelo", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                                    @Html.Hidden("aniosele")

                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <center>
                                                                <button type="button" class="btn btn-warning botonAccion" id="btnCambioVH"><i class="fa fa-edit"></i>&nbsp;&nbsp;&nbsp;Cambiar vehiculo</button>
                                                            </center>
                                                        </div>
                                                    </div>
                                                </div>
                                                @************************************************************** Cambio VH *************************************************************************@
                                                <div class="row" id="modificarVehiculoPedido" style="display: none">
                                                    <input type="hidden" name="esCambio" id="esCambio" value="0" />
                                                    <div class="col-sm-6" @*style="display: none"*@>
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Marca:&nbsp;<span class="text-danger">*</span></label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("marcas", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione", @readonly = "" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Modelo:&nbsp;<span class="text-danger">*</span> </label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("modelosMarca", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Año Modelo: &nbsp;<span class="text-danger">*</span></label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("idAnioModelo", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6" style="display: none" id="motivoDeCambio">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Motivo: &nbsp;<span class="text-danger">*</span></label>
                                                            <div class="col-md-8">
                                                                @Html.TextAreaFor(model => model.motivoCambio, new RouteValueDictionary(new { @class = "someClass datos_pediodo_input", style = "width: 100%; height:50px;" }))
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                @************************************************************* Fin Cambio VH **********************************************************************@

                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Color Deseado: </label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("Color_Deseado", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Color Opcional:</label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("color_opcional", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Nit Prenda:</label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("nit_prenda", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Termi. Placa:</label>
                                                            <div class="col-md-8">
                                                                @Html.EditorFor(model => model.rango_placa, new { htmlAttributes = new { @class = "form-control datos_pediodo_input" } })
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Servicio: <span class="text-danger">*</span></label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownList("servicio", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione", required = "" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Par</label>
                                                            <div class="col-md-2">
                                                                @Html.CheckBoxFor(model => model.placapar, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                            </div>
                                                            <label class="control-label col-md-2">Impar</label>
                                                            <div class="col-md-2">
                                                                @Html.CheckBoxFor(model => model.placaimpar, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Departamento matrícula:</label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownListFor(model => model.iddepartamento, ViewBag.iddepartamento.Items as List<SelectListItem>, "Seleccione", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                                @Html.ValidationMessageFor(model => model.iddepartamento, "", new { @class = "text-danger" })
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-2">Ciudad matrícula:&nbsp;</label>
                                                            <div class="col-md-8">
                                                                @Html.DropDownListFor(model => model.idciudad, ViewBag.idciudad.Items as List<SelectListItem>, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                                @Html.ValidationMessageFor(model => model.idciudad, "", new { @class = "text-danger" })
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group col-lg-12">
                                                    <hr />
                                                </div>

                                                <div class="col-sm-12">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-1 text-primary">Matricula</label>
                                                        <label class="control-label col-md-2">A cargo de:</label>
                                                        <div class="col-md-3">
                                                            @Html.DropDownList("cargomatricula", null, "", new { @class = "form-control js-source-states datos_pediodo_select", placeholder = "Seleccione" })
                                                        </div>
                                                        <div id="divValorMatricula" style="display: none">
                                                            <label class="control-label col-md-2">Valor Matricula: $</label>
                                                            <div class="col-md-3">
                                                                <input type="hidden" name="matriculaOculto" id="matriculaOculto" class="form-control" value="" />
                                                                @Html.EditorFor(model => model.valormatricula, new { htmlAttributes = new { @class = "form-control number valorMatricula datos_pediodo_input", style = "text-align:right", onkeyUp = "return miles(this.id)" } })
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-sm-12">
                                                    <div class="form-group">
                                                        <div class="col-md-6"></div>
                                                        <div id="divPorcObsequio" style="display: none">
                                                            <label class="control-label col-md-2">% Obsequio:</label>
                                                            <div class="col-md-3">
                                                                @Html.EditorFor(model => model.obsequioporcen, new { htmlAttributes = new { @class = "form-control", style = "text-align:right" } })
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group col-lg-12">
                                                    <hr />
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Valor Poliza: $</label>
                                                        <div class="col-md-7">
                                                            @Html.EditorFor(model => model.valorPoliza, new { htmlAttributes = new { @class = "form-control number", type = "text", style = "text-align:right", onkeyUp = "return miles(this.id)" } })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-4">Valor Unitario: $</label>
                                                        <div class="col-md-7">
                                                            @Html.EditorFor(model => model.valor_unitario, new { htmlAttributes = new { @class = "form-control number suma", type = "text", style = "text-align:right", onkeyUp = "return miles(this.id)" } })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">SOAT: $</label>
                                                        <div class="col-md-7">
                                                            @Html.EditorFor(model => model.valorsoat, new { htmlAttributes = new { @class = "form-control number", type = "text", style = "text-align:right", onkeyUp = "return miles(this.id)" } })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-4">% Descuento:</label>
                                                        <div class="col-md-3">
                                                            @Html.EditorFor(model => model.pordscto, new { htmlAttributes = new { @readonly = "true", @class = "form-control", type = "number", style = "text-align:right", min = "0", max = "100", pattern = "^[0-9]+" } })
                                                        </div>
                                                        <div class="col-md-4">
                                                            @Html.EditorFor(model => model.vrdescuento, new { htmlAttributes = new { @class = "form-control number resta", @readonly = "", style = "text-align:right" } })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Tipo Carroceria: </label>
                                                        <div class="col-md-7">
                                                            @Html.DropDownList("tipo_carroceria", null, "Seleccione", new { @class = "form-control js-source-states ", placeholder = "Seleccione" })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-md-6"></div>
                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-4">% Iva :</label>
                                                        <div class="col-md-3">
                                                            @Html.EditorFor(model => model.porcentaje_iva, new { htmlAttributes = new { @class = "form-control", type = "number", style = "text-align:right", min = "0", max = "100", pattern = "^[0-9]+", @readonly = "readonly" } })
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input class="form-control number suma" id="valor_iva" value="" readonly style="text-align: right" />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Valor Carroceria: $</label>
                                                        <div class="col-md-7">
                                                            @Html.EditorFor(model => model.vrcarroceria, new { htmlAttributes = new { @class = "form-control number", type = "text", style = "text-align:right", onkeyUp = "return miles(this.id)", @readonly = "readonly" } })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-md-6"></div>
                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-4">% Impuesto Consumo:</label>
                                                        <div class="col-md-3">
                                                            @if (ViewBag.permiso == 1)
                                                            {
                                                                @Html.EditorFor(model => model.porcentaje_impoconsumo, new { htmlAttributes = new { @class = "form-control", type = "number", style = "text-align:right", min = "0", max = "100", pattern = "^[0-9]+" } })
                                                            }
                                                            else
                                                            {
                                                                @Html.EditorFor(model => model.porcentaje_impoconsumo, new { htmlAttributes = new { @class = "form-control", type = "number", style = "text-align:right", min = "0", max = "100", pattern = "^[0-9]+", @readonly = "readonly" } })
                                                            }
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input class="form-control number suma" id="valor_impuesto" value="" style="text-align: right" readonly />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-md-6"></div>
                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-4">Valor Total: $</label>
                                                        <div class="col-md-7">
                                                            @Html.EditorFor(model => model.vrtotal, new { htmlAttributes = new { @class = "form-control number", @readonly = "", style = "text-align:right" } })
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group col-lg-12">
                                                    <hr />
                                                </div>

                                                <div class="form-group col-lg-12">
                                                    <label>Observaciones </label>
                                                    @Html.TextAreaFor(model => model.notas1, new RouteValueDictionary(new { @class = "someClass", style = "width: 100%; height:50px;" }))
                                                </div>

                                                <div class="form-group col-lg-3">
                                                    <label>Es Canje:&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                                    @Html.CheckBoxFor(model => model.escanje, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                </div>

                                                <div class="form-group col-lg-3">
                                                    <label>Es Chevyplan:&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                                    @Html.CheckBoxFor(model => model.eschevyplan, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                </div>

                                                <div class="form-group col-lg-3">
                                                    <label>Es Reposición:&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                                    @Html.CheckBoxFor(model => model.esreposicion, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                </div>

                                                <div class="form-group col-lg-3">
                                                    <label>Es Leasing:&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                                    @Html.CheckBoxFor(model => model.esLeasing, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                </div>

                                                <div class="form-group col-lg-3">
                                                    <label>Venta Gerencia:&nbsp;&nbsp; </label>
                                                    @Html.CheckBoxFor(model => model.venta_gerencia, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                </div>

                                                <div class="form-group col-lg-12">
                                                    <hr />
                                                </div>

                                                <div class="form-group col-lg-3">
                                                    <label>Facturado:&nbsp;&nbsp;&nbsp;&nbsp; </label>
                                                    @Html.CheckBoxFor(model => model.facturado, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                    @*@Html.DisplayFor(model => model.facturado)*@
                                                </div>

                                                <div class="form-group col-lg-5">
                                                    <label>Numero Factura</label>
                                                    @Html.EditorFor(model => model.numfactura, new { htmlAttributes = new { @class = "form-control", @readonly = "" } })
                                                </div>

                                                <div class="form-group col-lg-2"></div>
                                                <div class="form-group col-lg-3">
                                                    <label>Anulado: &nbsp;&nbsp;</label>
                                                    @Html.CheckBoxFor(model => model.anulado, new { data_toggle = "toggle", data_size = "mini", @class = "botonAccion" })
                                                    @*@Html.DisplayFor(model => model.anulado, new { })*@
                                                </div>

                                                <div class="form-group col-lg-12">
                                                    <hr />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-check-square" aria-hidden="true"></i> Accesorios
                                </div>
                                <div class="panel-body">
                                    @if (Model.facturado == false)
                                    {
                                        <div class="col-lg-12">

                                            <input type="hidden" value="" name="lista_repuestos" id="lista_repuestos" />

                                            <div class="col-sm-12">
                                                <label class="control-label col-md-4">Tipo De Accesorio:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                                <div class="col-md-6">
                                                    <input type="radio" class="botonAccion" onclick="rbGenericos()" value="generico" name="tipoRepuesto" id="rbGenerico" /> Accesorio Generico&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                    <input type="radio" class="botonAccion" onclick="rbModelos()" value="modelo" id="rbModelo" name="tipoRepuesto" /> Accesorio Por Modelo
                                                </div>
                                            </div>

                                            <div class="col-sm-4">
                                                <div class="form-group">
                                                    <label class="control-label col-md-4">Seleccione:&nbsp;<span class="text-danger">*</span></label>
                                                    <div class="col-md-6">
                                                        <select class="form-control js-source-states" onchange="costos()" name="selectRepuestos" id="selectRepuestos"></select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-4">
                                                <div class="form-group">
                                                    <label class="control-label col-md-4">Costo:&nbsp;<span class="text-danger">*</span></label>
                                                    <div class="col-md-6">
                                                        <input type="text" class="form-control number" name="txtCostoAccesorio" id="txtCostoAccesorio" onkeyUp="return miles(this.id)" />
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-4">
                                                <div class="form-group">
                                                    <label class="control-label col-md-4">Cantidad:&nbsp;<span class="text-danger">*</span></label>
                                                    <div class="col-md-6">
                                                        <input type="text" class="form-control number" name="cantidadRespuesto" id="cantidadRespuesto" />
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-2">
                                                <div class="form-group">
                                                    <label class="control-label col-md-4">Obsequio:</label>
                                                    <div class="col-md-6">
                                                        <input type="checkbox" value="true" name="slcobsequio" id="slcobsequio" data-toggle="toggle" , data-size="mini" }) />
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-2">
                                                <div class="form-group">
                                                    <div class="col-md-2 rpt">
                                                        <button class="btn btn-success botonAccion" type="button" onclick="pintarTablaAccesorio()">agregar</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover" id="tablaAccesorios">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align: center">Código</th>
                                                        <th style="text-align: center">Accesorio</th>
                                                        <th style="text-align:center">Descripción</th>
                                                        <th style="text-align: center">Obsequio</th>
                                                        <th style="text-align: center">Valor</th>
                                                        <th style="text-align: center">Cantidad</th>
                                                        <th style="text-align: center">Total</th>
                                                        <th style="text-align: center">Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="formaDepago" class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-check-square" aria-hidden="true"></i> Formas de Pago
                                </div>
                                <div class="panel-body">
                                    <div class="col-lg-12">
                                        <center>
                                            <label class="label label-primary" style="font-size: 14px">Créditos solicitados por el cliente</label>
                                        </center>
                                    </div>
                                    <div class="row" id="tieneCreditos">
                                        <div class="col-lg-12">
                                            <input type="hidden" id="idcreditoseleccionado2" name="idcreditoseleccionado2" value="" />
                                            <div class="table-responsive">
                                                <div id="div-mensaje-buscar"></div>
                                                <table class="table table-striped table-bordered table-hover" id="tablatieneCreditos">
                                                    <thead>
                                                        <tr>
                                                            <th style="text-align: center">Selecion</th>
                                                            <th style="text-align: center">Fecha Solicitud</th>
                                                            <th style="text-align: center">Estado</th>
                                                            <th style="text-align: center">Valor Solicitado</th>
                                                            <th style="text-align: center">Valor Aprobado</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <input type="hidden" name="lista_pagos" id="lista_pagos" value="" />

                                    <div class="col-lg-12" id="pagos">
                                    </div>

                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover" id="tablaPagos">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align: center">Forma de Pago</th>
                                                        <th style="text-align: center">Valor</th>
                                                        <th style="text-align: center">Fecha de Pago</th>
                                                        <th style="text-align: center">Banco</th>
                                                        <th style="text-align: center">Observaciones</th>
                                                        <th style="text-align: center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-check-square" aria-hidden="true"></i> Retomas
                                </div>
                                <div class="panel-body">
                                    <input type="hidden" name="lista_retomas" id="lista_retomas" value="" />

                                    <div id="divRetomas"></div>

                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover" id="tablaRetomas">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align: center">Modelo</th>
                                                        <th style="text-align: center">Placa</th>
                                                        <th style="text-align: center">Kilometraje</th>
                                                        <th style="text-align: center">Valor</th>
                                                        <th style="text-align: center">Obligaciones</th>
                                                        <th style="text-align: center">Valor Obligación</th>
                                                        <th style="text-align: center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-wrench" aria-hidden="true"></i> Costos adicionales
                                </div>
                                <div class="panel-body">
                                    <input type="hidden" name="lista_costos" id="lista_costos" value="" />

                                    <div id="divCostosA"></div>

                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover" id="tablaCostosA">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align: center">Descripcion</th>
                                                        <th style="text-align: center">Obsequio</th>
                                                        <th style="text-align: center">Valor</th>
                                                        <th style="text-align: center">Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="hpanel">
                                <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                                    <div class="panel-tools">
                                        <a class="showhide">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </div>
                                    <i class="fa fa-check-square" aria-hidden="true"></i> Pagos Recibidos
                                </div>

                                <div class="panel-body">
                                    <div class="col-lg-12">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover" id="tablaPagosR">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align: center">Forma de Pago</th>
                                                        <th style="text-align: center">Valor</th>
                                                        <th style="text-align: center">Fecha</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div id="buscar" class="tab-pane">
                <div class="panel-body">
                    <div class="panel-body-busqueda">
                        <div class="table-responsive">
                            <div id="div-mensaje-buscar"></div>
                            <table class="table table-striped table-bordered table-hover" id="tablaPaginada">
                                <thead>
                                    <tr>
                                        <th style="text-align: center"># Pedido</th>
                                        <th style="text-align: center">Bodega</th>
                                        <th style="text-align: center">Asesor</th>
                                        <th style="text-align: center">Modelo</th>
                                        @*<th style="text-align:center">Valor total</th>*@
                                        <th style="text-align: center">Cliente</th>
                                        <th style="text-align: center">Fecha</th>
                                        <th style="text-align: center">Fuente</th>
                                        <th style="text-align: center">Subfuente</th>
                                        <th style="text-align: center">Plan Mayor</th>
                                        <th style="text-align: center">Fecha Asignación</th>
                                        <th style="text-align: center">Facturado</th>
                                        <th style="text-align: center"># Factura</th>
                                        <th style="text-align: center">Anulado</th>
                                        <th style="text-align: center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*modal devolucion ya realizada*@
<div id="modal_anulacion" class="modal" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                @*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
                <h5 class="modal-title" id="exampleModalLongTitle">
                    <b>Anular pedido</b>
                </h5>
            </div>
            <div class="modal-body">
                <div class="row" style="text-align: left;">
                    <label>Motivo de anulación<span class="text-danger">*</span></label>
                    <select name="idanulacion" id="idanulacion" class="form-control js-source-states" required="required">
                        <option></option>
                    </select>
                </div>

                <div class="row" style="text-align: left;">
                    <label>Observaciones </label>
                    @Html.TextAreaFor(model => model.motivo_anulacion, new RouteValueDictionary(new { @class = "someClass", style = "width: 100%; height:50px;" }))
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary btnAnular" data-dismiss="modal">Guardar</button>
            </div>
        </div>
    </div>
</div>

@*modal accesorios desde echibicion*@
<div class="modal fade hmodal-info" id="vhacceexhibicion" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Repuestos de Exhibición</h4>
                <small class="font-bold">El vehículo viene con los siguientes accesorios desde exhibición. Si va a retirar alguno, marquelo ahora. </small><br />
                <small class="font-bold"><b class="text-danger">Nota: </b>Solo puede retirar aquellos accesorios que se puedan retirar.</small>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <div id="div-mensaje-buscar">
                        <div class="alert alert-warnning alert-dismissible" id="div_averia" style="display: none">
                            @*<button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>*@
                        </div>
                    </div>
                    <table class="table table-striped table-bordered table-hover" id="tablaAccesoriosExi">
                        <thead>
                            <tr>
                                <th style="text-align: center">Seleccione</th>
                                <th style="text-align: center">Codigo</th>
                                <th style="text-align: center">Nombre</th>
                                <th style="text-align: center">Precio Unitario</th>
                                <th style="text-align: center">Cantidad</th>
                                <th style="text-align: center">Descuento</th>
                                <th style="text-align: center">IVA</th>
                                <th style="text-align: center">Valor Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    @Html.Editor("listaretirar")
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnGuardarCambios" data-dismiss="modal" class="btn btn-primary">Aceptar</button>
            </div>
        </div>
    </div>
</div>


@*modal vh disponibles*@
<div class="modal fade hmodal-info" id="vhdisponibles" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Vehículos Disponibles</h4>
                <small class="font-bold">Seleccione un vehículo de la lista para asignar al pedido</small><br />
                <small class="font-bold"><b class="text-danger">Nota: </b>Solo puede seleccionar los vehículos que se encuentren dentro de su misma bodega</small>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <div id="div-mensaje-buscar">
                        <div class="alert alert-warnning alert-dismissible" id="div_averia" style="display: none">
                            <button type="button" class="close" data-dismiss="alert" arial-label="close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <p id="mns_averia"></p>
                        </div>
                    </div>
                    <table class="table table-striped table-bordered table-hover" id="tablaVehiculosD">
                        <thead>
                            <tr>
                                <th style="text-align: center">Seleccione</th>
                                <th style="text-align: center">Plan Mayor</th>
                                <th style="text-align: center">Modelo</th>
                                <th style="text-align: center">Año Modelo</th>
                                <th style="text-align: center">Fecha Compra</th>
                                <th style="text-align: center">Bodega</th>
                                <th style="text-align: center">Ubicación</th>
                                <th style="text-align: center">Días Inventario</th>
                                <th style="text-align: center">Color</th>
                                <th style="text-align: center">Estado</th>
                                <th style="text-align:center">Fecha recepción</th>
                                <th style="text-align: center">Averias</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <button type="button" id="btnGuardarPlanMayor" data-dismiss="modal" class="btn btn-primary">Aceptar</button>
            </div>
        </div>
    </div>
</div>

@*modal porcentaje erroneo*@
<div class="modal fade" id="modal_porcentajes" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Error en porcentaje</h5>
            </div>
            <div class="modal-body">
                El valor del porcentaje no puede ser mayor a 100
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@*modal factura proforma*@
<div class="modal fade hmodal-info" id="modalFacturaProforma" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Factura Proforma</h4>
                <small class="font-bold">Seleccione a quien va dirigido</small>
            </div>
            <div class="modal-body">

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-3">NIT:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <select id="selectNit" class="form-control"></select>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-3">Direcci&oacute;n:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="txtDireccionTercero" placeholder="Direccion" />
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-3">Ciudad:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="txtCiudadTercero" placeholder="Ciudad" />
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-3">Valor cr&eacute;dito:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="valorCredito" name="valorCredito" placeholder="Valor cr&eacute;dito" readonly />
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-3">Valor a solicitar:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="valorSolicitado" name="valorSolicitado" placeholder="Valor a solicitar" onkeyUp="return miles(this.id)" />
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-3">Observaciones:&nbsp;</label>
                        <div class="col-md-8">
                            <textarea style="height: 80px; width: 100%;" id="txtAreaObservacion"></textarea>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12" style="display: none" id="alertaFacturaProformaModal">
                    <div class="form-group">
                        <div class="alert alert-warning">
                            <strong>Alerta!</strong> Los campos marcado con (*) son obligatorios.
                        </div>
                    </div>
                </div>
                <label></label>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <button type="button" id="btnGenerarFacturaProforma" class="btn btn-primary">Aceptar</button>
            </div>
        </div>
    </div>
</div>

@*modal agregar pago erroneo*@
<div class="modal fade" id="modal_agregarPago" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Error al actualizar el pedido</h5>
            </div>
            <div class="modal-body">
                No puede guardar un pedido si la diferencia es diferente de cero (0)
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@*modal agregar pago erroneo (campos obligatorios)*@
<div class="modal fade" id="modalErrorObligatorios" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Error Campos Obligatorios</h5>
            </div>
            <div class="modal-body">
                Por favor diligencie los campos marcados con (*), estos son obligatorios; O la forma de pago seleccionada requiere selección de un banco
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalCargandoInfo" class="modal" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                @*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
                <h4 class="modal-title" id="modal-title"></h4>
            </div>
            <div class="modal-body">
                <div style="text-align: center" id="cargando"></div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal_creditos" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" style="width: 50%;">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header">
                <h4 class="modal-title">
                    <font>
                        <font>Créditos Tercero</font>
                    </font>
                </h4>
            </div>

            <div class="modal-body" id="datosModal">
                <div class="hpanel">
                    <div class="panel-heading hbuilt" style="background-color: #e4e5e7">
                        <div class="panel-tools">
                            <a class="showhide">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                        <i class="fa fa-car  text-primary font-lg"></i>&nbsp;&nbsp;Créditos
                    </div>
                    <div class="panel-body">
                        <table class="table table-striped table-bordered table-hover" id="tabla_creditos">
                            <thead>
                                <tr>
                                    <th style="text-align: center">Estado</th>
                                    <th style="text-align: center">Valor Solicitado</th>
                                    <th style="text-align: center">Valor Aprobado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    <font>
                        <font>Cerrar</font>
                    </font>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalAverias" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Averías Registradas</h4>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <div id="div-mensaje-buscar"></div>
                    <table class="table table-striped table-bordered table-hover" id="tabla_averias">
                        <thead>
                            <tr>
                                <th style="text-align:center">Plan Mayor</th>
                                <th style="text-align:center">Fecha</th>
                                <th style="text-align:center">Descripción</th>
                                <th style="text-align:center">Estado Averia</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@Html.Action("modalesBackOffice")

@section Scripts {
    @Scripts.Render("~/bundles/select2/js")
    <script src="~/Vendor/moment/min/moment.min.js">
    </script>
    <script src="~/Vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Vendor/datatablesExcelExport/dataTable1.4.0-buttons.js"></script>
    <script src="~/Vendor/datatablesExcelExport/JSZip3.1.3.min.js"></script>
    <script src="~/Vendor/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/Vendor/pdfmake/build/vfs_fonts.js"></script>
    <script src="~/Vendor/datatablesExcelExport/jsZipDataTables.js"></script>
    <script src="~/Vendor/sweetalert/lib/sweet-alert.min.js"></script>
    <script src="~/Vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="~/Vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="~/Vendor/bootstrap-toggle-master/js/bootstrap-toggle.js"></script>
    <script src="~/Scripts/submenuBackOffice.js?fec=@DateTime.Now"></script>

    <script type="text/javascript">
        var i = 0;
        var r = 0;
        var re = 0;
        var cot = 0;
        var cos = 0;
        var cifra = 0;
        var bandera = 0;
        var valor_total = 0;
        var valor_total2 = 0;
        var valorFaltante = 0;
        var valorFaltante2 = 0;
        var valorFaltante3 = 0;
        var valorFaltante4 = 0; //usado solo para cuando se elimina un pago de la BD
        var cantidadCostos = 0;
        var cantidadRepuestos = 0;

        $(document).ready(function() {
            tercerobusqueda();
            if (@ViewBag.rol == 1 || @ViewBag.rol == 14 || @ViewBag.rol == 2036) {
                $('#pordscto').prop('readonly', false);
            }
            console.log('@ViewBag.nombrerol');
            if ('@ViewBag.nombrerol' == 'Asesor Comercial') {
                $("#contentedit").addClass("disabledbutton");
            }
            $('#modalCargandoInfo').modal({ backdrop: 'static', keyboard: false });
            $('#marcvh_id').prop('readonly', true);
            $('#modelo').prop('readonly', true);
            $('#id_anio_modelo').prop('readonly', true);
            $('#rol_id').val('@ViewBag.rol');
            if ($('#rol_id').val() != "2031") {
                $('#botones_traking').hide();
            }
            $("form").keypress(function(e) {
                if (e.which == 13) {
                    return false;
                }
            });
            $('#menu').val(@ViewBag.id_menu);
            $('.js-source-states').select2();
            $('#Color_Deseado').select2();

            if ($('#cargomatricula').val() == 1) {
                $('#divValorMatricula').show();
                $('#divPorcObsequio').hide();
            }

            if ($('#cargomatricula').val() == 2) {
                $('#divValorMatricula').show();
                $('#divPorcObsequio').show();
            }

            if ($('#cargomatricula').val() == 3) {
                $('#divValorMatricula').hide();
                $('#divPorcObsequio').hide();
            }

            if ($('#pordscto').val() != null || $('#pordscto').val() != '') {
                var valor_descuento = (parseInt(quitCommas($('#valor_unitario').val())) * $('#pordscto').val()) / 100;
                $('#vrdescuento').val(addComas(parseInt(valor_descuento)));
            }


            if ($('#porcentaje_impoconsumo').val() != null || $('#porcentaje_impoconsumo').val() != '') {
                var valor_porcentaje =
                    (parseFloat(quitCommas($('#valor_unitario').val())) * $('#porcentaje_impoconsumo').val()) / 100;
                $('#valor_impuesto').val('@ViewBag.valorImpConsumo');
            }

            if ($('#porcentaje_iva').val() != null || $('#porcentaje_iva').val() != '') {
                var valor_porcentaje =
                    (parseFloat(quitCommas($('#valor_unitario').val())) * $('#porcentaje_iva').val()) / 100;
                $('#valor_iva').val('@ViewBag.valorIva');
            }

            //if( $('#codflota').val() == "" && $('#flota').val() == ""){
            //}else {
            //    //buscarDocumentos();
            //}

            validarPlanMayor();
            buscar_tercero();
            setTimeout(function() {
                    buscarPagosyAccesorios();
                },
                1000);
            agregarRetoma();
            agregarCostos();
            modificarValores();

            modificarPlanMayor();
            PermisoModificarVH();
            estadoPedido();
            setTimeout(function() {
                    pagosRecibidos();
                    agregarPago();
                },
                2000);

            setTimeout(function() {
                    verificarRolUsuario();
                    buscarCiudad();
                    //terminoCargadoInfo()
                    //buscarDatos();
                },
                2500);

            setTimeout(function() {
                    PermisoGenerarFacturaProforma();
                },
                3000);
        });

        //======================================== VALIDACION BOTONES ========================================
        function verificarRolUsuario() {
            $.ajax({
                url: '/vpedidos/verificarRolUsuario',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data == 2031) {
                        $('.botonAccion').prop('disabled', true);
                        $('.form-control').prop('disabled', true);

                        $('#btnAnular').prop('disabled', true);
                        $('#btnAnular').hide();

                        $('#btnGuardarSimulacion').prop('disabled', true);
                        $('#btnGuardarSimulacion').hide();
                        $('#btnGuardarSimulacion').css('display', 'none');

                        $('#btnGuardar').prop('disabled', true);
                        $('#btnGuardar').hide();

                        $('#btnFacturaProforma').prop('disabled', false);
                        $('#btnFacturaProforma').show();

                        $('#btnNuevo').prop('disabled', true);
                        $('#btnNuevo').hide();

                        $('#btnVolver').prop('disabled', true);
                        $('#btnVolver').hide();

                        $('#buscarA').hide();
                        $('#buscarBa').show();
                    } else if (data == 4 || data == 2030) {
                        //$('#btnFacturaProforma').prop('disabled', true)
                        //$('#btnFacturaProforma').hide()

                        $('#btnFacturaProforma').prop('disabled', false);
                        $('#btnFacturaProforma').show();

                        $('.botonAccion').prop('disabled', false);
                        $('.form-control').prop('disabled', false);

                        $('#anulado').prop('disabled', true);
                        $('#facturado').prop('disabled', true);

                        $('#btnAnular').prop('disabled', false);
                        $('#btnAnular').show();

                        $('#btnGuardarSimulacion').prop('disabled', false);
                        $('#btnGuardarSimulacion').show();

                        $('#btnGuardar').prop('disabled', false);
                        $('#btnGuardar').hide();

                        $('#btnNuevo').prop('disabled', false);
                        $('#btnNuevo').show();

                        $('#btnVolver').prop('disabled', true);
                        $('#btnVolver').hide();

                        $('#buscarA').show();
                        $('#buscarBa').hide();
                    } else if (data == 2055) {
                        //Para el rol asesor flotas se hace lo siguiente
                        $('#btnNuevo').prop('disabled', true);
                        $('#btnNuevo').hide();
                        $('#buscarA').hide();
                        $('#buscarBa').hide();
                        $('#btnVolver').prop('disabled', false);
                        $('#btnVolver').show();
                    } else {
                        $('.botonAccion').prop('disabled', false);
                        $('.form-control').prop('disabled', false);

                        $('#btnFacturaProforma').prop('disabled', false);
                        $('#btnFacturaProforma').show();

                        $('#anulado').prop('disabled', true);
                        $('#facturado').prop('disabled', true);

                        $('#btnAnular').prop('disabled', false);
                        $('#btnAnular').show();

                        $('#btnGuardarSimulacion').prop('disabled', false);
                        $('#btnGuardarSimulacion').show();

                        $('#btnGuardar').prop('disabled', false);
                        $('#btnGuardar').hide();

                        $('#btnNuevo').prop('disabled', false);
                        $('#btnNuevo').show();

                        $('#btnVolver').prop('disabled', true);
                        $('#btnVolver').hide();

                        $('#buscarA').show();
                        $('#buscarBa').hide();
                    }
                }
            });
        }

        function buscar_tercero() {
            $.ajax({
                url: '/vpedidos/BuscarClienteCedula',
                data: {
                    cliente: $('#numeroIdentificacion').val()
                },
                type: "post",
                cache: false,
                beforeSend: function() {
                    $('#modalCargandoInfo').modal();
                    $('#modal-title').html('Cargando...');
                    $('#cerrarmodalCargandoInfo').prop('disabled', true);
                    $('#cargando')
                        .html(
                            '<img  style="height:50px; width:50px;" src="/Images/engranaje-eje-paralelo-2.gif" /><br/> <h3>Cargando...<h3/>');
                    $('#cerrarmodalCargandoInfo').hide();
                },
                success: function(data) {
                    console.log(data);
                    for (let k = 0; k < data.info.length; k++) {
                        $('#tablaterceros').find('tbody').append(
                            `<tr><td align="center">${data.info[k].nombre}</td><td align="center">${
                            data.info[k].telefono}</td><td align="center">${data.info[k].correo
                            }</td><td align="center">${data.info[k].celular
                            }</td><td align="center">${data.info[k].ciudad}</td><td align="center">${data.info[k]
                            .direccion}</td></tr>`);
                    }
                },
            });
        }

        function buscarDatos() {
            $.ajax({
                url: '/vpedidos/BuscarDatos',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#tablaPaginada').find('tbody').empty();
                    for (let i = 0; i < data.length; i++) {
                        $('#tablaPaginada').find('tbody').append(
                            `<tr><td align="right">${data[i].numero}</td><td align="left">${data[i].bodega
                            }</td><td align="left">${data[i].asesor}</td><td align="left">${data[i].modelo
                            }</td><td align="right">${data[i].doc_tercero}</td><td align="left">${data[i].fecha
                            }</td><td align="left">${data[i].fuente}</td><td align="left">${data[i].subfuente
                            }</td><td align="right">${data[i].planmayor}</td><td align="left">${
                            data[i].fecha_asignacion_planmayor}</td><td align="left">${data[i].facturado
                            }</td><td align="right">${data[i].numfactura
                            }</td><td align="left">${data[i].anulado
                            }</td><td  align="center"><button class="btn btn-info btn-xs" onclick="valida('${data[i].id
                            }')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>&nbsp;&nbsp<button class="btn btn-primary btn-xs" onclick="seguimiento('${
                            data[i].id
                            }')">&nbsp;&nbsp;Seguimiento&nbsp;&nbsp;</button></td></tr>`);
                    }
                },
                complete: function(data) {
                    $('#tablaPaginada').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });
                }
            });
        }

        $('#btnGuardarPlanMayor').click(function() {
            $.ajax({
                url: '/vpedidos/validarPlanMayor',
                data: {
                    plan: $('input:radio[name=vhDseleccion]:checked').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data.permitir == true) {

                        const plan = $('input:radio[name=vhDseleccion]:checked').val();
                        if (plan != "NO TIENE") {
                            $('#planmayor').val(plan);
                            setTimeout(function() {
                                    validarRepuestos();
                                },
                                500);
                            PermisoGenerarFacturaProforma();
                        } else {
                            marcarNoDisponible();
                        }

                    } else {
                        swal("Error!",
                            `No se puede asignar este plan mayor pues ya esta asociado al pedido numero: ${data.numero
                            }`,
                            "warning");
                    }
                }
            });
        });


        function validarRepuestos() {
            const plan = $('#planmayor').val();
            if (plan != "") {
                $.ajax({
                    url: '/vpedidos/verRepuestosExhibicion',
                    data: {
                        planmayor: plan
                    },
                    type: "post",
                    cache: false,
                    success: function(data) {
                        if (data.valor != 0) {
                            $('#tablaAccesoriosExi').find('tbody').empty();
                            $('#listaretirar').val('');
                            for (let i = 0; i < data.listarepuestos.length; i++) {
                                let disabled = "";

                                if (data.listarepuestos[i].permite_retirar == 1) {


                                    disabled = "disabled";
                                };
                                $('#tablaAccesoriosExi').find('tbody').append(
                                    `<tr><td align="left"><input class="vhseleccion" type="checkbox" ${disabled
                                    } name="vhseleccion${i}" value="${data.listarepuestos[i].id
                                    }" id="vhseleccion${i}" onclick=seleccionaracce(${i})></td><td align="left">${
                                    data.listarepuestos[i].codigo}</td><td align="left">${data.listarepuestos[i].nombre
                                    }</td><td align="left"> ${data.listarepuestos[i].valor}</td><td align="left"> ${
                                    data.listarepuestos[i].cantidad}</td><td align="left"> ${data.listarepuestos[i]
                                    .descuento}</td><td align="left">${data.listarepuestos[i].iva
                                    }</td><td align="left">${data.listarepuestos[i].valorTotal}</td></tr>`);
                            }
                            $('#vhacceexhibicion').modal('show');
                        }
                    }
                });
            }
        }

        function seleccionaracce(i) {
            const campo = $(`#vhseleccion${i}`).val();
            var acceinteresados = $('#listaretirar').val();
            if (acceinteresados.indexOf(campo) >= 0) {
                const acceinteresados2 = acceinteresados.replace(campo + ",", "");
                $('#listaretirar').val(acceinteresados2);
                console.log('si');
            } else {
                acceinteresados = acceinteresados + campo + ",";
                $('#listaretirar').val(acceinteresados);
                console.log('no');
            }
        }

        $('#btnGuardarCambios').click(function() {
            const idpedido = $('#id').val();
            const planmayor = $('#planmayor').val();
            const retirar = $('#listaretirar').val();
            if (idpedido != "" && planmayor != "") {
                $.ajax({
                    url: '/vpedidos/confirmarRepuestos',
                    data: {
                        idpedido: idpedido,
                        planmayor: planmayor,
                        ordenesretiradas: retirar
                    },
                    type: "post",
                    cache: false,
                    success: function(data) {
                        if (data.valor != 0) {
                            location.reload();
                        } else {

                        }
                        $('#vhacceexhibicion').modal('hide');
                    },
                });
            }
        });

        function eliminar_plan_mayor(enCadena) {
            $.ajax({
                url: '/vpedidos/eliminarPlanMayorPedido',
                data: {
                    idPedido: $('#id').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data.exito == true) {
                        $('#planmayor').val(null);
                        $('#btnPlanMayor')
                            .html(
                                '<button type="button" class="btn btn-success btn-circle botonAccion" onclick="buscarVhDisponibles()"><i class="fa fa-search"></i></button>');
                        if (enCadena == 0) {
                            swal("Exito!", "El plan mayor fue eliminado del pedido con exito", "success");
                        }
                    } else {
                        swal("Error!", "El plan mayor no pudo ser eliminado del pedido con exito", "error");
                    }
                }
            });
        }

        $('.btnModal').click(function() {
            $.ajax({
                url: '/vpedidos/BuscarMotivosAnulacion',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#idanulacion').empty().select2();
                    $('#idanulacion').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));

                    for (let i = 0; i < data.length; i++) {
                        $('#idanulacion').append($('<option>',
                            {
                                value: data[i].id,
                                text: data[i].motivo
                            }));
                    }
                    $('#idanulacion').select2();
                }
            });
            $("#modal_anulacion").modal('show');
        });

        $('.btnAnular').click(function() {
            $("#modal_anulacion").modal('hide');
            swal({
                    title: "¿Esta Seguro?",
                    text: "No se puede recuperar el pedido después de anularlo",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Si, anular!",
                    cancelButtonText: "No, cancelar!",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },
                function (isConfirm) {
                    if (isConfirm) {
                        window.location.href =
                            `@Url.Action("Delete", "vpedidos")?id=${$('#id').val()}&&motivo=${$('#idanulacion').val()
                            }&&observacion=${$('#motivo_anulacion').val()}`;
                    } else {
                        swal("Cancelado", "El pedido no sera anulado", "error");
                    }
                });
        });

        function PermisoGenerarFacturaProforma() {
            $.ajax({
                url: '/vpedidos/PermisoGenerarFacturaProforma',
                data: {
                    idPedido: $('#id').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data == true) {
                        if ($('#planmayor').val() != '') {
                            $('#btnFacturaProforma').prop('disabled', false);
                            $('#btnFacturaProforma').show();
                        } else {
                            $('#btnFacturaProforma').prop('disabled', true);
                            $('#btnFacturaProforma').hide();
                        }
                    } else {
                        $('#btnFacturaProforma').prop('disabled', true);
                        $('#btnFacturaProforma').hide();
                    }
                },
                complete: function(data) {
                }
            });
        }

        $('#btnFacturaProforma').click(function() {
            buscarCreditoSolicitado();
        });

        function buscarCreditoSolicitado() {
            var creditoTotal = 0;
            $.ajax({
                url: '/vpedidos/buscarCreditoSolicitado',
                data: {
                    idPedido: $('#id').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    for (let i = 0; i < data.length; i++) {
                        creditoTotal += data[i].valor;
                    }
                    $('#valorCredito').val(addCommas(creditoTotal));
                },
                complete: function(data) {
                    buscarNits();
                }
            });
        }

        function buscarNits() {
            $.ajax({
                url: '/vpedidos/BuscarNitsFacturaProforma',
                data: {},
                type: "post",
                cache: false,
                success: function(data) {
                    for (let i = 0; i < data.length; i++) {
                        $('#selectNit').append($('<option>',
                            {
                                value: data[i].tercero_id,
                                text: data[i].razon_social
                            }));
                    }
                    $('#selectNit').select2();
                },
                complete: function(data) {
                    $('#modalFacturaProforma').modal('show');
                }
            });
        }

        $('#selectNit').change(function() {
            $.ajax({
                url: '/vpedidos/BuscarDatosNit',
                data: {
                    id: $('#selectNit').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#txtDireccionTercero').val(data.direc_tercero);
                    $('#txtCiudadTercero').val(data.ciu_nombre);
                }
            });
        });

        function abril_modal_creditos() {
            $.ajax({
                url: '/vpedidos/buscarCreditosmodal',
                data: {
                    cedula: $('#numeroIdentificacion').val()
                },
                type: 'post',
                cache: false,
                success: function(data) {
                    for (let i = 0; i < data.length; i++) {
                        $('#tabla_creditos').find('tbody').append(
                            `<tr><td>${data[i].estado}</td><td align="right">${addCommas(data[i].valor)
                            }</td><td align="right">${addCommas(data[i].aprobado)}</td></tr>`
                        );
                    }
                }
            });
            $('#modal_creditos').modal('show');
        }

        $('#btnGenerarPDFPedido').click(function() {
            console.log($('#id').val());
            window.open(`@Url.Action("ContratoCompraventa", "vpedidos")?id=${$('#id').val()}`, '_blank');
        });

        $('#btnGenerarFacturaProforma').click(function() {
            if ($('#selectNit').val() == '' ||
                $.trim($('#txtDireccionTercero').val()) == '' ||
                $.trim($('#txtCiudadTercero').val()) == '' ||
                $.trim($('#valorSolicitado').val()) == '') {
                $('#alertaFacturaProformaModal').show();
            } else {
                const direccion = $('#txtDireccionTercero').val();
                const res = direccion.replace(/#/gi, "|N|");

                $('#alertaFacturaProformaModal').hide();
                $('#modalFacturaProforma').modal('hide');
                const dirigido = $("#selectNit").val();

                const ciudad = $('#txtCiudadTercero').val();
                const observacion = $('#txtAreaObservacion').val();
                const res2 = observacion.replace(/#/gi, "|N|");

                const valorSolicitado = parseInt(quitCommas($('#valorSolicitado').val()));
                window.open(
                    `@Url.Action("FacturaProforma", "vpedidos")?menu=${@ViewBag.id_menu}&&info=${$('#id').val()},${null
                    },${dirigido},${res},${ciudad},${res2},${valorSolicitado}`,
                    '_blank');
            }
        });

        //$('#btnabrirCotDigital').click(function() {
        //    window.open(src="~/Content/IMAGEN DE REFERENCIA.png", '_blank');
        //})

        function validarObligatorios() {
            if ($('#codflota').val() != "") {
                //$('.vehiculo').tab('show');
                $('#flota').prop("required", true);
            }
            if ($('#marcvh_id').val() == "") {
                //$('.vehiculo').tab('show');
                $('#marcvh_id').prop("required", true);
            }
            if ($('#modelo').val() == "") {
                //$('.vehiculo').tab('show');
                $('#modelo').prop("required", true);
            }
            if ($('#id_anio_modelo').val() == "") {
                //$('.vehiculo').tab('show');
                $('#id_anio_modelo').prop("required", true);
            }
            if ($('#servicio').val() == "") {
                //$('.vehiculo').tab('show');
                $('#servicio').prop("required", true);
            }
            //if ($('#faltante').val() != "0") {
            //$('.vehiculo').tab('show');
            //$(":submit").prop("disabled", true);
            //$('#modal_agregarPago').modal('show');
            //}
            else {
                $(":submit").prop("disabled", false);
                $('#btnGuardar').click();
            }
        }

        function buscarVhDisponibles() {
            //if ($.fn.dataTable.isDataTable('#tablaVehiculosD')) {
            //    $('#tablaVehiculosD').DataTable().destroy();
            $('#tablaVehiculosD').find('tbody').empty();
            //}
            $.ajax({
                url: '/vpedidos/BuscarVhDisponible',
                data: {
                    modelo_id: $('#modelo').val(),
                    usado: $('#usado').val(),
                    anio: $('#id_anio_modelo').val(),
                },
                type: "post",
                cache: false,
                

                success: function(data) {
                    if (data != 0) {
                        debugger;
                        if (data.length > 0) {
                            for (let i = 0; i < data.length; i++) {
                                if ($('#bodega').val() == data[i].bodega_id) {
                                    $('#tablaVehiculosD').find('tbody').append(
                                        `<tr><td align="center"><input class="vhseleccion" type="radio" name="vhDseleccion" onclick="validarAverias(${
                                        data[i].plan_mayor
                                        })" value="${data[i].plan_mayor}"></td><td align="center">${data[i].plan_mayor
                                        }</td><td align="center">${data[i].modelo}</td><td align="center">${data[i]
                                            .anio_modelo
                                        }</td><td align="center">${data[i].fecha_compra}</td><td align="center">${
                                        data[i].bodega}</td><td align="center">${data[i].ubicacion
                                        }</td><td align="center">${data[i].dias
                                        }</td><td align="center">${data[i].color}</td><td align="center">${data[i].estado
                                        }</td><td align="center">${data[i].fechaevento}</td><td align="center"><button type="button" class="btn btn-info btn-xs" onclick="buscarAverias(${data[i].plan_mayor})">${data[i].cantidadAverias}</button></td></tr>`);
                                } else {
                                    $('#tablaVehiculosD').find('tbody').append(
                                        `<tr><td align="center"></td><td align="center">${data[i].plan_mayor
                                        }</td><td align="center">${data[i].modelo}</td><td align="center">${data[i]
                                            .anio_modelo
                                        }</td><td align="center">${data[i].fecha_compra}</td><td align="center">${
                                        data[i].bodega}</td><td align="center">${data[i].ubicacion}</td><td align="center">${data[i].dias}</td><td align="center">${data[i].color}</td><td align="center">${
                                        data[i].estado
                                        }</td><td align="center">${data[i].fecharecepcion}</td><td align="center"><button type="button" class="btn btn-info btn-xs" onclick="buscarAverias(${data[i].plan_mayor})">${data[i].cantidadAverias}</button></td></tr>`);
                                }
                            }
                        } else {
                            const notiene = "NO TIENE";
                            $('#tablaVehiculosD').find('tbody').append('<tr><td align="center">' +
                                '<input class="vhseleccion" type="radio" name="vhDseleccion" value="NO TIENE"></td><td  colspan="10" align="center">NO HAY VEHICULOS DISPONIBLES. MARQUE ACEPTAR PARA AGREGAR MODELO A SOLICITUD DE COMPRAS</td></tr>');
                        }

                        $('#vhdisponibles').modal("show");
                    }
                    else {
                        swal('Error','Debe especificarse un Modelo y/o Año','error')
                    }
                },
                complete: function(data) {
                    //$('#tablaVehiculosD').dataTable({
                    //    dom: "<'row'<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                    //    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                    //    buttons: [
                    //       //{ extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                    //       //{ extend: 'pdf' , className: 'btn-sm', text: 'PDF' },
                    //       //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                    //    ]
                    //});
                }
            });
        }

        function buscarAverias(planmayor) {
            $('#modalAverias').modal('show');
            $.ajax({
                url: '/Vehiculo/buscarAveriasInsp',
                data: { planmayor },
                type: 'post',
                cache: false,
                success: function(data) {
                    console.log(data);
                    debugger;
                    
                        $('#tabla_averias').find('tbody').empty();
                        for (var i = 0; i < data.length; i++) {
                            $('#tabla_averias').find('tbody').append(
                                '<tr>'
                                + '<td align="right">' + data[i].planmayor + '</td>'
                                + '<td align="right">' + data[i].fecha + '</td>'
                                + '<td align="left">' + data[i].observacion + '</td>'
                                + '<td align="left">' + data[i].estadoA + '</td>'
                                + '</tr>'
                            );
                        }
                    

                }
            });
        }
        //====================================== FIN VALIDACION BOTONES =======================================

        //========================================= VALIDACION FLOTAS =========================================
        $('#codflota').change(function() {
            $.ajax({
                url: '/vpedidos/BuscarFlota',
                data: {
                    flota: $('#codflota').val(),
                },
                type: "post",
                cache: false,
                success: function(data) {
                    //console.log(data)
                    //$('#nitFlota').text(data[0].nit_flota + ' - ' + data[0].nombre);

                    $('#flota').empty().select2();
                    $('#flota').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));

                    for (let i = 0; i < data.length; i++) {
                        $('#flota').append($('<option>',
                            {
                                value: data[i].id,
                                text: data[i].nombre
                            }));
                    }
                    $('#flota').select2();
                }
            });
        });

        $("#flota").change(function() {
            buscarDocumentos();
        });
        //======================================= FIN VALIDACION FLOTAS ========================================

        //==================================== VALIDACION DATOS PEDIDO ====================================
        //---------------------------- VALIDACION PLAN MAYOR Y DATOS ASOCIADOS ----------------------------
        function modificarPlanMayor() {
            $.ajax({
                url: '/vpedidos/PermisoPlanMayor',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data == 1) {
                        $('#planmayor').prop('readonly', true);
                        $('#btnPlanMayor').prop('disabled', false);
                        $('#btnPlanMayor').show();
                        $('#btnEliminarPlanMayor').show();
                        //console.log("tiene permiso");
                    } else {
                        $('#planmayor').prop('readonly', true);
                        $('#btnPlanMayor').prop('disabled', true);
                        $('#btnPlanMayor').hide();
                        //console.log("NO tiene permiso");
                    }
                },
                complete: function(data) {
                }
            });
        }

        function marcarNoDisponible() {
            const id = $('#id').val();
            $.ajax({
                url: '/vpedidos/MarcarNoDisponible',
                data: {
                    id: id
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data.valor != 0) {
                        swal("Atención",
                            "Se ha marcado el vehículo solicitado como NO disponible, para su inclusión en el próximo pedido de Compra.",
                            "success");
                        setTimeout(function() {
                                location.reload();
                            },
                            2000);
                    } else {
                        swal("Atención", data.respuesta, "error");
                    }
                },
            });
        }

        function marcarFacturar() {
            const id = $('#id').val();
            $.ajax({
                url: '/vpedidos/MarcarFacturar',
                data: {
                    id: id
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data.valor != 0) {
                        swal("Atención", "Se ha marcado el vehículo solicitado para facturar exitosamente.", "success");
                        setTimeout(function() {
                                window.location.href = window.location.href;
                            },
                            2000);
                    } else {
                        swal("Atención", data.respuesta, "error");
                    }
                },
            });
        }


        $('#btnConfirmarFacturar').click(function() {
            marcarFacturar();
        });

        function estadoPedido() {
            $.ajax({
                url: '/vpedidos/validarEstadoPedido',
                data: {
                    pedidoid: $('#id').val(),
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data == 1) {
                        $('.btnAnular').hide();
                        $('.ocultable').hide();
                        $('#valor_unitario').prop('readonly', true);
                        $('#pordscto').prop('readonly', true);
                        //$('#porcentaje_iva').prop('readonly', true);
                        $('#porcentaje_impoconsumo').prop('readonly', true);
                        $('#btnAgregar').prop('readonly', true);
                        $('#btnAgregar').hide();
                        $('#txtValor1').prop('readonly', true);
                        $('#txtFecpago1').prop('readonly', true);
                        $('#txtObservacion1').prop('readonly', true);
                        $('#slcBanco1').prop('readonly', true);
                        $('#slcCondicion1').prop("readonly", true);
                        $('#anulado').bootstrapToggle('on');
                        $('#anulado').prop("readonly", true);
                        //console.log("esta anulado");
                    } else {
                        $('.btnAnular').show();
                        $('#verPedido').show();
                        $('.ocultable').show();
                        $('#anulado').bootstrapToggle('off');
                        $('#anulado').attr("readonly", "readonly");
                        $('#facturado').attr("readonly", "readonly");

                        //console.log("sigue vigente");
                    }
                },
                complete: function(data) {
                }
            });
        }

        function validarPlanMayor() {
            if ($('#planmayor').val() == "") {
                $('#marcvh_id').prop('readonly', false);
                $('#modelo').prop('readonly', false);
                $('#id_anio_modelo').prop('readonly', false);
            } else {
                $('#modelo option:not(:selected)').prop('disabled', true);
                $('#id_anio_modelo option:not(:selected)').prop('disabled', true);
                $('#marcvh_id option:not(:selected)').prop('disabled', true);;
            }
        }

        $('#marcvh_id').change(function() {
            var esNuevo = true;
            if (!$('#nuevo').is(':checked')) {
                esNuevo = false;
            }
            $.ajax({
                url: '/cotizacion/BuscarModelosPorMarca',
                data: {
                    idMarca: $('#marcvh_id').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function(data) {
                    //$('#modelo').empty().select2();
                    //$('#id_anio_modelo').empty().select2();
                    //$('#colVh_id').empty().select2();

                    $('#modelo').empty();
                    $('#id_anio_modelo').empty();
                    $('#colVh_id').empty();
                    //$('#Color_Deseado').empty().select2();
                    //$('#color_opcional').empty().select2();

                    $('#modelo').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#modelo').append($('<option>',
                            {
                                value: data[i].modvh_codigo,
                                text: data[i].modvh_nombre
                            }));
                    }
                    //$('#modelo').select2();
                    //$('#id_anio_modelo').select2();
                }
            });
        });

        $('#modelo').change(function () {
            debugger;
            $('#descripcion').val('');
            $('#valor').val('');
            var esNuevo = true;
            if (!$('#nuevo').is(':checked')) {
                esNuevo = false;
            }
            $.ajax({
                url: '/cotizacion/BuscarAniosModelos',
                data: {
                    codigoModelo: $('#modelo').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function (data) {            

                    $('#id_anio_modelo').empty();
                    $('#id_anio_modelo').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#id_anio_modelo').append($('<option>',
                            {
                                value: data[i].anios,
                                text: data[i].anios
                            }));
                    }
                    //$('#id_anio_modelo').select2();
                }
            });
        });

        //--------------------validacion por si decide cambiar el vehiculo del pedido----------------------
        function PermisoModificarVH() {
            $.ajax({
                url: '/vpedidos/PermisoModificarVH',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data == 1) {
                        $('#btnCambioVH').prop('disabled', false);
                        $('#btnCambioVH').show();
                        //console.log("tiene permiso");
                    } else {
                        $('#btnCambioVH').prop('disabled', true);
                        $('#btnCambioVH').hide();
                        //console.log("NO tiene permiso");
                    }
                },
                complete: function(data) {
                }
            });
        }

        $('#btnCambioVH').click(function() {
            swal({
                    title: "¿Esta Seguro?",
                    text: "Si modifica el modelo toda la información del pedido sera eliminada",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Modificar",
                    cancelButtonText: "Cancelar",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },
                function(isConfirm) {
                    if (isConfirm) {
                        $('#modificarVehiculoPedido').show();
                        //$('#VehiculoPedidoInicial').hide();
                        swal("Finalizado", "Se ha finalizado el proceso", "success");
                        limpiar_valores();
                    } else {
                        swal("Cancelado", "El vehiculo no sera modificado", "error");
                    }
                });
        });

        function limpiar_valores(formulario) {
            //se limpian todos los select
            $(`.${formulario}_select`).each(function(index) {
                $(this).select2("val", "");
            });

            //se limpian todos los inputs
            $(`.${formulario}_input`).each(function(index) {
                $(this).val("");
            });

            //se limpian todos los otros campos
            $(`.${formulario}_other`).each(function(index) {
                $(this).html("");
            });
        }

        $('#marcas').change(function() {
            $('#modelosMarca').val('').select2();
            $('#idAnioModelo').val('').select2();
            var esNuevo = true;
            if (!$('#nuevo').val() == true) {
                esNuevo = false;
            }
            $.ajax({
                url: '/cotizacion/BuscarModelosPorMarca',
                data: {
                    idMarca: $('#marcas').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function(data) {
                    //$('#modelo').empty().select2();
                    //$('#id_anio_modelo').empty().select2();
                    //$('#colVh_id').empty().select2();

                    $('#modelosMarca').empty();
                    $('#idAnioModelo').empty();

                    $('#colVh_id').empty();
                    //$('#Color_Deseado').empty().select2();
                    //$('#color_opcional').empty().select2();

                    $('#modelosMarca').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#modelosMarca').append($('<option>',
                            {
                                value: data[i].modvh_codigo,
                                text: data[i].modvh_nombre
                            }));
                    }
                    //$('#modelo').select2();
                    //$('#id_anio_modelo').select2();
                }
            });
            validarCambioVehiculo();
        });

        $('#modelosMarca').change(function () {
            debugger;
            $('#descripcion').val('');
            $('#valor').val('');
            var esNuevo = true;
            if (!$('#nuevo').val() == true) {
                esNuevo = false;
            }
            $.ajax({
                url: '/vpedidos/BuscarAniosModelos',
                data: {
                    codigoModelo: $('#modelosMarca').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function (data) {
                    debugger;
                    console.log(data);
                    $('#idAnioModelo').empty();
                    $('#idAnioModelo').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#idAnioModelo').append($('<option>',
                            {
                                value: data[i].value,
                                text: data[i].text
                            }));
                    }
                    $('#idAnioModelo').val('').select2();
                }
            });
            validarCambioVehiculo();
        });

        $('#idAnioModelo').change(function() {
            $.ajax({
                url: '/vpedidos/BuscarPrecioXAniosModelos',
                data: {
                    anioModelo: $('#idAnioModelo').val(),
                },
                type: "post",
                cache: false,
                success: function(data) {
                    console.log(data);
                    $('#valor_unitario').val(data);

                    //$('#valor_unitario').val(data).trigger('change');
                    $('#valor_unitario').attr('value', data);
                    $('#valor_unitario').val(data);

                    if (data == 0) {
                        $('#valor_unitario').prop('readonly', false);
                    }
                },
                complete: function(data) {
                    calcularValores();
                }
            });
            validarCambioVehiculo();
        });

        function validarCambioVehiculo() {
            if ($('#marcvh_id').val() != $('#marcas').val() ||
                $('#modelo').val() != $('#modelosMarca').val() ||
                $('#id_anio_modelo').val() != $('#idAnioModelo').val()) {
                $('#motivoDeCambio').show();
                $('#marcas').prop('required', true);
                $('#modelosMarca').prop('required', true);
                $('#idAnioModelo').prop('required', true);
                $('#motivoCambio').prop('required', true);
                $('#esCambio').val(1);
                if ($('#marcas').val() != "" && $('#modelosMarca').val() != "" && $('#idAnioModelo').val() != null) {
                    //  agregarPago();
                }
            } else {
                $('#marcas').prop('required', false);
                $('#modelosMarca').prop('required', false);
                $('#idAnioModelo').prop('required', false);
                $('#motivoCambio').prop('required', false);
                $('#motivoDeCambio').hide();
                $('#esCambio').val(0);
            }
        }

        //--------------------validacion por si decide cambiar el vehiculo del pedido----------------------
        function validarAverias(plan_mayor) {
            $.ajax({
                url: '/vpedidos/ValidarAverias',
                data: {
                    plan_mayor: plan_mayor,
                },
                type: "post",
                cache: false,
                success: function(data) {
                    //console.log(data)

                    if (data.result == 1) {
                        $('input:radio[name=vhDseleccion]:checked').remove();
                        swal({
                                title: data.evento_observacion,
                                text:
                                    "El vehículo seleccionado tiene averias, se debe enviar una notificación a la persona encargada para que de autorización. ¿Desea enviar la notificación?",
                                type: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#DD6B55",
                                confirmButtonText: "Si, enviar!",
                                cancelButtonText: "No, cancelar!",
                                closeOnConfirm: false,
                                closeOnCancel: false
                            },
                            function(isConfirm) {
                                if (isConfirm) {

                                    $.ajax({
                                        url: '/vpedidos/EnviarNotificacionAverias',
                                        data: {
                                            plan_mayor: plan_mayor,
                                        },
                                        type: "post",
                                        cache: false,
                                        success: function(data) {

                                            if (data == -1) {
                                                swal("", "Error al enviar la notificación", "error");
                                            }
                                            if (data == 0) {
                                                swal("",
                                                    "No existen usuarios parametrizados para enviar una notificación",
                                                    "warning");
                                            }
                                            if (data == 1) {
                                                swal("", "Notificación enviada correctamente", "success");
                                            }
                                            if (data == 2) {
                                                swal("",
                                                    "Ya se envio una notificación anteriormente del vehículo seleccionado",
                                                    "warning");
                                            }
                                        }
                                    });

                                } else {
                                    swal("Cancelado", "", "error");
                                }
                            });
                    }
                }
            });
        };
        //------------------------- FIN VALIDACION PLAN MAYOR Y DATOS ASOCIADOS ---------------------------

        //----------------------------------------- VALIDACION PLACA --------------------------------------
        $('#rango_placa').change(function() {
            if ($('#rango_placa').val() != "") {
                $('#placapar').bootstrapToggle('off');
                $('#placapar').prop('disabled', true);
                $('#placaimpar').bootstrapToggle('off');
                $('#placaimpar').prop('disabled', true);
            } else {
                if ($('#rango_placa').val() == "") {
                    $('#placapar').prop('disabled', false);
                    $('#placaimpar').prop('disabled', false);
                }
            }
        });

        $('#placapar').change(function() {
            if ($('#placapar').prop('checked')) {
                $('#placaimpar').bootstrapToggle('off');
                $('#rango_placa').prop('disabled', true);
            }
            if (!$('#placapar').prop('checked') && !$('#placaimpar').prop('checked')) {
                $('#rango_placa').prop('disabled', false);
            }
        });

        $('#placaimpar').change(function() {
            if ($('#placaimpar').prop('checked')) {
                $('#placapar').bootstrapToggle('off');
                $('#rango_placa').prop('disabled', true);
            }
            if (!$('#placapar').prop('checked') && !$('#placaimpar').prop('checked')) {
                $('#rango_placa').prop('disabled', false);
            }
        });
        //------------------------------------- FIN VALIDACION PLACA --------------------------------------

        //-------------------------------- FIN VALIDACION CARGO MATRICULA ---------------------------------
        $('#cargomatricula').change(function() {
            if ($('#cargomatricula').val() == 1) {
                $('#divValorMatricula').show();
                $('#divPorcObsequio').hide();
                $('#valormatricula').val($('#matriculaOculto').val());
                $('#obsequioporcen').val(0);
            }

            if ($('#cargomatricula').val() == 2) {
                $('#divValorMatricula').show();
                $('#divPorcObsequio').show();
                $('#valormatricula').val(0);
            }

            if ($('#cargomatricula').val() == 3) {
                $('#divValorMatricula').hide();
                $('#divPorcObsequio').hide();
                $('#valormatricula').val(0);
            }
        });
        //-------------------------------- FIN VALIDACION CARGO MATRICULA ---------------------------------

        //---------------------------------- VALIDACION CAMPOS MONETARIOS ---------------------------------
        function modificarValores() {
            $.ajax({
                url: '/vpedidos/PermisoModificarValores',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data == 1) {
                        $('#valor_unitario').prop('readonly', false);
                        $('#pordscto').prop('readonly', false);
                        //$('#porcentaje_iva').prop('readonly', false);
                        $('#porcentaje_impoconsumo').prop('readonly', false);
                        //btnAgregar

                    } else {
                        $('#valor_unitario').prop('readonly', true);
                        //$('#pordscto').prop('readonly', true);
                        //$('#porcentaje_iva').prop('readonly', true);
                        $('#porcentaje_impoconsumo').prop('readonly', true);
                        //$('#btnAgregar').prop('disabled', true);
                        //$('#btnAgregar').hide();
                        //$('#txtValor1').prop('disabled', true);
                        //$('#txtFecpago1').prop('disabled', true);
                        //$('#txtObservacion1').prop('disabled', true);
                        //$('#slcBanco1').prop('disabled', true);
                        //$('#slcCondicion1').prop("disabled", true);
                    }
                },
                complete: function(data) {
                }
            });
        }

        $('#valor_unitario').change(function() {
            calcularValores();
            //agregarPago();

            //var valor_descuento = (parseInt(quitCommas($('#valor_unitario').val())) * $('#pordscto').val()) /100;
            //var vu = parseInt(quitCommas($('#valor_unitario').val())) - valor_descuento;
            ////console.log("el valor_descuento final es igual a " +addCommas(vu) + " sobre este valor calcule el iva el impo consumo y el total... suerte")

            //if (valor_descuento == 0) {
            //    var valor_descuento =  Math.round((parseInt(quitCommas($('#valor_unitario').val())) * $('#pordscto').val()) /100);
            //    $('#vrdescuento').val(addCommas(parseInt(valor_descuento)));
            //}

            //if (valor_descuento > 0) {
            //    $('#vrdescuento').val(addCommas(parseInt(valor_descuento)));

            //    var valor_Impuesto =  Math.round(vu * $('#porcentaje_impoconsumo').val() /100);
            //    $('#valor_impuesto').val(addCommas(valor_Impuesto));
            //    //console.log("el valor_Impuesto final es igual a " +addCommas(valor_Impuesto))

            //    var valor_IVA =  Math.round(vu  * $('#porcentaje_iva').val() /100);
            //    $('#valor_iva').val(addCommas(valor_IVA));
            //    //console.log("el valor_IVA final es igual a " +addCommas(valor_IVA))

            //}else{
            //    var valor_porcentaje = Math.round((parseInt(quitCommas($('#valor_unitario').val())) * $('#porcentaje_impoconsumo').val()) /100);
            //    var valor_porcentajeIVA = Math.round((parseInt(quitCommas($('#valor_unitario').val())) * $('#porcentaje_iva').val()) /100);
            //    var valor_porcentajeDTO = Math.round((parseInt(quitCommas($('#valor_unitario').val())) * $('#pordscto').val()) /100);
            //    $('#valor_impuesto').val(addCommas(valor_porcentaje));
            //    $('#valor_iva').val(addCommas(valor_porcentajeIVA));
            //    $('#vrdescuento').val(addCommas(valor_porcentajeDTO));
            //}
            //ValorTotalCotizacion();
            //setTimeout(function(){
            //    agregarPago();
            //}, 1000);
        });

        $('#pordscto').change(function() {
            calcularValores();
            //let max= parseInt(this.max);
            //let valor = parseInt(this.value);
            //if(valor>max){
            //    $("#modal_porcentajes").modal('show');
            //    this.value = max;
            //    calcularDescuento();
            //}else{
            //    calcularDescuento();
            //}
        });

        function calcularDescuento() {
            var valor_descuento = (parseFloat(quitCommas($('#valor_unitario').val())) * $('#pordscto').val()) / 100;
            const vu = parseFloat(quitCommas($('#valor_unitario').val())) - valor_descuento;
            //console.log("el valor_descuento final es igual a " +addCommas(vu) + " sobre este valor calcule el iva el impo consumo y el total... suerte")

            if (valor_descuento == 0) {
                var valor_descuento = (parseFloat(quitCommas($('#valor_unitario').val())) * $('#pordscto').val() / 100);
                $('#vrdescuento').val(addCommas(parseFloat(valor_descuento)));
            }

            if (valor_descuento > 0) {
                $('#vrdescuento').val(addCommas(parseFloat(valor_descuento)));

                var valor_Impuesto = vu * $('#porcentaje_impoconsumo').val() / 100;
                $('#valor_impuesto').val(addCommas(valor_Impuesto));
                //console.log("el valor_Impuesto final es igual a " +addCommas(valor_Impuesto))

                var valor_IVA = vu * $('#porcentaje_iva').val() / 100;
                $('#valor_iva').val(addCommas(valor_IVA));
                //console.log("el valor_IVA final es igual a " +addCommas(valor_IVA))

            } else {
                var valor_Impuesto = (parseFloat(quitCommas($('#valor_unitario').val()))) *
                    $('#porcentaje_impoconsumo').val() /
                    100;
                $('#valor_impuesto').val(addCommas(valor_Impuesto));
                //console.log("el valor_Impuesto final es igual a " +addCommas(valor_Impuesto))

                var valor_IVA = (parseFloat(quitCommas($('#valor_unitario').val()))) * $('#porcentaje_iva').val() / 100;
                $('#valor_iva').val(addCommas(valor_IVA));
                //console.log("el valor_IVA final es igual a " +addCommas(valor_IVA))
                parseFloat(quitCommas($('#valor_unitario').val()));
            }

            ValorTotalCotizacion();
            agregarPago();
        }

        $('#porcentaje_impoconsumo').change(function() {
            calcularValores();
            //let max= parseInt(this.max);
            //let valor = parseInt(this.value);
            //if(valor>max){
            //    $("#modal_porcentajes").modal('show');
            //    this.value = max;
            //    calcularImpuesto();
            //}else{
            //    calcularImpuesto();
            //}
        });

        function calcularImpuesto() {
            debugger;
            const valordescuento = (parseFloat(quitCommas($('#vrdescuento').val()))) || 0;
            const valor_porcentaje = ((parseFloat(quitCommas($('#valor_unitario').val())) - valordescuento) *
                    $('#porcentaje_impoconsumo').val()) /
                100;
            valor_porcentaje.toFixed(2);
            $('#valor_impuesto').val(addCommas(valor_porcentaje));

            ValorTotalCotizacion();
            agregarPago();
        }

        $('#porcentaje_iva').change(function() {
            calcularValores();
            //let max= parseInt(this.max);
            //let valor = parseInt(this.value);
            //if(valor>max){
            //    $("#modal_porcentajes").modal('show');
            //    this.value = max;
            //    calcularIVA();
            //}else{
            //    calcularIVA();
            //}
        });

        function calcularIVA() {
            const valordescuento = (parseFloat(quitCommas($('#vrdescuento').val()))) || 0;
            const valor_porcentaje = ((parseFloat(quitCommas($('#valor_unitario').val())) - valordescuento) *
                    $('#porcentaje_iva').val()) /
                100;
            $('#valor_iva').val(addCommas(valor_porcentaje));

            ValorTotalCotizacion();
            agregarPago();
        }

        $('.suma').change(function() {
            //ValorTotalCotizacion();
            console.log(`El valor a cambiado a:${$('#valor_unitario').val()}`);
            calcularValores();
        });

        $('.resta').change(function() {
            calcularValores();
            //ValorTotalCotizacion();
        });

        //function ValorTotalCotizacion(){
        //    debugger;
        //    var valorUnitario = (parseFloat(quitCommas($('#valor_unitario').val())));
        //    var valorDescuento = (parseFloat(quitCommas($('#vrdescuento').val())))||0;
        //    var valorIVA = (parseFloat(quitCommas($('#valor_iva').val())));
        //    var valorImpuesto = (parseFloat(quitCommas($('#valor_impuesto').val())));
        //    var valorTotal = parseFloat(parseFloat(valorUnitario - valorDescuento) + parseFloat(valorIVA) + parseFloat(valorImpuesto));
        //    valorTotal.toFixed(2);
        //    $('#vrtotal').val(addComas((valorTotal)));

        //}

        function calcularValores() {
            $.ajax({
                url: '/vpedidos/calcularValores',
                data: {
                    valor_poliza: $('#valorPoliza').val(),
                    soat: $('#valorsoat').val(),
                    valor_carroceria: $('#vrcarroceria').val(),
                    valor_unitario: $('#valor_unitario').val(),
                    por_descuento: $('#pordscto').val(),
                    porcentaje_iva: $('#porcentaje_iva').val(),
                    por_imp_consumo: $('#porcentaje_impoconsumo').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    console.log(data);
                    $('#valor_unitario').val(data[0]);
                    $('#valorPoliza').val(data[1]);
                    $('#valorsoat').val(data[2]);
                    $('#vrcarroceria').val(data[3]);
                    $('#vrdescuento').val(data[4]);
                    $('#valor_iva').val(data[5]);
                    $('#valor_impuesto').val(data[6]);
                    $('#vrtotal').val(data[7]);
                },
                complete: function(data) {
                    agregarPago();
                }
            });
        }

        $('#valorPoliza').change(function() {
            calcularValores();
        });

        $('#valorsoat').change(function() {
            calcularValores();
        });

        $('#vrcarroceria').change(function() {
            calcularValores();
        });

        $('#valormatricula').change(function() {
            agregarPago();
        });

        var numero_miles = "";

        function formatNumber(n) {
            const array_number = n.split(',');
            var complemento = "";
            n = String(array_number[0]).replace(/\D/g, "");
            if (array_number.length > 1) {
                complemento = `,${array_number[1]}`;
            }

            return n === '' ? n : String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ".") + complemento;
        }

        function miles(id) {
            numero_miles = formatNumber($(`#${id}`).val());
            $(`#${id}`).val(numero_miles);
        }

        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? `,${x[1]}` : '';
            const rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + '.' + '$2');
            }
            return x1 + x2;
        }

        function quitCommas(nStr) {
            nStr.toString();
            //console.log(nStr);
            var s = nStr.replace(/\./g, "");
            s = s.replace(/\,/g, ".");
            return s;
        }
        //--------------------------------- FIN VALIDACION CAMPOS MONETARIOS --------------------------------

        //---------------------------------- VALIDACION DATA TOGGLE VARIOS ----------------------------------
        $('#escanje').change(function() {
            if ($('#escanje').prop('checked')) {
                $('#eschevyplan').bootstrapToggle('off');
                $('#esreposicion').bootstrapToggle('off');
                $('#esLeasing').bootstrapToggle('off');
            }
        });

        $('#eschevyplan').change(function() {
            if ($('#eschevyplan').prop('checked')) {
                $('#escanje').bootstrapToggle('off');
                $('#esreposicion').bootstrapToggle('off');
                $('#esLeasing').bootstrapToggle('off');
            }
        });

        $('#esreposicion').change(function() {
            if ($('#esreposicion').prop('checked')) {
                $('#escanje').bootstrapToggle('off');
                $('#eschevyplan').bootstrapToggle('off');
                $('#esLeasing').bootstrapToggle('off');
            }
        });

        $('#esLeasing').change(function() {
            if ($('#esLeasing').prop('checked')) {
                $('#escanje').bootstrapToggle('off');
                $('#eschevyplan').bootstrapToggle('off');
                $('#esreposicion').bootstrapToggle('off');
            }
        });
        //-------------------------------- FIN VALIDACION DATA TOGGLE VARIOS ---------------------------------

        //==================================== FIN VALIDACION DATOS PEDIDO ===================================

        //==================================== VALIDACION FORMAS DE PAGO =====================================
        var precioRPT = 0;
        var costosAdd = 0;

        function contarRepuestos() {
            const rowCount = $('#tablaAccesorios tbody tr').length;
            precioRPT = 0;
            if (rowCount > 0) {
                for (let i = 0; i <= cantidadRepuestos; i++) {
                    if ($(`#totalRespuesto${i}`).val() != undefined) {
                        precioRPT += parseInt(quitCommas($(`#totalRespuesto${i}`).val()));
                    }
                }
            }
        }

        function contarCostosAdd() {
            const rowCount = $('#tablaCostosA tbody tr').length;
            costosAdd = 0;
            if (rowCount > 0) {
                for (let i = 0; i <= cantidadCostos; i++) {
                    if ($(`#valor_costo${i}`).val() != undefined) {
                        const valorx = $(`#valor_costo${i}`).val();
                        costosAdd += parseInt(quitCommas($(`#valor_costo${i}`).val()));
                    }
                }
            }
        }

        function traer_formas_pago() {
        }

        function agregarPago() {
            //calcular valor total de la deuda
            //

            var poliza = 0;
            var soat = 0;
            var carroceria = 0;
            var obsequio = 0;
            var iva = 0;
            var ValorConIva = 0;
            var ValorImpConsumo = 0;

            if ($('#valorPoliza').val() != "") {
                poliza = parseFloat(quitCommas($('#valorPoliza').val()));
            }
            if ($('#valorsoat').val() != "") {
                soat = parseFloat(quitCommas($('#valorsoat').val()));
            }
            if ($('#vrcarroceria').val() != "") {
                carroceria = parseFloat(quitCommas($('#vrcarroceria').val()));
            }
            if ($('#valormatricula').val() != "") {
                matricula = parseFloat(quitCommas($('#valormatricula').val()));
            }
            if ($('#obsequioporcen').val() != "" && $('#valormatricula').val() != "") {
                obsequio = parseFloat(quitCommas($('#valormatricula').val())) -
                    ((parseInt($('#obsequioporcen').val()) * parseInt(quitCommas($('#valormatricula').val()))) / 100);
            }

            iva = parseFloat(quitCommas($('#valor_unitario').val()) * $('#porcentaje_iva').val() / 100);
            ValorConIva = parseFloat(quitCommas($('#valor_unitario').val())) + iva;
            ValorImpConsumo = parseFloat(quitCommas($('#porcentaje_impoconsumo').val())) *
                parseFloat(quitCommas($('#valor_unitario').val())) /
                100;

            contarRepuestos();
            contarCostosAdd();
            if (obsequio == 0) {
                var sumaValoresTotal = ValorConIva +
                    poliza +
                    soat +
                    carroceria +
                    matricula +
                    obsequio +
                    precioRPT +
                    costosAdd +
                    ValorImpConsumo;
            } else {
                var sumaValoresTotal = ValorConIva +
                    poliza +
                    soat +
                    carroceria +
                    obsequio +
                    precioRPT +
                    costosAdd +
                    ValorImpConsumo;
            }
            var valorFaltante = 0;
            debugger;
            valorFaltante = sumaValoresTotal.toFixed(2) - valorFaltante3.toFixed(2);
            valorFaltante = valorFaltante.toFixed(2);

            var btnEliminar = `<button class="btn btn-danger btn-circle botonAccion" id="${i
                }" type="button" onclick="eliminarPago(this.id)"><i class="fa fa-remove"></i></button>`;
            //console.log("El valor faltante al cargar el pedido es de: "+valorFaltante);

            i++;

            var option = '';
            var optionBanco = '';
            //console.log("El contador es igual a:"+i);
            var btnAgregar =
                '<div class="panel-body-btns text-right"><button id="btnAgregar" class="btn btn-success botonAccion" type="button" onclick="agregarPago()"><i class="fa fa-plus"></i> Agregar</button></div>';

            if (i > 1) {
                var x = i - 1;
                var cifrastring = $(`#txtValor${x}`).val();
                var formapagostring = $(`#txtValor${x}`).val();
                var cifra = parseFloat(quitCommas($(`#txtValor${x}`).val())) || 0;
                //console.log("Cuando entra en el primer if el valor total es igal a: "+valor_total);
                var formadepago = parseInt($(`#slcCondicion${x}`).val()) || 0;

                var parametro = $('#parametros').val();
                var bancoObligatorio = parametro.split(',');

                var esObligatorio = false;

                for (var a = 0; a < bancoObligatorio.length; a++) {
                    if (formadepago == bancoObligatorio[a]) {
                        esObligatorio = true;
                        break;
                    } else {
                        esObligatorio = false;
                        break;
                    }
                }

                //console.log("la forma de pago es igal a: "+formadepago);
                //////////////////valorFaltante = parseInt(quitCommas($('#vrtotal').val())) - valor_total ;
                //console.log("El valor faltante es igal a: "+valorFaltante);
                if (cifra == 0 || formadepago == 0 || (esObligatorio == true && $(`#slcBanco${x}`).val() == "")) {
                    i--;
                    valorFaltante;
                    if (esObligatorio == true && $(`#slcBanco${x}`).val() == "") {
                        $('#modalErrorObligatorios').modal('show');
                    }
                    //console.log("estan vacios");
                } else {
                    //console.log(addCommas("El valor que ud esta cancelando es de: "+cifra));
                    valor_total2 += parseFloat(quitCommas(($(`#txtValor${x}`).val())));
                    var valortotalform = sumaValoresTotal;
                    //var valortotalform = valorFaltante;
                    var valorpequenio = valortotalform - valor_total2;
                    //console.log(valorFaltante2);
                    //console.log("Lo que pago es: "+valor_total2+" Lo que quedo debiendo es: "+valorFaltante2);
                    console.log('por aqui');
                    if (valorpequenio < 0) {
                                            console.log('valor faltante menor que cero');

                        i--;
                        //valorFaltante2 = valorFaltante2 + cifra;
                        valorFaltante = valorFaltante2.toFixed(2);
                        $('.confirm').removeAttr("disabled");
                        swal("¡Error! Por favor valide.", "El valor a pagar sobrepasa el valor faltante.", "error");
                        //valor_total2 =valor_total;
                        //valorFaltante=valor_total2;
                        //console.log("Pago mas de la deuda, el pago no se acepta");
                    } else {
                        console.log('valor faltante mayor que cero');
                        debugger;
                        var valoranadir= parseFloat(quitCommas($(`#txtValor${x}`).val()));
                        valor_total += valoranadir;
                        valorFaltante3 += valoranadir;
                        var valortotalform2 = parseFloat(valorFaltante).toFixed(2);
                        valorFaltante = (valortotalform2 - valoranadir).toFixed(2);
                        valorFaltante2 = parseFloat(valorFaltante);
                        if (/*valorFaltante == 0 &&*/ $('#vrtotal').val != "") {
                            $('#btnGuardarSimulacion').show();
                            $('#btnGuardarSimulacion').removeAttr("disabled");
                            /////$(":submit").removeAttr("disabled");
                        } else {
                            $('#btnGuardar').hide();
                            $('#btnGuardarSimulacion').hide();
                            $(":submit").prop("disabled", true);
                        }
                        $('#lista_pagos').val(x);
                        var idbanco = $(`#slcBanco${x}`).val();
                        var nombrebanco = "";
                        if (idbanco != "") {
                            nombrebanco = $(`#slcBanco${x} option:selected`).text();
                        }
                        $('#tablaPagos').append(
                            `<tr id="item${x}"><td align="center"><input type="hidden" name="condicion${x
                            }" id="condicion${x}" value="${$(`#slcCondicion${x}`).val()}"/>${$(
                                `#slcCondicion${x} option:selected`).text()
                            }</td><td align="center"><input type="hidden" name="valor${x}" id="valor${x}" value="${
                            $(`#txtValor${x}`).val()}"/>$ ${$(`#txtValor${x}`).val()
                            }</td><td align="center"><input type="hidden" value="${$(`#txtFecpago${x}`).val()
                            }" name="fecpago${x}" id="fecpago${x}" />${$(`#txtFecpago${x}`).val()
                            }</td><td align="center"><input type="hidden" value="${idbanco}" name="banco${x
                            }" id="banco${x}" />${nombrebanco
                            }</td><td align="center"><input type="hidden" value="${$(`#txtObservacion${x}`).val()
                            }" name="observaciones${x}" id="observaciones${x}" />${$(`#txtObservacion${x}`).val()
                            }</td><td align="center">${btnEliminar}</td></tr>`);
                    }
                }
            }

            $.ajax({
                url: '/vpedidos/BuscarPagos',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    console.log(data);
                    option += '<option value=""></option>';
                    for (let j = 0; j < data.pagos.length; j++) {
                        option += `<option value="${data.pagos[j].id}">${data.pagos[j].descripcion}</option>`;
                    }

                    optionBanco += '<option value="">Seleccione</option>';
                    for (let k = 0; k < data.bancos.length; k++) {
                        optionBanco += `<option value="${data.bancos[k].id}">${data.bancos[k].financiera_nombre
                            }</option>`;
                    }

                    $('#pagos').html(
                        `<div class="row"><div class="form-group col-lg-6"><label>Forma de pago </label><input type="hidden" class="form-control" id="parametros" value="${
                        data.parametro}"/><select class="multiselect-ui form-control input-sm" id="slcCondicion${i}" >${
                        option
                        }</select></div><div class="form-group col-lg-6"><label>Valor $</label><input class="form-control input-sm number" id="txtValor${
                        i
                        }" onkeyUp = "return miles(this.id)"/></div><div class="form-group col-lg-6"><label>Fecha a Pagar </label><input class="form-control input-sm fecha_formapago" id="txtFecpago${
                        i}"  value=""/></div><div class="form-group col-lg-6"><label>Banco </label><select  class="multiselect-ui form-control input-sm" id="slcBanco${
                        i}">${optionBanco
                        }</select></div><div class="form-group col-lg-6"><label>Observaciones </label><textarea class="form-control input-sm" style="widht: 280px; heigth: 100px" id="txtObservacion${
                        i}"/></div>@*<div class="col-sm-offset-10 col-md-offset-10 col-lg-offset-10"><button type="button" class="btn btn-primary form-group-sm" onclick="abril_modal_creditos()" title="Ver Créditos Tercero"><i class="fa fa-credit-card"></i></button></div>*@<div class="form-group col-lg-1 btn">${
                        btnAgregar}</div></div><div class="row"><input id="faltante"  value="${valorFaltante
                        }" type="hidden" /><label class="label label-primary" style="font-size: 14px">Valor Faltante: $ ${
                        addCommas(valorFaltante)
                        }</label><br /><br /><small><b>Nota:</b> No puede guardar el pedido hasta que el valor faltante sea 0</small></div>`);

                    $('.fecha_formapago').datetimepicker({
                        minDate: `-${new Date()}`,
                        format: 'YYYY/MM/DD',
                    });
                },
                complete: function(data) {
                    $(`#slcCondicion${i}`).select2();
                    $(`#slcBanco${i}`).select2();
                }
            });
        }

        function buscarPagosyAccesorios() {
            $.ajax({
                url: '/vpedidos/BuscarPagosyAccesorios',
                data: {
                    pedido: $('#id').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if ('@Model.facturado' == 'False') {
                        $('#tablaPagos').dataTable().fnDestroy();
                        $('#tablaPagos').find('tbody').empty();
                        valorFaltante3 = 0;
                        for (var i = 0; i < data.pagos.length; i++) {
                            $('#tablaPagos').find('tbody').append(
                                `<tr class="tr_pagos" id="'${data.pagos[i].id}|${i}'"><td align="center">${data.pagos[i]
                                .condicion
                                }</td><td align="center">$<input type="hidden" name="valor${x}" id="valor${i}" value="${
                                data.pagos[i].valor}"/>${addCommas(data.pagos[i].valor)
                                }</td><td align="center">${data.pagos[i].fecpago}</td><td align="center">${data.pagos[i]
                                .financiera_nombre}</td><td align="center">${data.pagos[i].observaciones
                                }</td><td align="center"><button type="button" class="btn btn-danger btn-circle botonAccion" onclick="eliminarPagoBD('${
                                data.pagos[i].id}','${i}')"><i class="fa fa-remove"></i></button></td></tr>`);

                            valorFaltante3 += data.pagos[i].valor;
                        }
                        console.log(`se elimino el pago y valorFaltante3 es igual a:${valorFaltante3}`);

                        $('#tablaAccesorios').dataTable().fnDestroy();
                        $('#tablaAccesorios').find('tbody').empty();
                        for (var i = 0; i < data.rpt.length; i++) {
                            cantidadRepuestos = i;
                            $('#tablaAccesorios').find('tbody').append(
                                `<tr class="tr_accesorios" id="'${data.rpt[i].id}'"><td align="left">${
                                data.rpt[i].codigo}</td><td align="left">${data.rpt[i].referencia
                                }</td><td align="left">${data.rpt[i].alias}</td><td align="left">${data.rpt[i].obsequio
                                }</td><td align="right">$${addCommas(
                                    Math.round(data.rpt[i].valor / data.rpt[i].cantidad))}</td><td align="center">${data
                                .rpt[i].cantidad
                                }</td><td align="right">$<input type="hidden" name="totalRespuesto${cantidadRepuestos
                                }" id="totalRespuesto${cantidadRepuestos}" value="${data.rpt[i].valor}"/>${addCommas(
                                    data.rpt[i].valor)
                                }</td><td align="center"><button id="Remove" class="btn btn-danger btn-circle botonAccion" type="button" onclick="eliminarAccesorioBD(${
                                data.rpt[i].id})"><i class="fa fa-remove"></i></button></td></tr>`);
                        }
                        $('#tablaRetomas').dataTable().fnDestroy();
                        $('#tablaRetomas').find('tbody').empty();
                        for (var i = 0; i < data.rt.length; i++) {
                            $('#tablaRetomas').find('tbody').append(
                                `<tr class="tr_retomas" id="'${data.rt[i].id}'"><td align="center">${data.rt[i].modelo
                                }</td><td align="center">${data.rt[i].placa}</td><td align="center">${data.rt[i]
                                .kilometraje
                                }</td><td align="center">$${addCommas(data.rt[i].valor)}</td><td align="center">${
                                data.rt[i].obligaciones}</td><td align="center">$${addComas(data.rt[i].valor_obligacion)
                                }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" type="button" onclick="eliminarRetomaBD(${
                                data.rt[i].id})"><i class="fa fa-remove"></i></button></td></tr>`);
                        }

                        $('#tablaCostosA').dataTable().fnDestroy();
                        $('#tablaCostosA').find('tbody').empty();

                        for (var i = 0; i < data.cad.length; i++) {
                            cantidadCostos = i;
                            $('#tablaCostosA').find('tbody').append(
                                `<tr class="tr_costosA" id="'${data.cad[i].cadID}'"><td align="center">${
                                data.cad[i].cadDes}</td><td align="center">${data.cad[i].cadObsequio
                                }</td><td align="center"><input type="hidden" name="valor_costo${cantidadCostos
                                }" id="valor_costo${cantidadCostos}" value="${data.cad[i].cadValor}"/>${addCommas(
                                    data.cad[i].cadValor)
                                }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" type="button" onclick="eliminarRetomaBD(${
                                data.cad[i].cadID})"><i class="fa fa-remove"></i></button></td></tr>`);
                        }
                    } else {
                        $('#tablaPagos').dataTable().fnDestroy();
                        $('#tablaPagos').find('tbody').empty();
                        valorFaltante3 = 0;
                        for (var i = 0; i < data.pagos.length; i++) {
                            $('#tablaPagos').find('tbody').append(
                                `<tr class="tr_pagos" id="'${data.pagos[i].id}|${i}'"><td align="center">${
                                data.pagos[i].condicion}</td><td align="center">$${addCommas(data.pagos[i].valor)
                                }</td><td align="center">${data.pagos[i].fecpago
                                }</td><td align="center">${data.pagos[i].financiera_nombre}</td><td align="center">${
                                data.pagos[i].observaciones
                                }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" disabled type="button" onclick="eliminarPagoBD(${
                                data.pagos[i].id})"><i class="fa fa-remove"></i></button></td></tr>`);

                            valorFaltante3 += data.pagos[i].valor;
                        }

                        $('#tablaAccesorios').dataTable().fnDestroy();
                        $('#tablaAccesorios').find('tbody').empty();
                        for (var i = 0; i < data.rpt.length; i++) {
                            $('#tablaAccesorios').find('tbody').append(
                                `<tr class="tr_accesorios" id="'${data.rpt[i].id}'"><td align="left">${
                                data.rpt[i].codigo}</td><td align="left">${data.rpt[i].referencia
                                }</td><td align="left">${data.rpt[i].obsequio
                                }</td><td align="right">$${addCommas(data.rpt[i].valor)}</td><td align="center">${
                                data.rpt[i].cantidad}</td><td align="right">$${addCommas(
                                    Math.round(data.rpt[i].cantidad * data.rpt[i].valor))
                                }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" disabled type="button" onclick="eliminarAccesorioBD(${
                                data.rpt[i].id})"><i class="fa fa-remove"></i></button></td></tr>`);
                        }
                        $('#tablaRetomas').dataTable().fnDestroy();
                        $('#tablaRetomas').find('tbody').empty();
                        for (var i = 0; i < data.rt.length; i++) {
                            $('#tablaRetomas').find('tbody').append(
                                `<tr class="tr_retomas" id="'${data.rt[i].id}'><td align="center">${data.rt[i].modelo
                                }</td><td align="center">${data.rt[i].placa}</td><td align="center">${data.rt[i]
                                .kilometraje
                                }</td><td align="center">$${addCommas(data.rt[i].valor)}</td><td align="center">${
                                data.rt[i].obligaciones}</td><td align="center">$${addComas(data.rt[i].valor_obligacion)
                                }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" disabled type="button" onclick="eliminarRetomaBD(${
                                data.rt[i].id})"><i class="fa fa-remove"></i></button></td></tr>`);
                        }

                        $('#tablaCostosA').dataTable().fnDestroy();
                        $('#tablaCostosA').find('tbody').empty();
                        for (var i = 0; i < data.cad.length; i++) {
                            cantidadCostos = i;
                            $('#tablaCostosA').find('tbody').append(
                                `<tr class="tr_costosA" id="'${data.cad[i].cadID}'"><td align="center">${
                                data.cad[i].cadDes}</td><td align="center">${data.cad[i].cadObsequio
                                }</td><td align="center"><input type="hidden" name="valor_costo${cantidadCostos
                                }" id="valor_costo${cantidadCostos}" value="${data.cad[i].cadValor}"/>${addCommas(
                                    data.cad[i].cadValor)
                                }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" disabled type="button" onclick="eliminarRetomaBD(${
                                data.cad[i].cadID})"><i class="fa fa-remove"></i></button></td></tr>`);
                        }
                    }
                },
                complete: function(data) {
                    agregarPago();
                }
            });
        }

        function eliminarPagoBD(id, contador) {
            $('.confirm').removeAttr("disabled");
            $('.cancel').removeAttr("disabled");
            swal({
                    title: "Esta seguro que desea eliminar?",
                    text: "El registro se eliminara de la base de datos",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Si, Eliminar!",
                    cancelButtonText: "No, cancelar!",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },
                function(isConfirm) {
                    if (isConfirm) {
                        const elimin = parseInt(quitCommas($(`#valor${contador}`).val()));
                        console.log(elimin);

                        const falta = parseInt(quitCommas($('#faltante').val()));

                        if (elimin > falta) {
                            if (falta < 0) {
                                valorFaltante2 = elimin + falta;
                            } else {
                                valorFaltante2 = elimin - falta;
                            }
                        } else {
                            valorFaltante2 = falta - elimin;
                        }

                        valorFaltante3 = valorFaltante2;
                        //console.log(valor_total);

                        //valorFaltante2+=elimin;
                        //console.log(valorFaltante2);

                        $(`#item${contador}`).remove();
                        $('#valorfaltantetext').html(`Valor Faltante $${addCommas(valorFaltante2)}`);
                        //$('#btnGuardar').hide();
                        //$('#btnGuardarSimulacion').hide();
                        //$(":submit").prop("disabled", true);

                        $.ajax({
                            url: '/vpedidos/EliminarFpagos',
                            data: {
                                id: id
                            },
                            type: "post",
                            cache: false,
                            success: function() {
                                //location.reload(true);
                                buscarPagosyAccesorios();
                                swal("Eliminado!", "El registro se ha eliminado correctamente.", "success");
                                creditos($('#nit').val());
                            }
                        });
                    } else {
                        swal("Cancelado", "Se ha cancelado la operación", "error");
                    }
                });
            agregarPago();
        }

        function eliminarPago(id) {
            debugger;
            const elimin = parseFloat(quitCommas($(`#valor${id}`).val()));
            console.log(elimin);

            valor_total = valor_total - parseFloat(quitCommas($(`#valor${id}`).val()));
            valor_total2 = valor_total;
            console.log(valor_total);

            valorFaltante2 += elimin;
            valorFaltante -= elimin;
            //let val1 = (valorFaltante2*1).ToFixed(2);
            //valorFaltante2 = parseFloat(val1);
            console.log(quitCommas($('#vrtotal').val()));
            //valorFaltante3 = parseFloat(quitCommas($('#vrtotal').val())) - (parseFloat(valorFaltante2));
            valorFaltante3 -= elimin;
            //var val2=(valorFaltante3*1).ToFixed(2);
            //valorFaltante3 = parseFloat(val2);

            console.log(valorFaltante2);
            console.log(valorFaltante3);

            $(`#item${id}`).remove();
            $('#valorfaltantetext').html(`Valor Faltante $${addCommas(valorFaltante2)}`);
            $('#btnGuardar').hide();
            $('#btnGuardarSimulacion').hide();
            $(":submit").prop("disabled", true);
            //buscarPagosyAccesorios();
            agregarPago();
        }
        //================================== FIN VALIDACION FORMAS DE PAGO ===================================

        //====================================== VALIDACION ACCESORIOS =======================================
        function pintarTablaAccesorio() {
            r++;
            cantidadRepuestos += r;
            $('#lista_repuestos').val(x);
            var obsequio = '';
            var valor = '';

            if ($('#slcobsequio').prop('checked')) {
                obsequio = "Si";
                valorO = "true";
            } else {
                obsequio = "No";
                valorO = "false";
            }
            const accesorio = $('#selectRepuestos').val();
            var valor = $('#txtCostoAccesorio').val();
            const cantidad = $('#cantidadRespuesto').val();

            if (accesorio != "" && valor != "" && cantidad !== "") {
                if ('@Model.facturado' == 'False') {
                    const calcularValorTotal = Math.round(parseInt($('#cantidadRespuesto').val()) *
                        parseInt(quitCommas($('#txtCostoAccesorio').val())));

                    $('#tablaAccesorios').append(
                        `<tr id="row${cantidadRepuestos}"><td align="left"><input type="hidden" name="repuestosV${
                        cantidadRepuestos}" id="repuestosV${cantidadRepuestos}" value="${accesorio}"/>${$(
                            '#selectRepuestos option:selected').val()
                        }</td><td align="left"><input type="hidden" name="repuestos${cantidadRepuestos}" id="repuestos${
                        cantidadRepuestos}" value="${accesorio}"/>${$('#selectRepuestos option:selected').text()
                        }</td><td align="left"><input type="hidden" value="${valorO}" name="obsequio${cantidadRepuestos
                        }" id="obsequio${cantidadRepuestos}" />${obsequio
                        }</td><td align="right"><input type="hidden" name="costo${cantidadRepuestos}" id="costo${
                        cantidadRepuestos}" value="${$('#txtCostoAccesorio').val()}"/>$ ${addCommas(
                            $('#txtCostoAccesorio').val())
                        }</td><td align="right"><input type="hidden" name="cantidadRespuesto${cantidadRepuestos
                        }" id="cantidadRespuesto${cantidadRepuestos}" value="${$('#cantidadRespuesto').val()
                        }"/>${addComas($('#cantidadRespuesto').val())
                        }</td><td align="right"><input type="hidden" name="totalRespuesto${cantidadRepuestos
                        }" id="totalRespuesto${cantidadRepuestos}" value="${calcularValorTotal
                        }"/>$ ${addComas(calcularValorTotal)
                        }</td><td align="center"><button class="btn btn-danger btn-circle botonAccion" type="button" id="eliminarAccesorios${
                        cantidadRepuestos}" onclick="eliminarAccesorio(${cantidadRepuestos
                        })"><i class="fa fa-remove"></i></button></td></tr>`);
                }
            }
            agregarPago();
        };

        function eliminarAccesorio(pos) {
            $(`#row${pos}`).remove();
            agregarPago();
        }

        function eliminarAccesorioBD(id) {
            swal({
                    title: "Esta seguro que desea eliminar?",
                    text: "El registro se eliminara de la base de datos",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Si, Eliminar!",
                    cancelButtonText: "No, cancelar!",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },
                function(isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            url: '/vpedidos/EliminarRepuestos',
                            data: {
                                id: id
                            },
                            type: "post",
                            cache: false,
                            success: function() {
                                swal("Eliminado!", "El registro se ha eliminado correctamente.", "success");
                                //location.reload(true);
                            }
                        }).done(function() {
                            $('#Remove').parents("tr").remove();
                                agregarPago();

                        }).error(function() {
                            alerte("No se pudo eliminar el accesorio. ");
                        });

                    } else {
                        swal("Cancelado", "Se ha cancelado la operación", "error");
                    }
                });
        }

        function rbGenericos(id) {
            $.ajax({
                url: '/cotizacion/buscarRepuestosGenericosPedido',
                data: {
                },
                type: "post",
                cache: false,
                success: function(data) {
                    //$('#rbGenerico' + id + '').empty();
                    //$('#txtCostoAccesorio' + id + '').val('');
                    //$('#selectRepuestos'+id+'').append($('<option>', {
                    //    value: '',
                    //    text: ''
                    //}));

                    $('#txtCostoAccesorio').val('');
                    $('#selectRepuestos').empty();
                    $('#selectRepuestos').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#selectRepuestos').append($('<option>',
                            {
                                value: data[i].ref_codigo,
                                text: `${data[i].ref_codigo} - ${data[i].ref_descripcion} - ${data[i].alias}`
                            }));
                    }
                    $('#selectRepuestos').select2();
                }
            });
        }

        function rbModelos(id) {
            $.ajax({
                url: '/cotizacion/buscarRepuestosPorModelo',
                data: {
                    modelo: $('#modelo').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#txtCostoAccesorio').val('');
                    $('#selectRepuestos').empty();
                    $('#selectRepuestos').append($('<option>',
                        {
                            value: '',
                            text: 'Seleccione'
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#selectRepuestos').append($('<option>',
                            {
                                value: data[i].referencia,
                                text: data[i].descripcion
                            }));
                    }
                    $('#selectRepuestos').select2();
                }
            });
        }

        function costos(id) {
            $.ajax({
                url: '/cotizacion/buscarPrecioReferencia',
                data: {
                    idRepuesto: $('#selectRepuestos').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#txtCostoAccesorio').val(addCommas(data.precio1));
                },
                complete: function(data) {
                    if (data.responseText != '') {
                        console.log('tiene algo');
                    } else {
                        $('#txtCostoAccesorio').val('0');
                    }
                }
            });
        }

        //==================================== FIN VALIDACION ACCESORIOS =====================================

        //======================================= VALIDACION RETOMAS =========================================
        function agregarRetoma() {
            const btnEliminar = `<button class="btn btn-danger btn-circle botonAccion" id="${re
                }" type="button" onclick="eliminarRetoma(this.id)"><i class="fa fa-remove"></i></button>`;

            re++;

            const option = '';
            const optionBanco = '';
            var obligacion = '';

            if (re > 1) {
                const x = re - 1;

                $('#lista_retomas').val(x);

                if ($('#txtObligacion_retoma').prop('checked')) {
                    obligacion = "Si";
                } else {
                    obligacion = "No";
                }

                if ($(`#txtKlretoma${x}`).val() != 'undefined' && $(`#txtKlretoma${x}`).val() != '') {
                    $('#tablaRetomas').append(
                        `<tr id="div${x}"><td align="center"><input type="hidden" name="modelo_retoma${x
                        }" id="modelo_retoma${x}" value="${$(`#txtModelo_retoma${x}`).val()
                        }"/>${$(`#txtModelo_retoma${x}`).val()
                        }</td><td align="center"><input type="hidden" name="placa_retoma${x}" id="placa_retoma${x
                        }" value="${$(`#placaRetoma${x}`).val()}"/>${$(`#placaRetoma${x}`).val()
                        }</td><td align="center"><input type="hidden" value="${$(`#txtKlretoma${x}`).val()
                        }" name="kl_retoma${x}" id="kl_retoma${x}" />${$(`#txtKlretoma${x}`).val()
                        }</td><td align="center"><input type="hidden" value="${$(`#txtValorRetoma${x}`).val()
                        }" name="valor_retoma${x}" id="valor_retoma${x}"  />$${$(`#txtValorRetoma${x}`).val()
                        }</td><td align="center"><input type="hidden" value="${$('#txtObligacion_retoma').val()
                        }" name="obligacion_retoma${x}" id="obligacion_retoma${x
                        }" />${obligacion}</td><td align="center"><input type="hidden" value="${$('#txtValorObligacion')
                        .val()}" name="valor_obligacion${x
                        }" id="valor_obligacion${x}" />${$('#txtValorObligacion').val()}</td><td align="center">${
                        btnEliminar}</td></tr>`);
                }
            }
            if ('@Model.facturado' == 'False') {
                const btnAgregar =
                    '<button class="btn btn-success botonAccion" type="button" onclick="agregarRetoma()"><i class="fa fa-plus"></i> Agregar</button>';
                $('#divRetomas').html(
                    `<div class="row"><div class="col-sm-6"><div class="form-group"><label class="control-label col-md-4">Placa Retoma:<span class="text-danger">&nbsp;*</span></label><div class="col-md-6"><input class="form-control" name="placaRetoma${
                    re}" id="placaRetoma${re
                    }" value="" placeholder = "Ingrese Placa" type="text"/><label class="text-danger" id="AlertaRetomaNoEncontrada" style="display:none;">Placa no registrada!</label></div><div class="col-md-2"><button type="button" class="btn btn-default" id="${
                    re
                    }" onclick="buscarRetoma(this.id)"><i class="fa fa-search"></i></button></div></div></div></div><div class="row"><div class="col-sm-6"><div class="form-group"><label class="control-label col-md-4">Vehículo Retoma:&nbsp;</label><div class="col-md-6"><input class="form-control modelo_retoma" name="txtModelo_retoma${
                    re}" id="txtModelo_retoma${re
                    }" value=""/></div></div></div><div class="col-sm-6"><div class="form-group"><label class="control-label col-md-4">Año Modelo:&nbsp;</label><div class="col-md-6"><input class="form-control placa_retoma" name="anioVehiculoRetoma${
                    re}" id="anioVehiculoRetoma${re
                    }" value="" /></div></div></div></div><div class="row"><div class="col-sm-6"><div class="form-group"><label class="control-label col-md-4">Valor Retoma:&nbsp;</label><div class="col-md-6"><input class="form-control valor_retoma number" name="txtValorRetoma${
                    re}" id="txtValorRetoma${re
                    }" value="" onkeyUp = "return miles(this.id)"  /></div></div></div><div class="col-sm-6"><div class="form-group"><label class="control-label col-md-4">Kilometraje:&nbsp;</label><div class="col-md-6"><input class="form-control kl_retoma" name="txtKlretoma${
                    re}" id="txtKlretoma${re
                    }" value="" onkeyUp = "return miles(this.id)"  /></div></div></div></div><div class="col-sm-6"><div class="form-group"><label class="control-label col-md-4">Obligaciones:&nbsp;</label><div class="col-md-6"><input name="txtObligacion_retoma" type="checkbox" id="txtObligacion_retoma" data-toggle = "toggle" data-size = "mini" value="false" onChange="checkretoma()"/></div></div></div><div class="col-sm-6"><div class="form-group" id="div_obligacion"><label class="control-label col-md-4">Valor Obligación:&nbsp;</label><div class="col-md-6"><input class="form-control number" name="txtValorObligacion" id="txtValorObligacion" value="" onkeyUp = "return miles(this.id)"  /></div></div><div class="col-md-2 re">${
                    btnAgregar}</div></div>`
                );
                $('#txtObligacion_retoma').bootstrapToggle('off');
            }
        }

        function buscarRetoma(id) {
            $.ajax({
                url: '/cotizacion/buscarPlacaRetoma',
                data: {
                    placa: $(`#placaRetoma${id}`).val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    console.log(data);
                    if (data.encontrado == false) {
                        $(`#txtModelo_retoma${id}`).val('');
                        $(`#anioVehiculoRetoma${id}`).val('');
                        $('#AlertaRetomaNoEncontrada').show();
                        setTimeout(function() {
                                $("#AlertaRetomaNoEncontrada").fadeOut(1500);
                            },
                            3000);
                    } else {
                        $(`#txtModelo_retoma${id}`).val(data.buscarPlaca.modvh_nombre);
                        $(`#anioVehiculoRetoma${id}`).val(data.buscarPlaca.anio_vh);
                    }
                }
            });
        }

        function checkretoma() {
            if ($('#txtObligacion_retoma').prop('checked')) {
                $('#div_obligacion').show();
            } else {
                $('#txtValorObligacion').val('');
                $('#div_obligacion').hide();
            }
        }

        function eliminarRetoma(id) {
            $(`#div${id}`).remove();
        }

        function eliminarRetomaBD(id) {
            swal({
                    title: "Esta seguro que desea eliminar?",
                    text: "El registro se eliminara de la base de datos",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Si, Eliminar!",
                    cancelButtonText: "No, cancelar!",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },
                function(isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            url: '/vpedidos/EliminarRetomas',
                            data: {
                                id: id
                            },
                            type: "post",
                            cache: false,
                            success: function() {
                                swal("Eliminado!", "El registro se ha eliminado correctamente.", "success");
                                location.reload(true);
                            }
                        });

                    } else {
                        swal("Cancelado", "Se ha cancelado la operación", "error");
                    }
                });
        }
        //===================================== FIN VALIDACION RETOMAS ========================================

        //=================================== VALIDACION COSTOS ADICIONALES ====================================
        function agregarCostos() {
            cantidadCostos++;
            const btnEliminar = `<button class="btn btn-danger btn-circle botonAccion" id="${cantidadCostos
                }" type="button" onclick="eliminarCostos(this.id)"><i class="fa fa-remove"></i></button>`;
            var obsequio = '';
            var valor = '';

            const btnAgregar =
                '<button class="btn btn-success botonAccion" type="button" onclick="agregarCosto()"><i class="fa fa-plus"></i> Agregar</button>';

            $('#lista_costos').val(cantidadCostos);

            if ($('#txtObsequio_costo').prop('checked')) {
                obsequio = "Si";
                valor = true;
            } else {
                obsequio = "No";
                valor = false;
            }
            const descripcion = $('#txtDescripcion_costo').val();
            const costo = $('#txtValor_costo').val();
            if (costo != "" && descripcion != "") {
                $('#tablaCostosA').append(
                    `<tr id="div${cantidadCostos}"><td align="center"><input type="hidden" name="descripcion_costo${
                    cantidadCostos}" id="descripcion_costo${cantidadCostos
                    }" value="${$('#txtDescripcion_costo').val()}"/>${$('#txtDescripcion_costo').val()
                    }</td><td align="center"><input type="hidden" value="${$('#txtObsequio_costo').val()
                    }" name="obsequio_costo${cantidadCostos
                    }" id="obsequio_costo${cantidadCostos}" />${obsequio
                    }</td><td align="center"><input type="hidden" value="${$('#txtValor_costo').val()
                    }" name="valor_costo${cantidadCostos
                    }" id="valor_costo${cantidadCostos}" />$${addCommas($('#txtValor_costo').val())
                    }</td><td align="center">${btnEliminar}</td></tr>`);
            }

            if ('@Model.facturado' == 'False') {
                $('#divCostosA').html('<div class="col-sm-6">' +
                    '<div class="form-group">' +
                    '<label class="control-label col-md-4">Descripción:&nbsp;<span class="text-danger">*</span></label>' +
                    '<div class="col-md-6">' +
                    '<input name="txtDescripcion_costo" type="text" id="txtDescripcion_costo" class="form-control" value="" />' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-sm-6">' +
                    '<div class="form-group">' +
                    '<label class="control-label col-md-2">Valor:&nbsp;<span class="text-danger">*</span></label>' +
                    '<div class="col-md-6">' +
                    '<input name="txtValor_costo" id="txtValor_costo" type="text" class="form-control number" value="" onkeyUp="return miles(this.id)" />' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-sm-6">' +
                    '<div class="form-group">' +
                    '<label class="control-label col-md-4">Obsequio:&nbsp;<span class="text-danger">*</span></label>' +
                    '<div class="col-md-6">' +
                    '<input name="txtObsequio_costo" type="checkbox" id="txtObsequio_costo" data-toggle="toggle" , data-size="mini" value="true" />' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-sm-6">' +
                    '<div class="form-group">' +
                    '<button class="btn btn-success botonAccion" type="button" onclick="agregarCostos()"><i class="fa fa-plus"></i> Agregar</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>'
                );
                $('#txtObsequio_costo').bootstrapToggle();
            }

            agregarPago();
        }

        function eliminarCostos(id) {
            $(`#div${id}`).remove();
            agregarPago();
        }
        //================================= FIN VALIDACION COSTOS ADICIONALES ===================================

        function pagosRecibidos() {
            $.ajax({
                url: '/vpedidos/BuscarPagosRecibidos',
                data: {
                    pedido: $('#id').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $("#tablaPagosR").dataTable().fnDestroy();
                    $("#tablaPagosR").find('tbody').empty();
                    for (let h = 0; h < data.length; h++) {
                        $("#tablaPagosR").find("tbody").append(
                            `<tr align="center"><td style="text-align: left"><input name="fpago${h}"  id="fpago${h
                            }"   class="form-control" type="hidden" value="${data[h].fpago}" >${data[h].fpago
                            }</td><td style="text-align: right"><input name="valor${h
                            }" id="valor${h}" class="form-control" type="hidden" value="${data[h].valor}" >${addCommas(
                                data[h].valor)
                            }</td><td style="text-align: left"><input name="fecha${h}" id="fecha${h
                            }"  class="form-control" type="hidden" value="${data[h].fecha}" >${data[h].fecha
                            }</td></tr>`);
                    }
                },
                complete: function(data) {
                    //$('#tablaPagosR').dataTable({
                    //    //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                    //    dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                    //    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                    //    buttons: [
                    //        { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                    //        //{ extend: 'pdf', className: 'btn-sm', text: 'PDF' },
                    //        //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' },
                    //    ]
                    //});
                }
            });
        }

        $('#iddepartamento').change(function() {
            $('#idciudad').empty();
            $('#idciudad').val('').select2();
            $.ajax({
                url: '/cotizacion/buscarCuidadesDepartamento',
                data: {
                    id: $('#iddepartamento').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#idciudad').empty();
                    $('#idciudad').append($('<option>',
                        {
                            value: '',
                            text: ''
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#idciudad').append($('<option>',
                            {
                                value: data[i].ciu_id,
                                text: data[i].ciu_nombre,
                            }));
                    }
                    $('#idciudad').select2();
                }
            });
        });

        function buscarCiudad() {
            $.ajax({
                url: '/cotizacion/buscarCuidadesDepartamento',
                data: {
                    id: $('#iddepartamento').val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    $('#idciudad').empty();
                    $('#idciudad').append($('<option>',
                        {
                            value: '',
                            text: ''
                        }));
                    for (let i = 0; i < data.length; i++) {
                        $('#idciudad').append($('<option>',
                            {
                                value: data[i].ciu_id,
                                text: data[i].ciu_nombre,
                                selected: '@ViewBag.idciudad',
                            }));
                    }
                    $('#ciu_id').select2();
                },
                complete: function() {
                    $('#cargando').html('<h3>Completado<h3/>');
                    $('#modal-title').html('Cargo información con éxito');
                    $('#cerrarmodalCargandoInfo').prop('disabled', false);
                    //$('#cerrarmodalCargandoInfo').show();

                    setTimeout(function() {
                            $('#modalCargandoInfo').modal('hide');
                        },
                        1000);
                }
            });
        }

        function valida(id) {
            window.location.href = `@Url.Action("Edit", "vpedidos")?id=${id}&menu=${@ViewBag.id_menu}`;
        }

        function seguimiento(id) {
            window.location.href = `@Url.Action("Seguimiento", "vpedidos")?menu=${@ViewBag.id_menu}&id=${id}`;
        }

        function verifica(id) {
            window.location.href = `@Url.Action("Verificar", "vpedidos")?menu=${@ViewBag.id_menu}&id=${id}`;
        }

        function buscarDatosBackOffice() {
            window.location.href = `@Url.Action("BrowserBackOffice", "vpedidos")?menu=${@ViewBag.id_menu}`;
        }

        function AgregarQuitarFavorito() {
            $.ajax({
                url: '/Inicio/AgregarQuitarFavorito',
                data: {
                    id_menu: @ViewBag.id_menu,
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data.esFavorito == true) {
                        $('#areaFavoritos')
                            .html(
                                "<i class='fa fa-close'></i>&nbsp;&nbsp;<a href='#' onclick='AgregarQuitarFavorito();return false;'>Quitar de Favoritos</a>");
                    } else {
                        $('#areaFavoritos')
                            .html(
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;<a href='#' onclick='AgregarQuitarFavorito();return false;'>Agregar a Favoritos</a>");
                    }
                }
            });
        }

        function tercerobusqueda() {
            $.ajax({
                url: "/vpedidos/BuscarClienteCedula",
                data: {
                    cliente: $("#numeroIdentificacion").val()
                },
                type: "post",
                cache: false,
                success: function(data) {
                    const terceroId = data.info[0].idTercero;
                    creditos(terceroId);
                }
            });
        }

        function creditos(terceroId) {
            $.ajax({
                url: "/vpedidos/BuscarCreditos",
                data: {
                    idTercero: terceroId,
                },
                type: "post",
                cache: false,
                success: function(data) {
                    if (data != null) {
                        $("#tieneCreditos").show("1000");
                        for (let k = 0; k < data.length; k++) {
                            $("#tablatieneCreditos").append(
                                `<tr id="lineaCredito${k
                                }"><td align="center"><input type="radio" name="rbCredito" id="rbCredito" value="${data[
                                    k]
                                .Id
                                }" onclick="selectCredito ('${data[k].Id}','${data[k].vaprobado}','${data[k]
                                .financiera_id
                                }')" /></td><td align="right">${data[k].fecha
                                }</td><td align="center"><input type="hidden" name="estadoC${k}" id="estadoC${k
                                }" value="${
                                data[k].descripcion}"/>${data[k].descripcion
                                }</td><td align="center"><input type="hidden" name="valorS${k}" id="valorS${k
                                }" value="${
                                data[k].vsolicitado}"/>$ ${data[k].vsolicitado
                                }</td><td align="center"><input type="hidden" name="valorA${k}" id="valorA${k
                                }" value="${
                                data[k].vaprobado}" />$ ${data[k].vaprobado}</td></tr>`);
                        }
                    }
                }
            });
        }

        function selectCredito(id, valor, banco) {
            debugger;
            $("#slcCondicion1").val("1").select2();
            $("#slcBanco1").val(banco).select2();
            $("#txtValor1").val(valor);
            $("#idcreditoseleccionado2").val(id);
        }

        function warningFacturado() {
            $.ajax({
                url: '/vpedidos/BuscarDatos',
                data: {},
                type: "post",
                cache: false,
                success: function(data) {

                }
            });
        }
    </script>
}