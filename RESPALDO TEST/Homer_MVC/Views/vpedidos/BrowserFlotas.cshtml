@{
    ViewBag.Icono = "fa fa-file-text-o";
    ViewBag.Title = "BrowserFlotas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/Vendor/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Vendor/BootstrapMultiselect/multiselect.css" rel="stylesheet" />
    <link href="~/Vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    @Styles.Render("~/bundles/select2/css")
}

<style type="text/css">
    .popover-content {
        height: 100px;
        width: 200px;
    }
</style>

<div class="panel-body">
    <div class="panel-heading" style="background-color:white;  border:solid 1px; border-color:#e4e5e7">
        <div class="panel-body">

            <div id="hbreadcrumb" class="pull-right">

                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Enlaces" data-content="<ul>@ViewBag.nombreEnlaces</ul>" data-html="true">
                    <i class="text-info fa fa-tags"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Documentos" data-content="<ul></i><a href=''>Documento 1</a></ul>  <ul></i><a href=''>Documento 2</a></ul> <ul></i><a href=''>Documento 3</a></ul>" data-html="true">
                    <i class="text-primary fa fa-files-o"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Favoritos" data-content="@ViewBag.Favoritos" data-html="true">
                    <i class="text-warning fa fa-star"></i>
                </button>

            </div>
            <h3 class="font-light m-b-xs">
                <i class="text-info @ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title
            </h3>
            <small>@ViewBag.Title</small>
        </div>
    </div>
</div>

<div class="panel-body" style="padding-top:0px;">
    <div class="hpanel">

        @if (TempData["mensaje"] != null)
        {
            <br />
            <div class="alert alert-success  alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p><i class="fa fa-check fa-2x"></i> @TempData["mensaje"]</p>
            </div>
        }

        @if (TempData["mensaje_error"] != null)
        {
            <br />
            <div class="alert alert-danger  alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p><i class="fa fa-times fa-2x"></i> @TempData["mensaje_error"]</p>
            </div>
        }
        @Html.Hidden("menu")
        <div id="tabs" class="tab-content">

            <div class="m float-e-margins text-right">
                <div class="tooltip-demo">

                    <div id="div-mensaje"></div>

                </div>
            </div>

            <ul id="tabs-crear" class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#buscar"><i class="fa fa-refresh"></i>&nbsp;&nbsp;@ViewBag.Title</a></li>
            </ul>

            <div id="buscar" class="tab-pane active">
                <div class="panel-body">
                    <div class="panel-body-busqueda">
                        <div class="table-responsive" style="width:100%;">
                            <div id="div-mensaje-buscar"></div>
                            <table class="table table-striped table-bordered table-hover" id="tablaBusquedas">
                                <thead>
                                    <tr>
                                        <th style="text-align:center">Acción</th>
                                        <th style="text-align:center">#  Pedido</th>
                                        <th style="text-align:center">Fecha pedido</th>
                                        <th style="text-align:center">Fecha matricula</th>
                                        <th style="text-align:center">Año</th>
                                        <th style="text-align:center">Modelo</th>
                                        <th style="text-align:center">Color</th>
                                        <th style="text-align:center">Asesor</th>
                                        <th style="text-align:center">Vehículo</th>
                                        <th style="text-align:center">Vin</th>
                                        <th style="text-align:center">Bodega</th>
                                        <th style="text-align:center">Ubicación</th>
                                        <th style="text-align:center">Fecha asignacion</th>
                                        <th style="text-align:center">Cliente</th>
                                        <th style="text-align:center">Valor Total</th>
                                        <th style="text-align:center">Valor aplicado</th>
                                        <th style="text-align:center">Saldo</th>
                                        <th style="text-align:center">Proceso</th>
                                        <th style="text-align:center">Autorizacion</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/select2/js")
    <script src="~/Vendor/BootstrapMultiselect/multiselect.js"></script>
    <script src="~/Vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Vendor/datatablesExcelExport/dataTable1.4.0-buttons.js"></script>
    <script src="~/Vendor/datatablesExcelExport/JSZip3.1.3.min.js"></script>
    <script src="~/Vendor/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/Vendor/pdfmake/build/vfs_fonts.js"></script>
    <script src="~/Vendor/datatablesExcelExport/jsZipDataTables.js"></script>

    <script type="text/javascript">

        $(document).ready(function () {
            buscarDatos();
            $('[data-toggle="popover"]').popover();
            $('.js-source-states').select2();
        });
        idUrl=0;

        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + '.' + '$2');
            }
            return x1 + x2;
        };

        function asignaIdUrls(id){
            idUrl = id;
        }

        function buscarDatos() {
            $.ajax({
                url: '/vpedidos/BuscarPedidosFlotas',
                data: {
                },
                type: "post",
                cache: false,
                success: function (data) {
                    console.log(data);
                    $('#tablaBusquedas').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        if ((data[i].facturado == false && data[i].facturaAcc == "") || (data[i].facturado == true && data[i].facturaAcc == "") || (data[i].facturado == false && data[i].facturaAcc == "No tiene accesorios")) {
                            if (data[i].documentos.Data.solicitar == true) {
                                $('#tablaBusquedas').find('tbody').append('<tr>'
                                    + '<td  align="center">'
                                    + '<button id="btn_popover_' + i + '" class="btn btn-info btn-xs" data-toggle="popover" data-placement="top" title="Opciones" onclick="asignaIdUrls(\'' + data[i].id + '\')">&nbsp;&nbsp;'
                                    + 'Opciones&nbsp;&nbsp;'
                                    + '</button>&nbsp;&nbsp;'
                                    + '</td>'
                                    + '<td align="right">' + data[i].numero + '</td>'
                                    + '<td align="right">' + data[i].fecha + '</td>'
                                    + '<td align="right">' + data[i].fechaMatricula + '</td>'
                                    + '<td align="right">' + data[i].anio + '</td>'
                                    + '<td align="left">' + data[i].modelo + '</td>'
                                    + '<td align="left">' + data[i].color + '</td>'
                                    + '<td align="left">' + data[i].asesor + '</td>'
                                    + '<td align="right">' + data[i].planmayor + '</td>'
                                    + '<td align="right">' + data[i].vin + '</td>'
                                    + '<td align="left">' + data[i].bodccs_nombre + '</td>'
                                    + '<td align="left">' + data[i].ubicacion + '</td>'
                                    + '<td align="right">' + data[i].fechaA + '</td>'
                                    + '<td align="left">'
                                    + '<input id="idCliente" name="idCliente" class="form-control" type="hidden" value="' + data[i].idCliente + '"/>'
                                    + data[i].cliente
                                    + '</td>'
                                    + '<td align="right">' + addCommas(data[i].vrtotal) + '</td>'
                                    + '<td align="right">' + addCommas(data[i].valor) + '</td>'
                                    + '<td align="right">' + addCommas(data[i].vrtotal - data[i].valor) + '</td>'
                                    + '<td align="left">' + data[i].proceso + '</td>'
                                    + '<td align="left">' + data[i].autorizados + '</td>'
                                    + '</tr>');
                            }
                        }
                    }
                },
                complete: function (data) {
                    $('.m_datatable').on('m-datatable–on-init', function () {
                        mApp.initPopovers();
                    });

                    for (var j = 0; j < data.responseJSON.length; j++) {
                        $('#btn_popover_' + j).popover({
                            trigger: 'click',
                            placement: 'right',
                            html: 'true',
                            content: '<div>'
                                + '<button class="btn btn-info btn-xs" data-toggle="tooltip" data-placement="top" title="Ver" onclick="valida(' + '\'' + data.responseJSON[j].id + '\')">&nbsp;&nbsp;'
                                + '<i class="fa fa-eye"></i>&nbsp;&nbsp;'
                                + '</button>&nbsp;&nbsp;'
                                + '<button class="btn btn-primary btn-xs" data-toggle="tooltip" data-placement="top" title="Verificacion documentos" onclick="verifica(' + '\'' + data.responseJSON[j].id + '\')">&nbsp;&nbsp;'
                                + '<i class="fa fa-file-text-o"></i>&nbsp;&nbsp;'
                                + '</button>&nbsp;&nbsp'
                                + (data.responseJSON[j].autorizados == "No solicitado" ? '<button class="btn btn-danger btn-xs" data-toggle="tooltip" data-placement="top" title="Verificacion documentos" onclick="solicitarExcepcion(' + '\'' + data.responseJSON[j].planmayor + '\',\'' + data.responseJSON[j].modelo + '\')">&nbsp;&nbsp;'
                                    + '<i class="fa fa-files-o"></i>&nbsp;&nbsp;'
                                    + '</button>&nbsp;&nbsp' : '')
                                + '</div>',
                            template: '<div class="popover">'
                                + '<div class="arrow"></div>'
                                + '<h3 class="popover-title"></h3>'
                                + '<div class="popover-content"></div>'
                                + '<div class="popover-footer"></div>'
                                + '</div>'
                        });
                    }
                    $('#tablaBusquedas').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });
                }
            });
        }

        $('body').on('click', function (e) {
            $('[data-toggle="popover"]').each(function () {
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                    $(this).popover('hide');
                }
            });
        });

        function solicitarExcepcion(planmayor, modelo) {
            swal({
                title: 'Confirmacion',
                text: '¿Desea enviar la solicitud para facturar el vehiculo ' + planmayor + ' - ' + modelo + '?',
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si, solicitar!",
                cancelButtonText: "No, cancelar!",
                closeOnConfirm: false,
                closeOnCancel: false
            },
                function (isConfirm) {
                    if (isConfirm) {
                        if (planmayor == null || planmayor == "") {
                            swal("Este pedido no tiene plan mayor!", "", "warning");
                        } else {
                            $.ajax({
                                url: '/vpedidos/EnviarSolicitudFacturacion',
                                data: {
                                    plan_mayor: planmayor,
                                    modelo: modelo,
                                },
                                type: "post",
                                cache: false,
                                success: function (data) {
                                    if (data == -1) {
                                        swal("", "Error al enviar la notificación", "error");
                                    }
                                    if (data == 0) {
                                        swal("", "No existen usuarios parametrizados para enviar una notificación", "warning");
                                    }
                                    if (data == 1) {
                                        swal("", "Notificación enviada correctamente", "success");
                                    }
                                    if (data == 2) {
                                        swal("", "Ya se envio una notificación anteriormente del vehículo seleccionado", "warning");
                                    }
                                    buscarDatos();
                                }
                            });
                        }
                    }
                    else {
                        swal("Cancelado", "", "error");
                    }
                });
        }

        function valida(id) {
            window.location.href = '@Url.Action("Edit", "vpedidos")?menu='+@ViewBag.id_menu+'&id=' + id;
        }

        function verifica(id) {
            window.location.href = '@Url.Action("VerificarDocumentosFlotas", "vpedidos")?menu='+@ViewBag.id_menu+'&id=' + id;
        }

            function AgregarQuitarFavorito(){
                $.ajax({
                    url: '/Inicio/AgregarQuitarFavorito',
                    data: {
                        id_menu: @ViewBag.id_menu,
                    },
                    type: "post",
                    cache: false,
                    success: function (data) {
                        if (data.esFavorito == true) {
                            $('#areaFavoritos').html("<i class='fa fa-close'></i>&nbsp;&nbsp;<a href='#' onclick='AgregarQuitarFavorito();return false;'>Quitar de Favoritos</a>");
                        } else {
                            $('#areaFavoritos').html("<i class='fa fa-check'></i>&nbsp;&nbsp;<a href='#' onclick='AgregarQuitarFavorito();return false;'>Agregar a Favoritos</a>");
                        }
                    }
                });
            }

    </script>
}

