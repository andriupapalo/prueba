@{
    ViewBag.Icono = "fa fa-car";
    ViewBag.Title = "Salidas de taller";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    @Styles.Render("~/bundles/select2/css")
    <link href="~/Vendor/BootstrapMultiselect/multiselect.css" rel="stylesheet" />
    <link href="~/Vendor/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <style>
        .modal {
            overflow-y: auto;
        }

        @@media (min-width: 992px) {
            .modal-lg {
                width: 1024px;
            }
        }
    </style>
}

<div class="panel-body">
    <div class="panel-heading" style="background-color:white;  border:solid 1px; border-color:#e4e5e7">
        <div class="panel-body">

            <div id="hbreadcrumb" class="pull-right">

                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Enlaces" data-content="<ul>@ViewBag.nombreEnlaces</ul>" data-html="true">
                    <i class="text-info fa fa-tags"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Documentos" data-content="<ul></i><a href=''>Documento 1</a></ul>  <ul></i><a href=''>Documento 2</a></ul> <ul></i><a href=''>Documento 3</a></ul>" data-html="true">
                    <i class="text-primary fa fa-files-o"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Favoritos" data-content="@ViewBag.Favoritos" data-html="true">
                    <i class="text-warning fa fa-star"></i>
                </button>

            </div>
            <h3 class="font-light m-b-xs">
                <i class="text-info @ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title
            </h3>
            <small>Listado @ViewBag.Title</small>
        </div>
    </div>
</div>

<div class="panel-body" style="padding-top:0px">
    <div class="hpanel">
        <!--aqui se cargan los mensajes de exito y error-->
        @if (TempData["mensaje"] != null)
        {
            <div class="alert alert-success  alert-dismissible" id="mensaje">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p>@TempData["mensaje"]</p>
            </div>
        }

        @if (TempData["mensaje_error"] != null)
        {
            <div class="alert alert-danger  alert-dismissible" id="mensaje_error">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p>@TempData["mensaje_error"]</p>
            </div>
        }
        <div id="tabs" class="tab-content">
            <!--este no tengo idea de que hace-->
            <div class="m float-e-margins text-right">
                <div class="tooltip-demo">

                    <div id="div-mensaje"></div>

                </div>
            </div>
            <!--Aqui declaro las tabs que necesite-->
            <ul id="tabs-crear" class="nav nav-tabs">
                <!--esta primera tab es la activa (la que se muestra de primero) y el href es a que tab hace referencia-->
                @*Esta la tengo comentada mientras tanto*@
                @*<li class=""><a data-toggle="tab" href="#crear"><i class="@ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title</a></li>*@
                <li class="active"><a data-toggle="tab" href="#buscar"><i class="fa fa-search"></i>&nbsp;&nbsp;Solicitudes Recibidas</a></li>
                <li class=""><a data-toggle="tab" href="#buscar2"><i class="fa fa-search"></i>&nbsp;&nbsp;Solicitudes Procesadas</a></li>
                <li class=""><a data-toggle="tab" href="#buscar3"><i class="fa fa-search"></i>&nbsp;&nbsp;Recepcion de Traslados para Salidas de Taller</a></li>
            </ul>

            <div id="crear" class="tab-pane">

            </div>
            <div id="buscar" class="tab-pane active">
                <div class="panel-body">
                    <div class="row">
                        @*<div class="col-sm-3">
                                <div class="form-group">
                                    <label class="control-label col-md-4">Fecha Desde:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-8">
                                        @Html.Editor("fecha_desde", new { htmlAttributes = new { @class = "form-control", @type = "text", @placeholder = "Ingrese fecha", @required = "required", @value = ViewBag.fechadesde } })
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="control-label col-md-4">Fecha Hasta:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-8">
                                        @Html.Editor("fecha_hasta", new { htmlAttributes = new { @class = "form-control", @type = "text", @placeholder = "Ingrese fecha", @required = "required" } })
                                    </div>
                                </div>
                            </div>*@

                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="control-label col-md-4">Bodega:&nbsp;<span class="text-danger"></span></label>
                                <div class="col-md-8">
                                    @Html.DropDownList("bodega", null, htmlAttributes: new { @class = "multiselect-ui form-control", @placeholder = "Seleccione", @multiple = "multiple" })
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" style="padding-top:10px;">
                            <div class="input-group">
                                <input type="text" id="txtFiltroGeneral" placeholder="Buscar..." class="form-control"> <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary" id="botonbuscar">
                                        <i class="fa fa-search">&nbsp;Buscar</i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body-busqueda">
                        <div class="table-responsive">
                            <div id="div-mensaje-buscar"></div>
                            <div id="x1">
                                @*<input type="hidden" name="idrol" id="idrol" value="@ViewBag.rol" />
                                    <input type="hidden" name="idasesor" id="idasesor" value="@ViewBag.user" />*@

                            </div>
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <p><strong> Leyenda Stock Referencias</strong></p>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-success">&nbsp;</button><strong>Stock en bodega</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-warning">&nbsp;</button><strong> Stock en Otra Bodega</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-warning2">&nbsp;</button><strong> Stock en referencia reemplazo</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-danger">&nbsp;</button><strong> NO hay stock</strong>
                                </div>
                            </div>
                            <table id="tablaDisponibles" class="table table-striped table-bordered table-hover" width="100%">
                                <thead>
                                    <tr style="height:30px">
                                        <th style="text-align:left">Numero de Pedido<br /></th>
                                        <th style="text-align:left">OT<br /></th>
                                        <th style="text-align:left">Cliente</th>
                                        <th style="text-align:left">Marca Vehiculo</th>
                                        <th style="text-align:left">Modelo Vehiculo</th>
                                        <th style="text-align:left">Año</th>
                                        <th style="text-align:left">Fecha de Pedido</th>
                                        <th style="text-align:left">Tipo de Despacho<br /></th>
                                        <th style="text-align:left">Bodega</th>
                                        <th style="text-align:left">Bodega Destino</th>
                                        <th style="text-align:left">Referencias</th>
                                        @*<th style="text-align:left">Ubicacion de Repuesto</th>*@
                                        <th style="text-align:left">Acciones</th>
                                        
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="buscar2" class="tab-pane ">
                <div class="panel-body">
                    <div class="row">
                        @*<div class="col-sm-3">
                                <div class="form-group">
                                    <label class="control-label col-md-4">Fecha Desde:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-8">
                                        @Html.Editor("fecha_desde", new { htmlAttributes = new { @class = "form-control", @type = "text", @placeholder = "Ingrese fecha", @required = "required", @value = ViewBag.fechadesde } })
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="control-label col-md-4">Fecha Hasta:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-8">
                                        @Html.Editor("fecha_hasta", new { htmlAttributes = new { @class = "form-control", @type = "text", @placeholder = "Ingrese fecha", @required = "required" } })
                                    </div>
                                </div>
                            </div>*@

                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="control-label col-md-4">Bodega:&nbsp;<span class="text-danger"></span></label>
                                <div class="col-md-8">
                                    @Html.DropDownList("bodega2", null, htmlAttributes: new { @class = "multiselect-ui form-control", @placeholder = "Seleccione", @multiple = "multiple" })
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" style="padding-top:10px;">
                            <div class="input-group">
                                <input type="text" id="txtFiltroGeneral2" placeholder="Buscar..." class="form-control"> <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary" id="botonbuscar2">
                                        <i class="fa fa-search">&nbsp;Buscar</i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body-busqueda">
                        <div class="table-responsive">
                            <div id="div-mensaje-buscar2"></div>
                            <div id="x12">
                                @*<input type="hidden" name="idrol" id="idrol" value="@ViewBag.rol" />
                                    <input type="hidden" name="idasesor" id="idasesor" value="@ViewBag.user" />*@

                            </div>
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <p><strong> Leyenda Stock Referencias</strong></p>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-success">&nbsp;</button><strong>Stock en bodega</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-warning">&nbsp;</button><strong> Stock en Otra Bodega</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-warning2">&nbsp;</button><strong> Stock en referencia reemplazo</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-danger">&nbsp;</button><strong> NO hay stock</strong>
                                </div>
                            </div>
                            <table id="tablaDisponibles2" class="table table-striped table-bordered table-hover" width="100%">
                                <thead>
                                    <tr style="height:30px">
                                        <th style="text-align:left">Numero de Pedido<br /></th>
                                        <th style="text-align:left">OT<br /></th>
                                        <th style="text-align:left">Cliente</th>
                                        <th style="text-align:left">Marca Vehiculo</th>
                                        <th style="text-align:left">Modelo Vehiculo</th>
                                        <th style="text-align:left">Año</th>
                                        <th style="text-align:left">Fecha de Pedido</th>
                                        <th style="text-align:left">Tipo de Despacho<br /></th>
                                        <th style="text-align:left">Bodega</th>
                                        <th style="text-align:left">Bodega Destino</th>
                                        <th style="text-align:left">Referencias</th>
                                        @*<th style="text-align:left">Ubicacion de Repuesto</th>*@
                                        <th style="text-align:left">Acciones</th>
                                        
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="buscar3" class="tab-pane ">
                <div class="panel-body">
                    <div class="row">
                        @*<div class="col-sm-3">
                                <div class="form-group">
                                    <label class="control-label col-md-4">Fecha Desde:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-8">
                                        @Html.Editor("fecha_desde", new { htmlAttributes = new { @class = "form-control", @type = "text", @placeholder = "Ingrese fecha", @required = "required", @value = ViewBag.fechadesde } })
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="control-label col-md-4">Fecha Hasta:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-8">
                                        @Html.Editor("fecha_hasta", new { htmlAttributes = new { @class = "form-control", @type = "text", @placeholder = "Ingrese fecha", @required = "required" } })
                                    </div>
                                </div>
                            </div>*@

                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="control-label col-md-4">Bodega:&nbsp;<span class="text-danger"></span></label>
                                <div class="col-md-8">
                                    @Html.DropDownList("bodega3", null, htmlAttributes: new { @class = "multiselect-ui form-control", @placeholder = "Seleccione", @multiple = "multiple" })
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" style="padding-top:10px;">
                            <div class="input-group">
                                <input type="text" id="txtFiltroGeneral3" placeholder="Buscar..." class="form-control"> <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary" id="botonbuscar3">
                                        <i class="fa fa-search">&nbsp;Buscar</i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body-busqueda">
                        <div class="table-responsive">
                            <div id="div-mensaje-buscar2"></div>
                            <div id="x12">
                                @*<input type="hidden" name="idrol" id="idrol" value="@ViewBag.rol" />
                                    <input type="hidden" name="idasesor" id="idasesor" value="@ViewBag.user" />*@

                            </div>
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <p><strong> Leyenda Stock Referencias</strong></p>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-success">&nbsp;</button><strong>Stock en bodega</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-warning">&nbsp;</button><strong> Stock en Otra Bodega</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-warning2">&nbsp;</button><strong> Stock en referencia reemplazo</strong>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2" style="text-align:center">
                                    <button type="button" class="btn btn-sm btn-danger">&nbsp;</button><strong> NO hay stock</strong>
                                </div>
                            </div>
                            <table id="tablaDisponibles3" class="table table-striped table-bordered table-hover" width="100%">
                                <thead>
                                    <tr style="height:30px">
                                        <th style="text-align:left">Numero de Traslado<br /></th>
                                        <th style="text-align:left">OT<br /></th>
                                        <th style="text-align:left">Cliente</th>
                                        <th style="text-align:left">Marca Vehiculo</th>
                                        <th style="text-align:left">Modelo Vehiculo</th>
                                        <th style="text-align:left">Año</th>
                                        <th style="text-align:left">Fecha de Traslado</th>
                                        <th style="text-align:left">Bodega Origen</th>
                                        <th style="text-align:left">Bodega Destino</th>
                                        <th style="text-align:left">Referencias</th>
                                        @*<th style="text-align:left">Ubicacion de Repuesto</th>*@
                                        <th style="text-align:left">Acciones</th>
                                        
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
@*inputs*@
<div id="modal_listarUbicacion" class="modal fade bd-example-modal" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Ubicaciones del Repuesto</h4>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <input type="hidden" name="name" id="bodegah"/>
                    <input type="hidden" name="name" id="codigoh"/>
                    <table class="table table-striped table-bordered table-hover" id="tablaDetalleUbicacion">
                        @*id="tablaDetalleNumero">*@
                        <thead>
                            <tr>
                                <th style="text-align:center">Bodega</th>
                                <th style="text-align:center">Ubicación</th>
                                <th style="text-align:center">Notas Ubicación</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cerrarModalExito">Cerrar</button>
                <button type="button" class="btn btn-info" data-dismiss="modal" id="btnUbicacion" onclick="registrarUbicacion()" style="">Registrar Ubicacion</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/select2/js")
    <script src="~/Vendor/BootstrapMultiselect/multiselect.js"></script>
    <script src="~/Vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Vendor/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/Vendor/pdfmake/build/vfs_fonts.js"></script>
    <script src="~/Vendor/moment/min/moment.min.js"></script>
    <script src="~/Vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="~/Vendor/sweetalert/lib/sweet-alert.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#bodega').multiselect({
                includeSelectAllOption: true,
                maxHeight: 400,
                dropDown: true
            });
            $('#bodega2').multiselect({
                includeSelectAllOption: true,
                maxHeight: 400,
                dropDown: true
            });
            $('#bodega3').multiselect({
                includeSelectAllOption: true,
                maxHeight: 400,
                dropDown: true
            });
            buscarDisponibles();
            buscarDisponibles2();
            buscarDisponibles3();
            //buscarEstadoActual();

        var permiso='@ViewBag.Permiso';

        if (permiso == 'Si') {
            $('#btnUbicacion1').show();
            $('#btnUbicacion2').show();
            $('#btnUbicacion3').show();
        } else {
            $('#btnUbicacion1').hide();
            $('#btnUbicacion2').hide();
            $('#btnUbicacion3').hide();
        }

        });



        $('#botonbuscar').click(function () {
            $('#botonbuscar').prop('disabled', true);
            var asesor = $('#idasesor').val();
            var tipotrans = 1;
            buscarDisponibles();

        });

        $('#botonbuscar2').click(function () {
            $('#botonbuscar2').prop('disabled', true);
            var asesor = $('#idasesor').val();
            var tipotrans = 1;
            buscarDisponibles2();

        });


        $('#botonbuscar3').click(function () {
            $('#botonbuscar3').prop('disabled', true);
            var asesor = $('#idasesor').val();
            var tipotrans = 1;
            buscarDisponibles3();

        });


        function buscarDisponibles() {
         
            $("#tablaDisponibles").dataTable().fnDestroy();

            var tipoproceso = $('#tipos_proceso').val();
            var general = $('#txtFiltroGeneral').val();

            var table = $('#tablaDisponibles').DataTable({
                "processing": true,
                "serverSide": true,
                "filter": true,
                "orderMulti": false,
                "searching": false,
                dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                buttons: [
                    //{ extend: 'csv', title: 'ExampleFile', className: 'btn-sm', text: 'Exportar a Excel' }
                ],
                "ajax": {
                    "url": "/Almacen/filtroSolicitudesDespacho",
                    "type": "POST",
                    "datatype": "json",
                    "data": {
                        /* filtros: cadenaFiltro,
                         valorFiltros: cadenaValoresFiltro,*/
                        filtroGeneral: $('#txtFiltroGeneral').val(),
                        bodega: $('#bodega').val(),


                    }
                },
                "columns": [
                    { "data": "idstring", "name": "idstring", "autoWidth": true, className: "align-right" },
                    { "data": "codigoentrada", "name": "codigoentrada", "autoWidth": true },
                    { "data": "nombre", "name": "nombre", "autoWidth": true },
                    { "data": "marcvh_nombre", "name": "marcvh_nombre", "autoWidth": true },
                    { "data": "modvh_nombre", "name": "modvh_nombre", "autoWidth": true },
                    { "data": "anio_vh2", "name": "anio_vh2", "autoWidth": true },
                    { "data": "fecha2", "name": "fecha2", "autoWidth": true },
                    { "data": "tipodespacho", "name": "tipodespacho", "autoWidth": true },
                    { "data": "bodegaorigen", "name": "bodegaorigen", "autoWidth": true, className:"bodega1"},
                    { "data": "bodegadestino", "name": "bodegadestino", "autoWidth": true ,className:"bodega2"},
                    //{ "data": "descripcion", "name": "descripcion", "autoWidth": true },
                    {
                        "mData": null,
                        "bSortable": false,
                        "mRender": function (o) {
                            console.log(o);
                            var boton = "";
                            var texto = "";
                            if (o.referencias.length > 0) {
                                boton += "<table width='100%' class='table table-striped table-bordered table-hover'>";
                                boton += "<thead><tr><th>REFERENCIA</th><th>STOCK</th></tr></thead>";

                                for (var i = 0; i < o.referencias.length; i++) {
                                    var texto2 = "";
                                    if (o.referencias[i].stockbodega > 0) {
                                        texto2 = "<button type='button' class='btn btn-xs btn-success'>&nbsp;" + o.referencias[i].stockbodega + "&nbsp;</button>";
                                    }
                                    else if (o.referencias[i].stockbodega == 0 && o.referencias[i].stockreemplazo > 0) {
                                        texto2 = "<button type='button' class='btn btn-xs btn-warning'>&nbsp;" + o.referencias[i].stockreemplazo + "&nbsp;</button>";
                                    }
                                    else {
                                        texto2 = "<button type='button' class='btn btn-xs btn-danger'>&nbsp;0&nbsp;</button>";
                                    }
                                    texto += "<tr><td>" + o.referencias[i].ref_descripcion + "</td><td>" + texto2 + "</td></tr>";
                                }
                                boton += "<tbody>" + texto + "</tbody></table>";
                            }
                            console.log(boton);
                            //boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                            //                         + '\'' + o.idorden
                            //                          + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';

                            /*if (o.id_tipo_proceso == 1) {

                            }
                            else {
                                boton= '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                                                    + '\'' + o.id_vehiculo_tercero
                                                     + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';
                            }
                            if (o.reversar == 1) {
                                boton+='<button class="btn btn-danger btn-xs" onclick="reversar(event,'
                                                    + '\'' + o.id_vehiculo_tercero
                                                     + '\')">&nbsp;&nbsp;Reincorporar&nbsp;&nbsp;</button>';
                            }*/
                            return boton;
                        }
                    },
                    //{
                    //    "mData": null,
                    //    "bSortable": false,
                    //    "mRender": function (o) {
                    //        console.log(o);
                    //        var boton = "";
                    //        var texto = "";
                    //        if (o.referencias.length > 0) {

                    //            for (var i = 0; i < o.referencias.length; i++) {
                    //                texto += "<tr><td>" + o.referencias[i].ubicacion == 'null' || o.referencias[i].ubicacion == '' ? 'Ubicacion no asignada. \n' : o.referencias[i].ubicacion + "</td><td></td></tr>";
                    //            }
                    //            boton += "<tbody>" + texto + "</tbody></table>";
                    //        }
                    //        console.log(boton);
                    //        //boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                    //        //                         + '\'' + o.idorden
                    //        //                          + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';

                    //        /*if (o.id_tipo_proceso == 1) {

                    //        }
                    //        else {
                    //            boton= '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                    //                                + '\'' + o.id_vehiculo_tercero
                    //                                 + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';
                    //        }
                    //        if (o.reversar == 1) {
                    //            boton+='<button class="btn btn-danger btn-xs" onclick="reversar(event,'
                    //                                + '\'' + o.id_vehiculo_tercero
                    //                                 + '\')">&nbsp;&nbsp;Reincorporar&nbsp;&nbsp;</button>';
                    //        }*/
                    //        return boton;
                    //    }
                    //},
                    {
                        "mData": null,
                        "bSortable": false,
                        "mRender": function (o) {
                            //console.log("prueba")
                            var prueba = o.referencias[0];
                    
                            if (o.referencias.length > 0) {
                                debugger;
                                var referencia = prueba.idrepuesto;
                                var ref = referencia.toString();
                                console.log(ref);
                                var tipado = ref + "t";  
                              
                                var boton = "";
                                boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                                    + '\'' + o.id
                                    + '\')">&nbsp;&nbsp;Gestionar&nbsp;&nbsp;</button>'
                                    + '<br><button type="button" class="btn btn-info btn-xs" id="btnUbicacion1" onclick="verDetalles(' +"'"+tipado +"'"+ ',' + o.bodega + ');">Ubicación</button>';
                            } else {
                                var boton = "";
                                boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                                    + '\'' + o.id
                                    + '\')">&nbsp;&nbsp;Gestionar&nbsp;&nbsp;</button>'
                            }
                                                        


                            return boton;

                        }
                    }

                ]
            });

            var data = table.buttons.exportData();
            // Buscar filtros
            $('#botonbuscar').prop('disabled', false);

        }
        function buscarDisponibles2() {
        
            $("#tablaDisponibles2").dataTable().fnDestroy();

            var tipoproceso = $('#tipos_proceso2').val();
            var general = $('#txtFiltroGeneral2').val();

            var table = $('#tablaDisponibles2').DataTable({
                "processing": true,
                "serverSide": true,
                "filter": true,
                "orderMulti": false,
                "searching": false,
                dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                buttons: [
                    //{ extend: 'csv', title: 'ExampleFile', className: 'btn-sm', text: 'Exportar a Excel' }
                ],
                "ajax": {
                    "url": "/Almacen/filtroSolicitudesDespachoProcesado",
                    "type": "POST",
                    "datatype": "json",
                    "data": {
                        /* filtros: cadenaFiltro,
                         valorFiltros: cadenaValoresFiltro,*/
                        filtroGeneral: $('#txtFiltroGeneral2').val(),
                        bodega: $('#bodega2').val(),


                    }
                },
                "columns": [
                    { "data": "idstring", "name": "idstring", "autoWidth": true, className: "align-right" },
                    { "data": "codigoentrada", "name": "codigoentrada", "autoWidth": true },
                    { "data": "nombre", "name": "nombre", "autoWidth": true },
                    { "data": "marcvh_nombre", "name": "marcvh_nombre", "autoWidth": true },
                    { "data": "modvh_nombre", "name": "modvh_nombre", "autoWidth": true },
                    { "data": "anio_vh2", "name": "anio_vh2", "autoWidth": true },
                    { "data": "fecha2", "name": "fecha2", "autoWidth": true },
                    { "data": "tipodespacho", "name": "tipodespacho", "autoWidth": true },
                    { "data": "bodegaorigen", "name": "bodegaorigen", "autoWidth": true },
                    { "data": "bodegadestino", "name": "bodegadestino", "autoWidth": true },
                    //{ "data": "bodegaorigen", "name": "bodegaorigen", "autoWidth": true },
                    {
                        "mData": null,
                        "bSortable": false,
                        "mRender": function (o) {
                            console.log(o);
                            var boton = "";
                            var texto = "";
                            if (o.referencias.length > 0) {
                                boton += "<table width='100%' class='table table-striped table-bordered table-hover'>";
                                boton += "<thead><tr><th>REFERENCIA</th><th>STOCK</th></tr></thead>";

                                for (var i = 0; i < o.referencias.length; i++) {
                                    var texto2 = "";
                                    if (o.referencias[i].stockbodega > 0) {
                                        texto2 = "<button type='button' class='btn btn-xs btn-success'>&nbsp;" + o.referencias[i].stockbodega + "&nbsp;</button>";
                                    }
                                    else if (o.referencias[i].stockbodega == 0 && o.referencias[i].stockreemplazo > 0) {
                                        texto2 = "<button type='button' class='btn btn-xs btn-warning'>&nbsp;" + o.referencias[i].stockreemplazo + "&nbsp;</button>";
                                    }
                                    else {
                                        texto2 = "<button type='button' class='btn btn-xs btn-danger'>&nbsp;0&nbsp;</button>";
                                    }
                                    texto += "<tr><td>" + o.referencias[i].ref_descripcion+"</td><td>" + texto2 + "</td></tr>";
                                }
                                boton += "<tbody>" + texto + "</tbody></table>";
                            }
                            console.log(boton);
                            //boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                            //                         + '\'' + o.idorden
                            //                          + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';

                            /*if (o.id_tipo_proceso == 1) {

                            }
                            else {
                                boton= '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                                                    + '\'' + o.id_vehiculo_tercero
                                                     + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';
                            }
                            if (o.reversar == 1) {
                                boton+='<button class="btn btn-danger btn-xs" onclick="reversar(event,'
                                                    + '\'' + o.id_vehiculo_tercero
                                                     + '\')">&nbsp;&nbsp;Reincorporar&nbsp;&nbsp;</button>';
                            }*/
                            return boton;
                        }
                    },
                    //{
                    //    "mData": null,
                    //    "bSortable": false,
                    //    "mRender": function (o) {
                    //        console.log(o);
                    //        var boton = "";
                    //        var texto = "";
                    //        if (o.referencias.length > 0) {

                    //            for (var i = 0; i < o.referencias.length; i++) {
                    //                texto += "<tr><td>" + o.referencias[i].ubicacion =='null' || o.referencias[i].ubicacion =='' ? 'Ubicacion no asignada. \n' : o.referencias[i].ubicacion + "</td><td></td></tr>";
                    //            }
                    //            boton += "<tbody>" + texto + "</tbody></table>";
                    //        }
                    //        console.log(boton);
                    //        //boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                    //        //                         + '\'' + o.idorden
                    //        //                          + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';

                    //        /*if (o.id_tipo_proceso == 1) {

                    //        }
                    //        else {
                    //            boton= '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                    //                                + '\'' + o.id_vehiculo_tercero
                    //                                 + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';
                    //        }
                    //        if (o.reversar == 1) {
                    //            boton+='<button class="btn btn-danger btn-xs" onclick="reversar(event,'
                    //                                + '\'' + o.id_vehiculo_tercero
                    //                                 + '\')">&nbsp;&nbsp;Reincorporar&nbsp;&nbsp;</button>';
                    //        }*/
                    //        return boton;
                    //    }
                    //},
                    {
                        "mData": null,
                        "bSortable": false,
                        "mRender": function (o) {
                            var prueba = o.referencias[0];
                            //console.log(prueba);


                            if (o.referencias.length > 0) {
                                var referencia = prueba.idrepuesto;
                                var ref = referencia.toString();


                                console.log(ref);
                                var tipado = ref+"t"  
                                var boton = "";
                                boton = '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                                    + '\'' + o.id
                                    + '\')">&nbsp;&nbsp;Gestionar&nbsp;&nbsp;</button>'
                                    + '<br><button type="button" class="btn btn-info btn-xs" id="btnUbicacion2" onclick="verDetalles(' +"'"+tipado +"'"+ ',' + o.bodega + ');">Ubicación</button>';
                            } else {
                                 var boton = "";
                                boton = '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                                    + '\'' + o.id
                                    + '\')">&nbsp;&nbsp;Gestionar&nbsp;&nbsp;</button>';
                            }
                            return boton;
                        }
                    }
                ]
            });

            var data = table.buttons.exportData();
            // Buscar filtros
            $('#botonbuscar2').prop('disabled', false);

        }
        var b;
        var c;
        function registrarUbicacion() {
            var dataBogeda  =String(b);
            var idreferencia = String(c);


            if (dataBogeda != '' && idreferencia != '') {
                let URL = "../../ubirpto?cadena=" + dataBogeda + "," + idreferencia + "";
                window.open(URL, "_blank");
            }

        }


        function verDetalles(codigo, bodega) {
            console.log(" detalles ... ");
            var cod = codigo.slice(0, -1);


            var bod = String(bodega);
            var cod2 = String(cod);

            b = bod;
            c = cod2;
            
            console.log(cod2)

            $('#tablaDetalleUbicacion').dataTable().fnDestroy();
            $.ajax({
                url: '/kardex/listarUbicacion',
                data: {
                    codigo: cod2,
                    bodega: bodega,
                },
                type: 'post',
                dataType: 'json',
                cache: false,
                success: function (data) {
                    $("#modal_listarUbicacion").modal('show'); //modal_listarDetalle_cartera     $("#modal_listarTerceros").modal('show'); //modal_listarDetalle_cartera
                    $('#tablaDetalleUbicacion').dataTable().fnDestroy();
                    $('#tablaDetalleUbicacion').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        console.log(data)
                        $('#tablaDetalleUbicacion').find('tbody').empty();
                        for (var i = 0; i < data.length; i++) {
                            $('#tablaDetalleUbicacion').find('tbody').append
                                ('<tr align="center">' +
                                '<td align="left">' + data[i].bodccs_nombre + '</td>' +
                                '<td align="left">' + (data[i].descripcion!=null ? data[i].descripcion : "No asignada") + '</td>' +
                                '<td align="left">' + (data[i].notaUbicacion !=null ? data[i].descripcion : "No asignada") + '</td>' +
                                '</tr>'
                        );
                        }
                    }
                },
                complete: function (data) {
                    $('#tablaDetalleUbicacion').dataTable({
                        //"ajax": 'api/datatables.json',
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: [
                            { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                            //{ extend: 'pdf', title: 'ExampleFile', className: 'btn-sm', text: 'PDF' },
                            //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                        ]
                    });
                }
            })

        }

        function buscarDisponibles3() {
       
            $("#tablaDisponibles3").dataTable().fnDestroy();

            var tipoproceso = $('#tipos_proceso3').val();
            var general = $('#txtFiltroGeneral3').val();

            var table = $('#tablaDisponibles3').DataTable({
                "processing": true,
                "serverSide": true,
                "filter": true,
                "orderMulti": false,
                "searching": false,
                dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                buttons: [
                    //{ extend: 'csv', title: 'ExampleFile', className: 'btn-sm', text: 'Exportar a Excel' }
                ],
                "ajax": {
                    "url": "/Almacen/filtroTrasladoSinProcesar",
                    "type": "POST",
                    "datatype": "json",
                    "data": {
                        /* filtros: cadenaFiltro,
                         valorFiltros: cadenaValoresFiltro,*/
                        filtroGeneral: $('#txtFiltroGeneral3').val(),
                        bodega: $('#bodega3').val(),


                    }
                },
                "columns": [
                    { "data": "idstring", "name": "idstring", "autoWidth": true, className: "align-right" },
                    { "data": "codigoentrada", "name": "codigoentrada", "autoWidth": true },
                    { "data": "nombre", "name": "nombre", "autoWidth": true },
                    { "data": "marcvh_nombre", "name": "marcvh_nombre", "autoWidth": true },
                    { "data": "modvh_nombre", "name": "modvh_nombre", "autoWidth": true },
                    { "data": "anio_vh2", "name": "anio_vh2", "autoWidth": true },
                    { "data": "fecha2", "name": "fecha2", "autoWidth": true },
                    { "data": "bodegaorigen", "name": "bodegaorigen", "autoWidth": true },
                    { "data": "bodegadestino", "name": "bodegadestino", "autoWidth": true },
                    //{ "data": "bodegaorigen", "name": "bodegaorigen", "autoWidth": true },
                    {
                        "mData": null,
                        "bSortable": false,
                        "mRender": function (o) {
                            console.log(o);
                            var boton = "";
                            var texto = "";
                            if (o.referencias.length > 0) {
                                boton += "<table width='100%' class='table table-striped table-bordered table-hover'>";
                                boton += "<thead><tr><th>REFERENCIA</th><th>STOCK</th></tr></thead>";

                                for (var i = 0; i < o.referencias.length; i++) {
                                    var texto2 = "";
                                    if (o.referencias[i].stockbodega > 0) {
                                        texto2 = "<button type='button' class='btn btn-xs btn-success'>&nbsp;" + o.referencias[i].stockbodega + "&nbsp;</button>";
                                    }
                                    else if (o.referencias[i].stockbodega == 0 && o.referencias[i].stockreemplazo > 0) {
                                        texto2 = "<button type='button' class='btn btn-xs btn-warning'>&nbsp;" + o.referencias[i].stockreemplazo + "&nbsp;</button>";
                                    }
                                    else {
                                        texto2 = "<button type='button' class='btn btn-xs btn-danger'>&nbsp;0&nbsp;</button>";
                                    }
                                    texto += "<tr><td>" + o.referencias[i].ref_descripcion + "</td><td>" + texto2 + "</td></tr>";

                                }
                                boton += "<tbody>" + texto + "</tbody></table>";
                            }
                            console.log(boton);
                            //boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                            //                         + '\'' + o.idorden
                            //                          + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';

                            /*if (o.id_tipo_proceso == 1) {

                            }
                            else {
                                boton= '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                                                    + '\'' + o.id_vehiculo_tercero
                                                     + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';
                            }
                            if (o.reversar == 1) {
                                boton+='<button class="btn btn-danger btn-xs" onclick="reversar(event,'
                                                    + '\'' + o.id_vehiculo_tercero
                                                     + '\')">&nbsp;&nbsp;Reincorporar&nbsp;&nbsp;</button>';
                            }*/
                            return boton;
                        }
                    },
                    //{
                    //    "mData": null,
                    //    "bSortable": false,
                    //    "mRender": function (o) {
                    //        console.log(o);
                    //        var boton = "";
                    //        var texto = "";
                    //        if (o.referencias.length > 0) {

                    //            for (var i = 0; i < o.referencias.length; i++) {
                    //                texto += "<tr><td>" + o.referencias[i].ubicacion =='null' || o.referencias[i].ubicacion =='' ? 'Ubicacion no asignada. \n' : o.referencias[i].ubicacion + "</td><td></td></tr>";
                    //            }
                    //            boton += "<tbody>" + texto + "</tbody></table>";
                    //        }
                    //        console.log(boton);
                    //        //boton = '<button class="btn btn-info btn-xs" onclick="verDetalle('
                    //        //                         + '\'' + o.idorden
                    //        //                          + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';

                    //        /*if (o.id_tipo_proceso == 1) {

                    //        }
                    //        else {
                    //            boton= '<button class="btn btn-info btn-xs" onclick="verDetalle2('
                    //                                + '\'' + o.id_vehiculo_tercero
                    //                                 + '\')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>';
                    //        }
                    //        if (o.reversar == 1) {
                    //            boton+='<button class="btn btn-danger btn-xs" onclick="reversar(event,'
                    //                                + '\'' + o.id_vehiculo_tercero
                    //                                 + '\')">&nbsp;&nbsp;Reincorporar&nbsp;&nbsp;</button>';
                    //        }*/
                    //        return boton;
                    //    }
                    //},
                    {
                        "mData": null,
                        "bSortable": false,
                        "mRender": function (o) {
                            //console.log("prueba")
                            var prueba = o.referencias[0];
                          
                            if (o.referencias.length > 0) {
                                var referencia = prueba.idrepuesto;
                                var ref = referencia.toString();
                                console.log('prueba2');
                                console.log(ref);
                                var tipado = ref+"t"  
                               
                                var boton = "";
                                boton = '<button class="btn btn-info btn-xs" onclick="verDetalle3('
                                    + '\'' + o.idstring
                                    + '\')">&nbsp;&nbsp;Gestionar&nbsp;&nbsp;</button>'
                                    + '<br><button type="button" class="btn btn-info btn-xs" id="btnUbicacion3" onclick="verDetalles(' +"'"+tipado +"'"+ ',' + o.bodega + ');">Ubicación</button>';
                            } else {
                                var boton = "";
                                boton = '<button class="btn btn-info btn-xs" onclick="verDetalle3('
                                    + '\'' + o.idstring
                                    + '\')">&nbsp;&nbsp;Gestionar&nbsp;&nbsp;</button>';
                            }


                            return boton;
                        }
                    }
                ]
            });

            var data = table.buttons.exportData();
            // Buscar filtros
            $('#botonbuscar3').prop('disabled', false);

        }



        function verDetalle(idorden) {
            debugger;
            window.location.href = '@Url.Action("procesarOrdenDespacho","Almacen")?menu='+@ViewBag.id_menu+'&&id=' +idorden;
        }

        function verDetalle3(idorden) {
          
            window.location.href = '@Url.Action("procesarOrdenTraslado","Almacen")?menu='+@ViewBag.id_menu+'&&id=' +idorden;
        }

        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + '.' + '$2');
            }
            return x1 + x2;
        }
    </script>

}








