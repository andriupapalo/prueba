@{
    ViewBag.Icono = "fa fa-cubes";
    ViewBag.Title = "Consulta Item Inventario";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    @Styles.Render("~/bundles/select2/css")
    <link href="~/Vendor/BootstrapMultiselect/multiselect.css" rel="stylesheet" />
    <link href="~/Vendor/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Vendor/bootstrap-toggle-master/css/bootstrap-toggle.min.css" rel="stylesheet" />
    <link href="~/Vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/Vendor/sweetalert/lib/sweet-alert.css" />
    <link href="~/Vendor/EasyAutocomplete-1.3.5/easy-autocomplete.min.css" rel="stylesheet" />
    <link href="~/Vendor/EasyAutocomplete-1.3.5/easy-autocomplete.themes.min.css" rel="stylesheet" />
}

<div class="panel-body">
    <div class="panel-heading" style="background-color:white;  border:solid 1px; border-color:#e4e5e7">
        <div class="panel-body">

            <div id="hbreadcrumb" class="pull-right">

                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Enlaces" data-content="<ul>@ViewBag.nombreEnlaces</ul>" data-html="true">
                    <i class="text-info fa fa-tags"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Documentos" data-content="<ul></i><a href=''>Documento 1</a></ul>  <ul></i><a href=''>Documento 2</a></ul> <ul></i><a href=''>Documento 3</a></ul>" data-html="true">
                    <i class="text-primary fa fa-files-o"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Favoritos" data-content="@ViewBag.Favoritos" data-html="true">
                    <i class="text-warning fa fa-star"></i>
                </button>

            </div>
            <h3 class="font-light m-b-xs">
                <i class="text-info @ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title
            </h3>
            <small>Registro @ViewBag.Title</small>
        </div>
    </div>
</div>

<div class="panel-body" style="padding-top:0px;">
    <div class="hpanel">
        @if (TempData["mensaje"] != null)
        {
            <div class="alert alert-success  alert-dismissible" id="mensaje">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p>@TempData["mensaje"]</p>
            </div>
        }

        @if (TempData["mensaje_error"] != null)
        {
            <div class="alert alert-danger  alert-dismissible" id="mensaje_error">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p>@TempData["mensaje_error"]</p>
            </div>
        }

        <div id="tabs" class="tab-content">

            <div class="m float-e-margins text-right">
                <div class="tooltip-demo">

                    <div id="div-mensaje"></div>

                </div>
            </div>

            <ul id="tabs-crear" class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#crear"><i class="@ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title</a></li>
                <li class="tabOculto" style="display:none"><a data-toggle="tab" href="#historial"><i class="fa fa-clone"></i>&nbsp;&nbsp;Historial</a></li>
                <li class="tabOculto" style="display:none"><a data-toggle="tab" href="#ordenCompra"><i class="fa fa-pencil-square-o"></i>&nbsp;&nbsp;Orden Compra</a></li>
                <li class="tabOculto" style="display:none"><a data-toggle="tab" href="#pedidos"><i class="fa fa-book"></i>&nbsp;&nbsp;Pedidos</a></li>
            </ul>

            <div id="crear" class="tab-pane active">
                <div class="panel-body">


                    @Html.AntiForgeryToken()
                    @Html.Hidden("menu")

                    <div class="form-horizontal">

                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                        <div class="hpanel">
                            <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                                <div class="panel-tools">
                                    <a class="showhide"><i class="fa fa-chevron-up"></i></a>

                                </div>
                                <i class="@ViewBag.Icono"></i>&nbsp;&nbsp;&nbsp;Datos generales
                            </div>
                            <div class="panel-body">

                                <form id="Referenceform" onsubmit="return false" method="post" name="myForm">

                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Referencia:&nbsp;<span class="text-danger">*</span></label>
                                            <div class="col-md-6">
                                                <input type="hidden" name="banderaCodigo" id="banderaCodigo" value="" />
                                                <input id="referencia" name="referencia" placeholder="Seleccione" class="form-control" onkeyup="traerReferencias(this.id)" />
                                                @*@Html.DropDownList("referencia", null, "", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione", @required = "required" })*@
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label class="control-label col-md-4">Bodega(s):&nbsp;<span class="text-danger">*</span></label>
                                            <div class="col-md-6">
                                                <select id="bodccs_cod" name="bodccs_cod" multiple="multiple" required>
                                                    @foreach (var item in ViewBag.bodccs_cod)
                                                    {
                                                        <option value="@item.id">@item.bodccs_nombre</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    @*<div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Fecha Inicial:&nbsp;<span class="text-danger">*</span></label>
                                                <div class="col-md-6">
                                                    @Html.Editor("fechaInicial", new { htmlAttributes = new { @class = "form-control campoFecha", @required = "required", @placeholder = "Digite fecha" } })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Fecha Final:&nbsp;<span class="text-danger">*</span></label>
                                                <div class="col-md-6">
                                                    @Html.Editor("fechaFinal", new { htmlAttributes = new { @class = "form-control campoFecha", @required = "required", @placeholder = "Digite fecha" } })
                                                </div>
                                            </div>
                                        </div>*@

                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <div class="col-md-6 col-md-offset-4">
                                                <button type="submit" class="btn btn-primary" id="btnBuscarReferencia"><i class="fa fa-search"></i>&nbsp;&nbsp;Buscar</button>
                                            </div>
                                        </div>
                                    </div>

                                </form>

                            </div>
                        </div>



                        <div class="hpanel panelBusquedaReferencia" style="display:none;">
                            <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                                <div class="panel-tools">
                                    <a class="showhide"><i class="fa fa-chevron-up"></i></a>

                                </div>
                                <i class="fa fa-cogs"></i>&nbsp;&nbsp;&nbsp;Datos referencia
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <div id="div-mensaje-buscar"></div>
                                    <table class="table table-striped table-bordered table-hover" id="tablaStock">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">Código</th>
                                                <th style="text-align:center">Nombre</th>
                                                <th style="text-align:center">Bodega</th>
                                                <th style="text-align:center">Cantidad Comprometida</th>
                                                <th style="text-align:center">Precio Venta</th>
                                                <th style="text-align:center">Movimiento Clacificación ABC</th>
                                                <th style="text-align:center">Rotaci&oacute;n Referencia</th>
                                                <th style="text-align:center">Costo Promedio</th>
                                                <th style="text-align:center">Precio Compra</th>
                                                <th style="text-align:center">Stock</th>
                                                <th style="text-align:center">Precio Compra Emergencia</th>
                                                <th style="text-align:center">Ubicación</th>
                                                <th style="text-align:center">Reemplazo</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
            <div id="historial" class="tab-pane">
                <div class="panel-body">

                    <div class="hpanel">
                        <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                            <div class="panel-tools">
                                <a class="showhide"><i class="fa fa-chevron-up"></i></a>

                            </div>
                            <i class="fa fa-usd"></i>&nbsp;&nbsp;&nbsp;Datos historial
                        </div>
                        <div class="panel-body">

                            <div class="row">
                                <div class="col-sm-6 col-md-offset-3">
                                    <div class="form-group">
                                        <div class="col-md-7">
                                            <div class="input-group m-b">
                                                @Html.Editor("fechaInicial", new { htmlAttributes = new { @class = "form-control campoFecha", @placeholder = "Fecha Desde" } })
                                                <span class="input-group-addon">-</span>
                                                @Html.Editor("fechaFinal", new { htmlAttributes = new { @class = "form-control campoFecha", @placeholder = "Fecha Hasta" } })
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-primary" id="btnBuscarHistorial"><i class="fa fa-search">&nbsp;&nbsp;Buscar</i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-body-busqueda">
                                <div class="table-responsive">
                                    <div id="div-mensaje-buscar"></div>
                                    <table class="table table-striped table-bordered table-hover" id="tablaHistorial">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">Tipo Documento</th>
                                                <th style="text-align:center">Numero</th>
                                                <th style="text-align:center">Tercero</th>
                                                <th style="text-align:center">Bodega</th>
                                                <th style="text-align:center">Fecha</th>
                                                <th style="text-align:center">Cantidad</th>
                                                <th style="text-align:center">Costo Unitario</th>
                                                <th style="text-align:center">Costo Total</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                            </div>

                        </div>
                    </div>

                </div>
            </div>
            <div id="ordenCompra" class="tab-pane">
                <div class="panel-body">

                    <div class="hpanel">
                        <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                            <div class="panel-tools">
                                <a class="showhide"><i class="fa fa-chevron-up"></i></a>

                            </div>
                            <i class="fa fa-pencil-square-o"></i>&nbsp;&nbsp;&nbsp;Datos Ordenes de Compra
                        </div>
                        <div class="panel-body">

                            <div class="row">
                                <div class="col-sm-6 col-md-offset-3">
                                    <div class="form-group">
                                        <div class="col-md-7">
                                            <div class="input-group m-b">
                                                @Html.Editor("fechaInicialOrdenes", new { htmlAttributes = new { @class = "form-control campoFecha", @placeholder = "Fecha Desde" } })
                                                <span class="input-group-addon">-</span>
                                                @Html.Editor("fechaFinalOrdenes", new { htmlAttributes = new { @class = "form-control campoFecha", @placeholder = "Fecha Hasta" } })
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-primary" id="btnBuscarOrdenesCompra"><i class="fa fa-search">&nbsp;&nbsp;Buscar</i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-body-busqueda">
                                <div class="table-responsive">
                                    <div id="div-mensaje-buscar"></div>
                                    <table class="table table-striped table-bordered table-hover" id="tablaOrdenes">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">Tipo Documento</th>
                                                <th style="text-align:center">Numero</th>
                                                <th style="text-align:center">Fecha</th>
                                                <th style="text-align:center">Bodega</th>
                                                <th style="text-align:center">Tipo Compra</th>
                                                <th style="text-align:center">Proveedor</th>
                                                <th style="text-align:center">Destinatario</th>
                                                <th style="text-align:center">Vendedor</th>
                                                <th style="text-align:center">Valor Unitario</th>
                                                <th style="text-align:center">Cantidad</th>
                                                <th style="text-align:center">% Descuento</th>
                                                <th style="text-align:center">% Iva</th>
                                                <th style="text-align:center">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
            <div id="pedidos" class="tab-pane">
                <div class="panel-body">

                    <div class="hpanel">
                        <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                            <div class="panel-tools">
                                <a class="showhide"><i class="fa fa-chevron-up"></i></a>

                            </div>
                            <i class="fa fa-book"></i>&nbsp;&nbsp;&nbsp;Datos Pedidos
                        </div>
                        <div class="panel-body">

                            <div class="row">
                                <div class="col-sm-6 col-md-offset-3">
                                    <div class="form-group">
                                        <div class="col-md-7">
                                            <div class="input-group m-b">
                                                @Html.Editor("fechaInicialPedidos", new { htmlAttributes = new { @class = "form-control campoFecha", @placeholder = "Fecha Desde" } })
                                                <span class="input-group-addon">-</span>
                                                @Html.Editor("fechaFinalPedidos", new { htmlAttributes = new { @class = "form-control campoFecha", @placeholder = "Fecha Hasta" } })
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-primary" id="btnBuscarPedidos"><i class="fa fa-search">&nbsp;&nbsp;Buscar</i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-body-busqueda">
                                <div class="table-responsive">
                                    <div id="div-mensaje-buscar"></div>
                                    <table class="table table-striped table-bordered table-hover" id="tablaPedidos">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">Tipo Documento</th>
                                                <th style="text-align:center">Numero</th>
                                                <th style="text-align:center">Fecha</th>
                                                <th style="text-align:center">Bodega</th>
                                                <th style="text-align:center">Documento Cliente</th>
                                                <th style="text-align:center">Cliente</th>
                                                <th style="text-align:center">Condicion Pago</th>
                                                <th style="text-align:center">Cantidad</th>
                                                <th style="text-align:center">Valor Unitario</th>
                                                <th style="text-align:center">% Descuento</th>
                                                <th style="text-align:center">% Iva</th>
                                                <th style="text-align:center">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
            <div id="modal_listarUbicacion" class="modal fade bd-example-modal" tabindex="-1" aria-hidden="true" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="color-line"></div>
                        <div class="modal-header text-center">
                            <h4 class="modal-title">Ubicaciones del Repuesto</h4>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover" id="tablaDetalleUbicacion">
                                    @*id="tablaDetalleNumero">*@
                                    <thead>
                                        <tr>
                                            <th style="text-align:center">Bodega</th>
                                            <th style="text-align:center">Ubicaci&oacute;n</th>
                                            <th style="text-align:center">&Aacute;rea</th>
                                            <th style="text-align:center">Notas de Ubicación</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cerrarModalExito">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal_listarReemplazos" class="modal fade bd-example-modal" tabindex="-1" aria-hidden="true" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="color-line"></div>
                        <div class="modal-header text-center">
                            <h4 class="modal-title">Reemplazos</h4>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover" id="tablaDetalleReemplazo">
                                    <thead>
                                        <tr>
                                            <th style="text-align:center">Código</th>
                                            <th style="text-align:center">Descripción</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cerrarModalExito">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/select2/js")
    <script src="~/Vendor/BootstrapMultiselect/multiselect.js"></script>
    <script src="~/Vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Vendor/datatablesExcelExport/dataTable1.4.0-buttons.js"></script>
    <script src="~/Vendor/datatablesExcelExport/JSZip3.1.3.min.js"></script>
    <script src="~/Vendor/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/Vendor/pdfmake/build/vfs_fonts.js"></script>
    <script src="~/Vendor/datatablesExcelExport/jsZipDataTables.js"></script>
    <script src="~/Vendor/bootstrap-toggle-master/js/bootstrap-toggle.min.js"></script>
    <script src="~/Vendor/moment/min/moment.min.js"></script>
    <script src="~/Vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="~/Vendor/EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script>

    <script type="text/javascript">

        $(document).ready(function () {
            //$('#referencia').select2();
            $('.campoFecha').datetimepicker({
                format: 'YYYY/MM/DD'
            });
            $('#bodccs_cod').multiselect({
                includeSelectAllOption: true,
                maxHeight: 400,
                enableFiltering: true,
                enableCaseInsensitiveFiltering: true
            });

            var referencias = {
                data: []
            };
            $("#referencia").easyAutocomplete(referencias);
        });

        function getReferenceCodeOnly(cadena) { // :V
            var code = '';
            if (cadena.indexOf('|') > -1) {
                code = cadena.split("|")[0].trim();
            }
            return code;
        }

        function traerReferencias(id) {
            var conteo_caracteres = $('#' + id).val().length;

            if (conteo_caracteres == 2) {
                $.ajax({
                    url: '/kardex/traerReferencias',
                    data: {
                        referencia: $('#' + id).val()
                    },
                    type: "post",
                    cache: false,
                    success: function (data) {
                        var referencias = {
                            data: data,
                            list: {
                                match: {
                                    enabled: true
                                }
                            }
                        };
                        $("#referencia").easyAutocomplete(referencias);
                        $("#referencia").focus();
                    }
                });
            }

        }


        $('#Referenceform').submit(function () {
            event.preventDefault();
        });


        // Area para que las fechas no cambien de un panel a otro
        $('#fechaInicialOrdenes').blur(function () {
            $('#fechaInicial').val($('#fechaInicialOrdenes').val());
            $('#fechaInicialPedidos').val($('#fechaInicialOrdenes').val());
        });
        $('#fechaFinalOrdenes').blur(function () {
            $('#fechaFinal').val($('#fechaFinalOrdenes').val());
            $('#fechaFinalPedidos').val($('#fechaFinalOrdenes').val());
        });
        $('#fechaInicial').blur(function () {
            $('#fechaInicialOrdenes').val($('#fechaInicial').val());
            $('#fechaInicialPedidos').val($('#fechaInicial').val());
        });
        $('#fechaFinal').blur(function () {
            $('#fechaFinalOrdenes').val($('#fechaFinal').val());
            $('#fechaFinalPedidos').val($('#fechaFinal').val());
        });
        $('#fechaInicialPedidos').blur(function () {
            $('#fechaInicialOrdenes').val($('#fechaInicialPedidos').val());
            $('#fechaInicial').val($('#fechaInicialPedidos').val());
        });
        $('#fechaFinalPedidos').blur(function () {
            $('#fechaFinalOrdenes').val($('#fechaFinalPedidos').val());
            $('#fechaFinal').val($('#fechaFinalPedidos').val());
        });




        function buscarPedidos() {
            $('#tablaPedidos').dataTable().fnDestroy();
            $.ajax({
                url: '/itemInventario/BuscarPedidos',
                data: {
                    codigo: getReferenceCodeOnly( $('#referencia').val() ),
                    bodegas: $('#bodccs_cod').val(),
                    fechaInicial: $('#fechaInicialPedidos').val(),
                    fechaFinal: $('#fechaFinalPedidos').val()
                },
                type: "post",
                cache: false,
                success: function (data) {

                    $('#tablaPedidos').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        $('#tablaPedidos').find('tbody').append('<tr><td align="left">' + data[i].tpdoc_nombre + '</td><td align="right">' + data[i].refmov_numero + '</td><td align="left">'
                            + data[i].refmov_fecela + '</td><td align="left">'
                            + data[i].bodccs_nombre + '</td><td align="left">'
                            + data[i].docCliente + '</td><td align="left">'
                            + data[i].cliente + '</td><td align="left">'
                            + data[i].fpago_nombre + '</td><td align="right">'
                            + data[i].refdet_cantidad + '</td><td align="right">'
                            + addComas(data[i].valor_unitario) + '</td><td align="right">'
                            + data[i].pordscto + '</td><td align="right">'
                            + data[i].poriva + '</td><td align="right">'
                            + addComas(data[i].total) + '</td></tr>');
                    }
                    $('#tablaPedidos').dataTable({
                        //"ajax": 'api/datatables.json',
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: [
                            { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                            //{ extend: 'pdf', title: 'ExampleFile', className: 'btn-sm', text: 'PDF' },
                            //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                        ]
                    });
                }
            })
        }

        $('#btnBuscarPedidos').click(function () {
            buscarPedidos();
            buscarHistorial();
            buscarOrdenesCompra();
        });



        function buscarOrdenesCompra() {
            $('#tablaOrdenes').dataTable().fnDestroy();
            $.ajax({
                url: '/itemInventario/BuscarOrdenesCompra',
                data: {
                    codigo: getReferenceCodeOnly( $('#referencia').val() ),
                    bodegas: $('#bodccs_cod').val(),
                    fechaInicial: $('#fechaInicial').val(),
                    fechaFinal: $('#fechaFinal').val()
                },
                type: "post",
                cache: false,
                success: function (data) {

                    $('#tablaOrdenes').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        $('#tablaOrdenes').find('tbody').append('<tr><td align="left">' + data[i].tpdoc_nombre + '</td><td align="left">' + data[i].numero + '</td><td align="left">'
                            + data[i].fec_creacion + '</td><td align="left">'
                            + data[i].bodccs_nombre + '</td><td align="left">'
                            + data[i].descripcion + '</td><td align="left">'
                            + data[i].proveedor + '</td><td align="left">'
                            + data[i].destinatario + '</td><td align="left">'
                            + data[i].vendedor + '</td><td align="left">'
                            + addComas(data[i].valorunitario) + '</td><td align="left">'
                            + data[i].cantidad + '</td><td align="left">'
                            + data[i].porcendescto + '</td><td align="left">'
                            + data[i].porceniva + '</td><td align="left">'
                            + addComas(data[i].total) + '</td></tr>');
                    }
                    $('#tablaOrdenes').dataTable({
                        //"ajax": 'api/datatables.json',
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: [
                            { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                            //{ extend: 'pdf', title: 'ExampleFile', className: 'btn-sm', text: 'PDF' },
                            //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                        ]
                    });
                }
            })
        }

        $('#btnBuscarOrdenesCompra').click(function () {
            buscarOrdenesCompra();
            buscarHistorial();
            buscarPedidos();
        });





        function buscarHistorial() {
            $('#tablaHistorial').dataTable().fnDestroy();
            $.ajax({
                url: '/itemInventario/BuscarHistorial',
                data: {
                    codigo: getReferenceCodeOnly( $('#referencia').val() ),
                    bodegas: $('#bodccs_cod').val(),
                    fechaInicial: $('#fechaInicial').val(),
                    fechaFinal: $('#fechaFinal').val()
                },
                type: "post",
                cache: false,
                success: function (data) {

                    $('#tablaHistorial').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        $('#tablaHistorial').find('tbody').append('<tr><td align="left">' + data[i].documento + '</td><td align="left">' + data[i].numero + '</td><td align="left">'
                            + data[i].tercero + '</td><td align="left">'
                            + data[i].bodccs_nombre + '</td><td align="left">' + data[i].fec + '</td><td align="left">'
                            + data[i].cantidad + '</td><td align="left">' + addComas(data[i].costo_unitario) + '</td><td align="left">'
                            + addComas(data[i].costoTotal) + '</td></tr>');
                    }
                    $('#tablaHistorial').dataTable({
                        //"ajax": 'api/datatables.json',
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: [
                            { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                            //{ extend: 'pdf', title: 'ExampleFile', className: 'btn-sm', text: 'PDF' },
                            //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                        ]
                    });
                }
            })
        }

        $('#btnBuscarHistorial').click(function () {
            buscarHistorial();
            buscarOrdenesCompra();
            buscarPedidos();
        });

        $('#btnBuscarReferencia').click(function () {
            var code = $('#referencia').val();
            if ((code.indexOf('|') > -1) || (j !== "" && j !== undefined)) {
                var codigo = "";
                if (code != "") {
                    var codigo_arr = $('#referencia').val().split("|");
                    codigo = codigo_arr[0].trim();
                }
                $.ajax({
                    url: '/itemInventario/BuscarCodigoReferencia',
                    data: {
                        codigo: codigo,
                        bodegas: $('#bodccs_cod').val()
                    },
                    type: "post",
                    cache: false,
                    success: function (data) {
                        if (data.tipoReferencia == 'R') {
                            $('#lbCodigo').text(data.buscarReferencia.ref_codigo)
                            $('#lbDescripcion').text(data.buscarReferencia.ref_descripcion)
                            $('#lbPorcentajeIva').text(data.buscarReferencia.por_iva)
                            $('#lbPorcentajeIvaCompra').text(data.buscarReferencia.por_iva_compra)
                            $('#lbUnidadMedida').text(data.buscarReferencia.unidad_medida)
                            $('#lbProveedor').text(data.buscarReferencia.proveedor)
                            $('#lbClasificacion').text(data.buscarReferencia.clasificacion_ABC)
                            $('.areaVehiculo').hide();
                            $('.areaRepuesto').show();
                            $('.panelBusquedaReferencia').show();
                        } else {
                            $('#lbCodigo').text(data.buscarReferencia.ref_codigo)
                            $('#lbDescripcion').text(data.buscarReferencia.ref_descripcion)
                            $('#lbProveedor').text(data.buscarReferencia.proveedor)
                            $('#lbSerie').text(data.buscarReferencia.vin)
                            $('#lbPlaca').text(data.buscarReferencia.plac_vh)
                            $('#lbMotor').text(data.buscarReferencia.nummot_vh)
                            $('#lbMarca').text(data.buscarReferencia.marcvh_nombre)
                            $('#lbColor').text(data.buscarReferencia.colvh_nombre)
                            $('#lbAnio').text(data.buscarReferencia.anio_vh)
                            $('#lbPorcentajeImpConsumo').text(data.buscarReferencia.impconsumo)
                            $('#lbTipoServicio').text(data.buscarReferencia.tpserv_nombre)
                            $('.areaRepuesto').hide();
                            $('.areaVehiculo').show();
                            $('.panelBusquedaReferencia').show();
                        }
                        $('#tablaStock').find('tbody').empty();
                        for (var i = 0; i < data.buscarStock.length; i++) {
                            $('#tablaStock').find('tbody').append('<tr><td style= "text-align:left;" >'
                                + data.buscarReferencia.ref_codigo + '</td><td style= "text-align:left;">'
                                + data.buscarReferencia.ref_descripcion + '</td><td style= "text-align:left;">'
                                + data.buscarStock[i].bodccs_nombre + '</td><td style= "text-align:right;">'
                                + data.buscarStock[i].cantidadcomprometida + '</td><td style= "text-align:right;">'
                                + data.buscarReferencia.precio_venta + '</td><td style= "text-align:left;">'
                                + data.buscarStock[i].clasificacion + '</td><td style= "text-align:right;">'
                                + data.buscarReferencia.conteoRotacion + '</td><td style= "text-align:right;">'
                                + data.buscarReferencia.costo_promedio + '</td><td style= "text-align:right;">'
                                + data.buscarReferencia.precio_compra + '</td><td style= "text-align:right;">'
                                + data.buscarStock[i].stock + '</td><td style= "text-align:right;">'
                                + data.buscarReferencia.costo_emergencia + '</td><td>'
                                + '<a onclick="traer_ubicacion(\'' + data.buscarStock[i].codigo_referencia + '\',\'' + data.buscarStock[i].codigo_bodega + '\')" class="btn btn-info" name="btnTraerUbicacion" id="btnTraerUbicacion">Ubicación</a></td><td>'
                                + '<a onclick="traer_reemplazo(\'' + data.buscarStock[i].codigo_referencia + '\')" class="btn btn-info" name="btnTraerReemplazo" id="btnTraerReemplazo">Reemplazos</a></td></tr>');
                        }
                    },
                    complete: function () {
                        $('.tabOculto').show();
                    }
                })

            }
        });
        function traer_ubicacion(codigo_referencia, bodega) {
            $('#tablaDetalleUbicacion').dataTable().fnDestroy();
            $.ajax({
                url: '/itemInventario/TraerUbicaciones',
                data: {
                    codigo_referencia: codigo_referencia,
                    idbodega: bodega
                },
                type: 'post',
                dataType: 'json',
                cache: false,
                success: function (data) {
                    $("#modal_listarUbicacion").modal('show');
                    $('#tablaDetalleUbicacion').dataTable().fnDestroy();
                    $('#tablaDetalleUbicacion').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        $('#tablaDetalleUbicacion').find('tbody').append(
                            '<tr align="center">'
                            +'<td align="left">' + data[i].bodccs_nombre + '</td>' 
                            +'<td align="left">' + data[i].ubicacion + '</td>'
                            +'<td align="left">' + data[i].area + '</td>' 
                            +'<td align="left">' + data[i].nota + '</td>'
                            + '</tr > '
                        );
                    }
                },
                complete: function (data) {
                    $('#tablaDetalleUbicacion').dataTable({
                        //"ajax": 'api/datatables.json',
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: [
                            { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                            //{ extend: 'pdf', title: 'ExampleFile', className: 'btn-sm', text: 'PDF' },
                            //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                        ]
                    });
                }
            })
        }
        function traer_reemplazo(codigo_referencia) {
            $('#tablaDetalleReemplazo').dataTable().fnDestroy();
            $.ajax({
                url: '/itemInventario/TraerReemplazos',
                data: {
                    codigo_referencia: codigo_referencia
                },
                type: 'post',
                dataType: 'json',
                cache: false,
                success: function (data) {
                    $("#modal_listarReemplazos").modal('show');
                    $('#tablaDetalleReemplazo').dataTable().fnDestroy();
                    $('#tablaDetalleReemplazo').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        $('#tablaDetalleReemplazo').find('tbody').append
                                ('<tr align="center"><td align="left">' + data[i].codigo_referencia_reemplazo + '</td>' +
                                    '<td align="left">' + data[i].descripcion_reemplazo + '</td></tr>');
                    }
                },
                complete: function (data) {
                    $('#tablaDetalleReemplazo').dataTable({
                        //"ajax": 'api/datatables.json',
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: [
                            { extend: 'excel', className: 'btn-sm', text: 'Exportar a Excel' },
                            //{ extend: 'pdf', title: 'ExampleFile', className: 'btn-sm', text: 'PDF' },
                            //{ extend: 'print', className: 'btn-sm', text: 'Imprimir' }
                        ]
                    });
                }
            })
        }
    </script>
}