@model Homer_MVC.IcebergModel.Cotizacion

@{
    ViewBag.Title = "Cotizacion";
    ViewBag.Icono = "fa fa-usd";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    @Styles.Render("~/bundles/select2/css")
    <link href="~/Vendor/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Vendor/BootstrapMultiselect/multiselect.css" rel="stylesheet" />
    <link href="~/Vendor/EasyAutocomplete-1.3.5/easy-autocomplete.min.css" rel="stylesheet" />
    <link href="~/Vendor/EasyAutocomplete-1.3.5/easy-autocomplete.themes.min.css" rel="stylesheet" />
    <link href="~/Vendor/toastr/toastr.css" rel="stylesheet" />
    <link href="~/Vendor/toastr/toastr.min.css" rel="stylesheet" />
}

<div class="panel-body">
    <div class="panel-heading" style="background-color:white;  border:solid 1px; border-color:#e4e5e7">
        <div class="panel-body">

            <div id="hbreadcrumb" class="pull-right">

                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Enlaces" data-content="<ul>@ViewBag.nombreEnlaces</ul>" data-html="true">
                    <i class="text-info fa fa-tags"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Documentos" data-content="<ul></i><a href=''>Documento 1</a></ul>  <ul></i><a href=''>Documento 2</a></ul> <ul></i><a href=''>Documento 3</a></ul>" data-html="true">
                    <i class="text-primary fa fa-files-o"></i>
                </button>
                <button type="button" class="btn btn-mini btn-default" style="border-radius:25px" data-container="body" data-toggle="popover" data-placement="left" data-title="Favoritos" data-content="@ViewBag.Favoritos" data-html="true">
                    <i class="text-warning fa fa-star"></i>
                </button>

            </div>
            <h3 class="font-light m-b-xs">
                <i class="text-info @ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title
            </h3>
            <small>Registro @ViewBag.Title</small>
        </div>
    </div>
</div>

<div class="panel-body" style="padding-top:0px;">
    <div class="hpanel">
        @if (TempData["mensaje_correcto"] != null)
        {
            <div class="alert alert-success  alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p>@TempData["mensaje_correcto"]</p>
            </div>
        }

        @if (TempData["mensaje_error"] != null)
        {
            <div class="alert alert-danger  alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                <p>@TempData["mensaje_error"]</p>
            </div>
        }

        @Html.HiddenFor(x => x.cotizacion_id)
        <div id="tabs" class="tab-content">

            <div class="m float-e-margins text-right">
                <div class="tooltip-demo">

                    <div id="div-mensaje"></div>

                </div>
            </div>

            <ul id="tabs-crear" class="nav nav-tabs">
                <li class="" onclick="cotizacion();"><a data-toggle="tab" href="#tercero"><i class="@ViewBag.Icono"></i>&nbsp;&nbsp;@ViewBag.Title</a></li>
                <li class="" onclick="buscarAjaxCotizaciones();"><a data-toggle="tab" href="#buscar"><i class="fa fa-search"></i>&nbsp;&nbsp;Búsquedas</a></li>
                <li class="active" onclick="verDetalleCorizacion();"><a data-toggle="tab" href="#VerDetalle"><i class="fa fa-eye"></i>&nbsp;&nbsp;Cotizacion &nbsp;N°&nbsp;@ViewBag.numeroCotizacion</a></li>
            </ul>

            <div id="VerDetalle" class="tab-pane active">
                <div class="panel-body">
                    <div class="hpanel">
                        <div>
                            <button class="btn btn-danger btnModal" type="button" style="text-align:right; display:none"><i class="fa fa-times"></i>&nbsp;&nbsp;&nbsp;No compro</button>
                            <button class="btn btn-info btn-xs" type="button" style="text-align:center;float:right;margin-top:-12px;" onclick="enviarCorreo()">
                                <i class="fa fa-archive"></i>&nbsp;&nbsp;&nbsp;Enviar Correo
                            </button>
                            <input type="hidden" value="@ViewBag.cotizacion_id" id="cotizacion" />
                        </div>
                        <br />
                        <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                            <div class="panel-tools">
                                <a class="showhide"><i class="fa fa-chevron-up"></i></a>

                            </div>
                            <i class="fa fa-volume-control-phone"></i>&nbsp;&nbsp;&nbsp;Detalle Cotización
                        </div>
                        <div class="panel-body">


                            <div class="col-lg-12">
                                <div class="hpanel" id="panelCliente">
                                    <div class="panel-heading hbuilt text-center" style="background-color:#e4e5e7;">
                                        <div class="panel-tools">
                                            <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                                        </div>
                                        <b>Información Cliente</b>
                                    </div>
                                    <div class="panel-body">

                                        @*<div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Fecha:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="fecha" value="@ViewBag.fecha" placeholder="Fecha" readonly="readonly" />
                                                </div>
                                            </div>
                                        </div>*@

                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Documento Cliente:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="hidden" name="idTercero" id="idTercero" value="@ViewBag.idTercero" class="form-control" />
                                                    <input type="text" class="form-control" id="documento_cliente" value="@ViewBag.documento_cliente" placeholder="Documento" readonly="readonly" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Primer Nombre:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clientePrimerNombre" value="@ViewBag.PrimerNombre" placeholder="Nombre Cliente" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Segundo Nombre:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clienteSegundoNombre" value="@ViewBag.SegundoNombre" placeholder="Nombre Cliente" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Primer Apellido:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clientePrimerApellido" value="@ViewBag.PrimerApellido" placeholder="Nombre Cliente" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Segundo Apellido:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clienteSegundoApellido" value="@ViewBag.SegundoApellido" placeholder="Nombre Cliente" />
                                                </div>
                                            </div>
                                        </div>                                        
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Razon Social:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="RazonSocial" value="@ViewBag.RazonSocial" placeholder="Nombre Cliente" />
                                                </div>
                                            </div>
                                        </div>                                        
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Dirección:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clientedireccion" value="@ViewBag.direccion" readonly placeholder="Dirección" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Telefono:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clientetelefono" value="@ViewBag.telefono" placeholder="Telefono" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Celular:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clientecelular" value="@ViewBag.celular" placeholder="Celular" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label class="control-label col-md-4">Correo:<span class="text-danger"></span></label>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" id="clientecorreo" value="@ViewBag.correo" placeholder="Correo" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="button text-right">
                                            <button class="btn btn-info" type="button" id="btnUpdateTercero"><i class="fa fa-arrow-circle-up"></i>&nbsp;&nbsp;&nbsp;Actualizar</button>
                                        </div>
                                        @*<div class="col-sm-6">
            <div class="form-group">
                <label class="control-label col-md-4">Numero Cotizaci&oacute;n:<span class="text-danger"></span></label>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="numeroCot" value="@ViewBag.numeroCotizacion" placeholder="Número Cotización" readonly="readonly" />
                </div>
            </div>
        </div>*@

                                    </div>

                                </div>
                            </div>
                            @*Vehiculos Cotizados*@
                            <div class="col-lg-12">
                                <div class="hpanel" id="panelVehiculos">
                                    <div class="panel-heading hbuilt text-center" style="background-color:#e4e5e7;">
                                        <div class="panel-tools">
                                            <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                                        </div>
                                        <b>Vehiculos Cotizados</b>
                                    </div>
                                    <div class="panel-body">

                                        <div class="panel-body-busqueda col-md-12">
                                            <div class="table-responsive">
                                                <div id="div-mensaje-buscar"></div>
                                                <table class="table table-striped table-bordered table-hover" id="tablaDetallesCotizacion">
                                                    <thead>
                                                        <tr>
                                                            <th style="text-align:center">Descripcion</th>
                                                            <th style="text-align:center">Valor</th>
                                                            <th style="text-align:center">Poliza</th>
                                                            <th style="text-align:center">Matricula</th>
                                                            <th style="text-align:center">SOAT</th>
                                                            <th style="text-align:center">Acci&oacute;n</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                            <div class="panel-body-btns text-right">
                                                <button class="btn btn-info" type="button" id="btnAgregarVehiculo"><i class="fa fa-plus-circle"></i>&nbsp;&nbsp;&nbsp;Agregar</button>
                                            </div>
                                        </div>

                                    </div>

                                </div>
                            </div>

                            @*Accesorios Cotizados*@
                            <div class="col-lg-12">
                                <div class="hpanel" id="panelAccesorios">
                                    <div class="panel-heading hbuilt text-center" style="background-color:#e4e5e7;">
                                        <div class="panel-tools">
                                            <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                                        </div>
                                        <b>Accesorios Cotizados</b>
                                    </div>
                                    <div class="panel-body">

                                        <div class="panel-body-busqueda col-md-12">
                                            <div class="table-responsive">
                                                <div id="div-mensaje-buscar"></div>
                                                <table class="table table-striped table-bordered table-hover" id="tablaDetallesCotizacionAccesorio">
                                                    <thead>
                                                        <tr>
                                                            <th style="text-align:center">Codigo Referencia</th>
                                                            <th style="text-align:center">Descripcion</th>
                                                            <th style="text-align:center">Cantidad</th>
                                                            <th style="text-align:center">Valor Unitario</th>
                                                            <th style="text-align:center">Valor Total</th>
                                                            <th style="text-align:center">Acci&oacute;n</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                            <div class="panel-body-btns text-right">
                                                <button class="btn btn-info" type="button" id="btnAgregarAccesorios"><i class="fa fa-plus-circle"></i>&nbsp;&nbsp;&nbsp;Agregar</button>
                                            </div>
                                        </div>

                                    </div>

                                </div>
                            </div>

                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label class="control-label col-md-2">Total Cotizaci&oacute;n:<span class="text-danger"></span></label>
                                    <div class="col-md-3">
                                        @Html.EditorFor(model => model.cot_valortotal, new { htmlAttributes = new { @class = "form-control", @placeholder = "Total", @readonly = "readonly" } })
                                        @Html.ValidationMessageFor(model => model.cot_valortotal, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

            @*REGISTRO COTIZACION -> PANEL BUSCAR*@

            <div id="buscar" class="tab-pane">
                <div class="panel-body">
                    <div class="panel-body-busqueda">
                        <div class="table-responsive">
                            <div id="div-mensaje-buscar"></div>
                            <table class="table table-striped table-bordered table-hover" id="tablaPaginada">
                                <thead>
                                    <tr>
                                        <th style="text-align:center">Numero Cotizacion</th>
                                        <th style="text-align:center">Fecha</th>
                                        <th style="text-align:center">Identificación</th>
                                        <th style="text-align:center">Nombre Cliente</th>
                                        <th style="text-align:center">Telefono</th>
                                        <th style="text-align:center">Email</th>
                                        <th style="text-align:center">Fuente</th>
                                        <th style="text-align:center">Subfuente</th>
                                        <th style="text-align:center">Asesor</th>
                                        <th style="text-align:center">Ultimo seguimiento</th>
                                        <th style="text-align:center">Nota</th>
                                        <th style="text-align:center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="row col-md-4 col-md-offset-4">
                            <div id="page-selection"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade hmodal-info" id="modalAccesorios" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Accesorios</h4>
                <small>Agregar Accesorios A Vehiculos</small>
            </div>
            <div class="modal-body">

                <input type="hidden" id="idRepuestoCotizado" />

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Referencia:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input id="codigo" name="codigo" placeholder="Seleccione" class="form-control" onkeyup="traerReferencias(this.id)" />
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Precio:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="txtCostoAccesorio" placeholder="Digite Precio" onkeyUp="return miles(this.id)" />
                        </div>
                    </div>
                </div>
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Cantidad:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="txtCantidadAccesorio" placeholder="Digite Cantidad" required onkeyUp="return miles(this.id)" />
                        </div>
                    </div>
                </div>


                <div class="col-sm-12">
                    <div class="form-group">
                        <div class="row" style="display:none" id="alertAgregarRepuesto">
                            <div class="alert alert-info">
                                <strong>Informaci&oacute;n!&nbsp;&nbsp;<p id="mensajeAgregarRepuesto"></p></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Modelo:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            <select id="ListModelAccesorio" name="ListModelAccesorio" class="form-control" required >
                                <option value="" class="form-control"> Modelo  </option>
                            </select>
                        </div>
                    </div>
                </div>
                <label></label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarRepuesto">Guardar</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade hmodal-info" id="modalVehiculos" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Vehiculos</h4>
                <small>Agregar Vehiculo A Cotizaci&oacute;n</small>
            </div>
            <div class="modal-body">

                <input type="hidden" id="idVehiculoCotizado" />

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Tipo Vehículo:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-3">
                            <input type="radio" name="tipoVh" value="Nuevo" id="rbNuevo" checked="checked">&nbsp;&nbsp;Nuevo<br>
                        </div>
                        <div class="col-md-3">
                            <input type="radio" name="tipoVh" value="Usado" id="rbUsado">&nbsp;&nbsp;Usado<br>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Marca:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            @Html.DropDownListFor(model => model.marcvh_id, null, "", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                            @Html.ValidationMessageFor(model => model.marcvh_id, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Modelo:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            @Html.DropDownListFor(model => model.modvh_codigo, Enumerable.Empty<SelectListItem>(), "", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                            @Html.ValidationMessageFor(model => model.modvh_codigo, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Año:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            @Html.DropDownListFor(model => model.anio, Enumerable.Empty<SelectListItem>(), "", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                            @Html.ValidationMessageFor(model => model.anio, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Color:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            @Html.DropDownListFor(model => model.colVh_id, null, "", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                            @Html.ValidationMessageFor(model => model.colVh_id, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Valor:&nbsp;<span class="text-danger">*</span></label>
                        <div class="col-md-8">
                            @Html.EditorFor(model => model.valor, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Valor", @onkeyUp = "return miles(this.id)" } })
                            @Html.ValidationMessageFor(model => model.valor, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Costo Poliza:<span class="text-danger"></span></label>
                        <div class="col-md-8">
                            @Html.EditorFor(model => model.costo_poliza, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Costo", @onkeyUp = "return miles(this.id)" } })
                            @Html.ValidationMessageFor(model => model.costo_poliza, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Costo SOAT:<span class="text-danger"></span></label>
                        <div class="col-md-8">
                            <input type="text" name="soat" id="soat" class="form-control" onkeyup="return miles(this.id)" value="0" placeholder="Ingrese Costo SOAT" />
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Matricula:<span class="text-danger"></span></label>
                        <div class="col-md-8">
                            @Html.EditorFor(model => model.matricula, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Matricula", @onkeyUp = "return miles(this.id)" } })
                            @Html.ValidationMessageFor(model => model.matricula, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="control-label col-md-4">Observaciones:<span class="text-danger"></span></label>
                        <div class="col-md-8">
                            @Html.TextAreaFor(m => m.observacion, new RouteValueDictionary(new { @class = "someClass", style = "width: 100%; height:80px;" }))
                            @Html.ValidationMessageFor(model => model.observacion, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <div class="row" style="display:none" id="alertAgregarVehiculo">
                            <div class="alert alert-info">
                                <strong>Informaci&oacute;n!&nbsp;&nbsp;<p id="mensajeAgregarVehiculo"></p></strong>
                            </div>
                        </div>
                    </div>
                </div>
                <label></label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarVehiculo">Guardar</button>
            </div>
        </div>
    </div>
</div>

@*------------------- Modal plan pago -------------------------- *@
<div class="modal fade" id="modalCredito" tabindex="-1" role="dialog" aria-hidden="true" wid>
    @using (Html.BeginForm("AgregarPlanPago", "cotizacion", FormMethod.Post, new { @name = "formcredito", @id = "formcredito" }))
    {<div class="modal-dialog modal-lg" style="width:80%;">
            <div class="modal-content">
                <div class="color-line"></div>
                <div class="modal-header">
                    <h4 class="modal-title"><font><font>Plan de Pago</font></font></h4>
                    <small class="font-bold"><font><font>Planes de credito</font></font></small>
                </div>

                <div class="modal-body" id="datosModal">

                    <div class="alert alert-success  alert-dismissible" style="display: none" id="mensaje">
                        <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                        <p id="cuerpo_mensaje"></p>
                    </div>

                    <div class="alert alert-danger  alert-dismissible" style="display: none" id="mensaje_error">
                        <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                        <p id="cuerpo_mensaje_error"></p>
                    </div>

                    <div class="alert alert-success alert-dismissible" style="display: none" id="mensaje_enviando">
                        <button type="button" class="close" data-dismiss="alert" arial-label="close"><span aria-hidden="true">&times;</span></button>
                        <p id="cuerpo_mensaje_enviando"></p>
                    </div>

                    <div class="hpanel">
                        <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                            <div class="panel-tools">
                                <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                            </div>
                            <i class="fa fa-car  text-primary font-lg"></i>&nbsp;&nbsp;Información Vehiculo
                        </div>
                        <div class="panel-body">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Valor total:&nbsp;<span class="text-danger">*</span></label>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="valor_total" name="valor_total" value="" required="required" placeholder="Digite valor" onkeyUp="return miles(this.id)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Plan Financiero:&nbsp;<span class="text-danger">*</span></label>
                                    <div class="col-md-6">
                                        @Html.DropDownList("plan_id", null, "Seleccione", htmlAttributes: new { @class = "form-control js-source-states", @placeholder = "Seleccione" })
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Cuota inicial:&nbsp;<span class="text-danger">*</span></label>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="cuota_inicial" name="cuota_inicial" value="" required="required" placeholder="Digite cuota" onkeyUp="return miles(this.id)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Credito:&nbsp;<span class="text-danger">*</span></label>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="credito" name="credito" value="" required="required" placeholder="Digite valor credito" onkeyUp="return miles(this.id)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Plazo (s):&nbsp;<span class="text-danger">*</span></label>
                                    <div class="col-md-6">
                                        <select class="multiselect-ui form-control" id="cuotas" name="cuotas" multiple="multiple" required="required">
                                            <option value="12">12 Meses</option>
                                            <option value="24">24 Meses</option>
                                            <option value="36">36 Meses</option>
                                            <option value="48">48 Meses</option>
                                            <option value="60">60 Meses</option>
                                            <option value="72">72 Meses</option>
                                            <option value="84">84 Meses</option>
                                        </select>
                                    </div>
                                </div>
                            </div>


                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Tasa de Interes:&nbsp;<span class="text-danger">*</span></label>
                                    <div class="col-md-6">
                                        @*<input type="number" class="form-control" id="tasa_interes" name="tasa_interes" value="" required="required" placeholder="Digite porcentaje" typeof="number" />*@
                                        <input type="text" class="form-control SoloComa" id="tasa_interes" name="tasa_interes" value="" required="required" placeholder="Digite porcentaje" @*onkeypress="return validarComa(event, this.id)"*@ />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Valor Residual:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="valor_residual" name="valor_residual" value="" placeholder="Digite valor residual" onkeyUp="return miles(this.id)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label col-md-6">Otros Valores:&nbsp;<span class="text-danger"></span></label>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="otros_valores" name="otros_valores" value="" placeholder="Digite valor residual" onkeyUp="return miles(this.id)" />
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" id="btn_calcular">
                                <div class="col-md-6">
                                    <input onclick="calcular()" type="button" class="btn btn-primary" value="Calcular" id="calcularplan" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="informacionCredito" style="display:none">
                        <div class="hpanel">
                            <div class="panel-heading hbuilt" style="background-color:#e4e5e7">
                                <div class="panel-tools">
                                    <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                                </div>
                                <i class="fa fa-credit-card-alt"></i>&nbsp;&nbsp;Información Credito
                            </div>
                            <div class="panel-body" id="plazos">
                                <div id="buscar" class="tab-pane">
                                    <div class="panel-body-busqueda">
                                        <div class="table-responsive">
                                            <div id="div-mensaje-buscar"></div>
                                            <table class="table table-striped table-bordered table-hover tablaCreditos" id="tablaCreditos">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align:center">Valor a Financiar</th>
                                                        <th style="text-align:center">Tasa Interes</th>
                                                        <th style="text-align:center">Cuotas</th>
                                                        <th style="text-align:center">Valor Cuota</th>
                                                        <th style="text-align:center">Plan Financiero</th>
                                                        <th style="text-align:center">Valor Residual</th>
                                                        <th style="text-align:center">Otros Valores</th>
                                                        <th style="text-align:center">Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <input type="hidden" id="idCotizacionASD" name="idCotizacionASD" value="" />
                    <button type="button" class="btn btn-default" data-dismiss="modal"><font><font>Cerrar</font></font></button>
                    <button type="submit" class="btn btn-info" name="submitpago" id="submitpago"><font><font>Guardar cambios</font></font></button>
                </div>
            </div>
        </div>
    }
</div>

@*modal devolucion ya realizada*@
<div id="modal_anulacion" class="modal" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                @*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
                <h5 class="modal-title" id="exampleModalLongTitle"><b>No compro</b></h5>
            </div>
            <div class="modal-body">
                <div class="row" style="text-align:left;">
                    <label>Motivo por el que no compro </label>
                    <select id="motivo_anulacion" name="motivo_anulacion" placeholder="Seleccione" style="width:50%"></select>
                    <input name="id_cotizacion" id="id_cotizacion" value="@ViewBag.idCotizacion" type="hidden" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary btnAnular" data-dismiss="modal">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalActivacionCC" class="modal" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="color-line"></div>
            <div class="modal-header text-center">
                <h4 class="modal-title">Activar Call Center</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label col-md-4">Asignar a:&nbsp;<span class="text-danger">*</span></label>
                            <div class="col-md-8">
                                <input type="hidden" name="idCotActivacion" id="idCotActivacion" class="form-control" value="" />
                                <select id="asignado" name="asignado" class="form-control js-source-states" required>
                                    <option></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label col-md-4">Notas:&nbsp;<span class="text-danger">*</span></label>
                            <div class="col-md-8">
                                <textarea type="text" name="observaciones" id="observaciones" value="" class="form-control" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="alert alert-danger" role="alert" id="msjCamposObligatorios" style="display:none">
                            Los campos marcados con * son obligatorios
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cerrarModalPlanPago">Cerrar</button>
                <button type="button" class="btn btn-info" id="activarCC" onclick="guardarActivacion()">Confirmar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/select2/js")
    <script src="~/Vendor/BootstrapMultiselect/multiselect.js"></script>
    <script src="~/Vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Vendor/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Vendor/datatablesExcelExport/dataTable1.4.0-buttons.js"></script>
    <script src="~/Vendor/datatablesExcelExport/JSZip3.1.3.min.js"></script>
    <script src="~/Vendor/datatablesExcelExport/jsZipDataTables.js"></script>
    <script src="~/Vendor/EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script>
    <script src="~/Vendor/toastr/toastr.min.js"></script>

    <script type="text/javascript">
        var GlobalIdDetallePlanDePago = 0;
        var GlobalPlanDePagovalor = 0;
        var GlobalModelo = '';
        var GlobalCotizacion = '@ViewBag.idCotizacion';

        $(document).ready(function () {
           // $("#ListModelAccesorio").on("change", function () { codigo_modelovh = $(this).val(); });
            $('#panelVehiculos').find('.showhide').trigger('click');
            $('#panelAccesorios').find('.showhide').trigger('click');
            $('#panelRetomas').find('.showhide').trigger('click');
            $('.js-source-states').select2();
            $('#motivo_anulacion').select2();
            $('#cuotas').multiselect({
                includeSelectAllOption: true,
                maxHeight: 400,
                dropUp: false
            });
            calcularValorCotizacionAjax();
            buscarAnuladas()
            //buscarPermisos()
            //var referencias = {
            //    data: []
            //};
            //$("#codigo").easyAutocomplete(referencias);
        });

        $("#btnUpdateTercero").click(function () {
            debugger
            //var fecha = $("#fecha").val();
            var idTercero = $("#idTercero").val();
            var documento_cliente = $("#documento_cliente").val();
            var clientePrimerNombre = $("#clientePrimerNombre").val();
            var clienteSegundoNombre = $("#clienteSegundoNombre").val();
            var clientePrimerApellido = $("#clientePrimerApellido").val();
            var clienteSegundoApellido = $("#clienteSegundoApellido").val();
            var RazonSocial = $("#RazonSocial").val();
            var clientedireccion = $("#clientedireccion").val();
            var clientetelefono = $("#clientetelefono").val();
            var clientecelular = $("#clientecelular").val();
            var clientecorreo = $("#clientecorreo").val();
            var TipoIdentificacion = '@ViewBag.TipoIdentificacion';
            var ClienteDato = {
                  tercero_id: idTercero
                , doc_tercero: documento_cliente
                , prinom_tercero: clientePrimerNombre
                , segnom_tercero: clienteSegundoNombre
                , apellido_tercero: clientePrimerApellido
                , segapellido_tercero: clienteSegundoApellido
                , razon_social: RazonSocial                
                , telefono_tercero: clientetelefono
                , celular_tercero: clientecelular
                , correo: clientecorreo
                , direc_tercero: clientedireccion
                ,cotizacion_id:'@ViewBag.idCotizacion'
            };
            debugger
             $.ajax({
                url: '/cotizacion/UpdateTercero',
                data: {ClienteDato },
                type: "post",
                cache: false,
                 success: function (data) {
                    debugger
                    toastr.success(data.mensaje);
                 },
                 error: function (data) {
                     debugger
                     toastr.error("error");
                 }
            })
        })

        function buscarAnuladas() {
            $.ajax({
                url:'/cotizacion/buscaranuladas',
                data: {
                    id : $('#id_cotizacion').val(),
                },
                type: "post",
                cache: false,
                success :function(data){
                    if (data.data == true) {
                        $('.btnModal').hide();
                        $('#btnAgregarVehiculo').hide();
                        $('#btnAgregarAccesorios').hide();
                    }
                }
            })
        }

        function enviarCorreo() {
            var cotizacion = $('#cotizacion').val();
            debugger
            $.ajax({
                url: '/cotizacion/CotizacionDigital',
                data: {
                    cotizacion_id : cotizacion
                },
                type: "post",
                success: function (data) {
                    debugger
                    if (data.exito == "0") {
                        swal("error! ",data.detalle, "error");

                        //swal("Error al enviar el correo", "Debe realizar el plan de pago para enviar el correo.", "error");Proceso Exitoso
                    } else if (data.exito == "1") {
                        swal("Proceso Exitoso",data.detalle ,"'<br />'", "success");
                    } else {
                        swal("Error al enviar el correo", "El correo no pudo ser enviado.", data.detalle);
                    }
                }
            })
        }

        function buscarMotivos() {
            $.ajax({
                url: '/cotizacion/buscarMotivos',
                data: {
                },
                type: "post",
                cache: false,
                success: function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#motivo_anulacion').append($('<option>', {
                            value: data[i].id,
                            text: data[i].motivo
                        }));
                    }
                }
            })
        } //ok

        $('.btnModal').click(function () {
            buscarMotivos()
            $("#modal_anulacion").modal('show');
        });

        $('.btnAnular').click(function (id) {
            $("#modal_anulacion").modal('hide');
            swal({
                title: "¿Esta Seguro de adicionar el registro?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si, finalizar!",
                cancelButtonText: "No, cancelar!",
                closeOnConfirm: false,
                closeOnCancel: false
            },
            function (isConfirm) {
                if (isConfirm) {
                    window.location.href = '@Url.Action("Delete", "cotizacion")?id='+ $('#id_cotizacion').val()+'&&motivo=' + $('#motivo_anulacion').val()+'&&descripcion=' + $('#motivo_anulacion option:selected').text()+'&&tercero=' + $('#idTercero').val()+'&&numeroCot=' + $('#numeroCot').val();
                } else {
                    swal("Cancelado", "La cotización no será modificada", "error");
                }
            });
        });

        function generarPDF(cotizacionn){
            $.ajax({
                url:'/cotizacion/buscarVehiculo',
                data:{cotizacionn,},
                type:'post',
                cache: false,
                success: function(data){
                    if (data == 1) {
                        window.open('@Url.Action("crearPDF", "cotizacion")?cotizacion='+cotizacionn,'_blank');
                    }else{
                        //$('#sinVehiculo').show()
                    }
                }
            })
        }

        function generarPDF2(cotizacionn){
            $.ajax({
                url:'/cotizacion/buscarVehiculo',
                data: {
                    id : cotizacionn
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data == 1) {
                        window.open('@Url.Action("crearPDF", "cotizacion")?cotizacion='+cotizacionn,'_blank');
                    }else{
                        swal("Esta cotización no tiene un vehículo!", "", "warning");
                    }
                },
                fail: function(err) {
                    console.log('err',err);
                },

            });
        }

        //Funcion Calcular del boton--- inicio
        function calcular()
        {
            debugger
            //$("#tablaCreditos").dataTable().fnDestroy();
            var valor_total = $("#valor_total").val().replace(/\./g, "");
            var tasa_interes = $("#tasa_interes").val();
            var cuota_inicial = $("#cuota_inicial").val().replace(/\./g, "");
            var cuotas = $("#cuotas").val();
            //var plan_id = $("#plan_id").val();
            console.log(tasa_interes)
            console.log(cuota_inicial)
            console.log(cuotas)

            if ($.trim(valor_total) != "" && $.trim(tasa_interes) != "" && $.trim(cuota_inicial) != "" && cuotas != null)
            {
                $("#informacionCredito").show();
                $('#mensaje_error').hide();
                // ojo 34
                var valorcredito = $("#credito").val().replace(/\./g, "");
                tasa_interespor = tasa_interes;
                tasa_interes = parseFloat(tasa_interes);
                wtasa_interes = tasa_interes ;
                wtasa_interes = wtasa_interes + "%";
                tasa_interes = tasa_interes / 100;
               // $('#tablaCreditos').find('tbody').empty();
                var valor_credito = addCommas(valorcredito);

                for (var i = 0; i < cuotas.length; i++) {
                    var valor_total = 0;
                    cuotas[i] = parseInt(cuotas[i]);
                    var aux = valorcredito * tasa_interes;
                    var aux1 = 1 + tasa_interes;
                    var aux3 = Math.pow(aux1, -cuotas[i])
                    var aux2 = 1 - aux3;
                    valor_total = aux / aux2;
                    valor_total = valor_total.toFixed(2);
                    valor_total = Math.round(valor_total);
                    var valor_total_concomas = addCommas(valor_total);
                    debugger
                    $('#tablaCreditos').find('tbody').append('<tr id="QuitarCuotas' + cuotas[i] + '">'
                        + '<td align="right">$' + valor_credito + '</td>'
                        + '<td align="right">' + tasa_interespor + '%</td>'
                        + '<td align="center">'
                        + '<input type="hidden" id="cuota' + cuotas[i] + '" value="' + cuotas[i] + '">' + cuotas[i]
                        + '</td>'
                        + '<td align="right">'
                        + '<input type="hidden" id="valor_cuota' + cuotas[i] + '" value="' + valor_total + '">$' + valor_total_concomas
                        + '</td>'
                        + '<td align="center">' + $('#plan_id option:selected').text() + '</td>'
                        + '<td align="right">' + $("#valor_residual").val() + '</td>'
                        + '<td align="right">' + $("#otros_valores").val() + '</td>'
                        + '<td width="15%" align="center"></button>&nbsp;&nbsp;<button type="button" class="btn btn-success btn-xs" onclick="QuitarDePago('
                        + cuotas[i] + ')"><i class="fa fa-trash"></i>&nbsp;Quitar&nbsp;&nbsp;</button></td>'
                        + '</tr>');
                }
                debugger
                //$('#tablaCreditos').dataTable({
                //    dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                //    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                //    buttons: [ ]
                //});
            } else {
                $('#mensaje_error').show();
                $('#cuerpo_mensaje_error').html('<i class="fa fa-times" aria-hidden="true" ></i> Por favor valide los campos requeridos (*)')
            }
        }
        //Funcion Calcular del boton ----final

        //JM para este caso

        var numero_miles = "";
        function formatNumber (n) {
            n = String(n).replace(/\D/g, "");
            return n === '' ? n : String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function miles (id) {
            numero_miles = formatNumber($('#'+id+'').val());
            $('#'+id+'').val(numero_miles);
        }

        function cotizacion(){
            window.location.href = '@Url.Action("Create", "cotizacion")';
        }

        $('#btnAgendarPeritaje').click(function () {
            window.open('@Url.Action("Solicitud", "peritaje")?menu='+@ViewBag.id_menu+'&&cotizacion=' + @ViewBag.numeroCotizacion, '_blank');
        });

        function reiniciarPorRadioButton(){
            $('#anio').empty();
            $('#anio').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#anio').select2();

            $('#colVh_id').empty();
            $('#colVh_id').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#colVh_id').select2();

            $('#modvh_codigo').empty();
            $('#modvh_codigo').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#modvh_codigo').select2();
            $('#valor').val('');
            $('#marcvh_id').val('').select2();
        }

        $('#rbNuevo').click(function () {
            reiniciarPorRadioButton();
            //    $.ajax({
            //        url: '/cotizacion/BuscarModelosPorMarca',
            //        data: {
            //            idMarca: 1,
            //            esNuevo: true
            //        },
            //        type: "post",
            //        cache: false,
            //        success: function (data) {
            //            $('#anio').empty();
            //            $('#modvh_codigo').empty();
            //            $('#modvh_codigo').append($('<option>', {
            //                value: '',
            //                text: 'Seleccione'
            //            }));
            //            for (var i = 0; i < data.length; i++) {
            //                $('#modvh_codigo').append($('<option>', {
            //                    value: data[i].modvh_codigo,
            //                    text: data[i].modvh_nombre
            //                }));
            //            }
            //            $('#modvh_codigo').select2();
            //        }, complete: function (data) {
            //            buscarColores();
            //        }
            //    });
        });

        $('#rbUsado').click(function () {
            reiniciarPorRadioButton();
            //    $.ajax({
            //        url: '/cotizacion/BuscarMarcasVehiculos',
            //        data: {
            //        },
            //        type: "post",
            //        cache: false,
            //        success: function (data) {

            //            $('#marcvh_id').empty();
            //            $('#marcvh_id').append($('<option>', {
            //                value: '',
            //                text: ''
            //            }));
            //            for (var i = 0; i < data.length; i++) {
            //                $('#marcvh_id').append($('<option>', {
            //                    value: data[i].marcvh_id,
            //                    text: data[i].marcvh_nombre
            //                }));
            //            }
            //            $('#marcvh_id').select2();
            //        }, complete(data) {
            //            buscarColores();
            //        }
            //    });
            //    $('#anio').empty().select2();
            //    $('#modvh_codigo').empty().select2();
        });

        $('#marcvh_id').change(function () {
            var esNuevo = true;
            if (!$('#rbNuevo').is(':checked')) {
                esNuevo = false;
            }
            $.ajax({
                url: '/cotizacion/BuscarModelosPorMarca',
                data: {
                    idMarca: $('#marcvh_id').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function (data) {
                    console.log(data);
                    $('#anio').empty();
                    $('#anio').append($('<option>', {
                        value: '',
                        text: ''
                    }));
                    $('#anio').select2();

                    $('#modvh_codigo').empty();
                    $('#modvh_codigo').append($('<option>', {
                        value: '',
                        text: ''
                    }));
                    for (var i = 0; i < data.length; i++) {
                        $('#modvh_codigo').append($('<option>', {
                            value: data[i].modvh_codigo,
                            text: data[i].modvh_nombre
                        }));
                    }
                    $('#modvh_codigo').select2();
                    $('#valor').val('');
                    $('#colVh_id').val('').select2();
                }
            });
        });

        $('#modvh_codigo').change(function () {
            $('#descripcion').val('');
            $('#valor').val('');
            var esNuevo = true;
            if (!$('#rbNuevo').is(':checked')) {
                esNuevo = false;
            }
            $.ajax({
                url: '/cotizacion/BuscarAniosModelos',
                data: {
                    codigoModelo: $('#modvh_codigo').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function (data) {
                    $('#anio').empty();
                    $('#anio').append($('<option>', {
                        value: '',
                        text: ''
                    }));
                    for (var i = 0; i < data.length; i++) {
                        $('#anio').append($('<option>', {
                            value: data[i].codigo,
                            text: data[i].anios
                        }));
                    }
                    $('#anio').select2();
                }
            });
        });

        $('#anio').change(function () {
            var esNuevo = true;
            if (!$('#rbNuevo').is(':checked')) {
                esNuevo = false;
            }

            $.ajax({
                url: '/cotizacion/BuscarPreciosPorAnio',
                data: {
                    codigoModelo: $('#modvh_codigo').val(),
                    anioModelo: $('#anio').val(),
                    esNuevo: esNuevo
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if(data.esNuevo == true){
                        $('#valor').val(addComas(data.valor));
                    }
                    $('#colVh_id').empty();
                    $('#colVh_id').append($('<option>', {
                        value: '',
                        text: ''
                    }));
                    for (var i = 0; i < data.buscaColor.length; i++) {
                        $('#colVh_id').append($('<option>', {
                            value: data.buscaColor[i].colvh_id,
                            text: data.buscaColor[i].colvh_nombre
                        }));
                    }
                    $('#colVh_id').val('').select2();
                }
            });
        });

        $('#btnGuardarVehiculo').click(function () {
            if ($('#modvh_codigo').val() == '' || $('#anio').val() == '' || $('#colVh_id').val() == '' || $.trim($('#valor').val()) == '') {
                $('#mensajeAgregarVehiculo').text('Los campos marcados con (*) son obligatorios');
                $('#alertAgregarVehiculo').show();
                setTimeout(function () {
                    $("#alertAgregarVehiculo").fadeOut(1500);
                }, 3000);
            } else {
                agregarVehiculoACotizacion();
                calcularValorCotizacionAjax();
            }
        });

         $('#btnAgregarRetoma').click(function () {
            if ($('#placaRetoma').val() == '' || $('#modeloRetoma').val() == '' || $('#anioVehiculoRetoma').val() == '' || $.trim($('#valorRetoma').val()) == ''|| $.trim($('#kilometrajeRetoma').val()) == '') {
                $('#mensajeAgregarVehiculo').text('Los campos marcados con (*) son obligatorios');
                $('#alertAgregarVehiculo').show();
                setTimeout(function () {
                    $("#alertAgregarVehiculo").fadeOut(1500);
                }, 3000);
            } else {
                agregarRetomaVehiculoACotizacion();
                calcularValorCotizacionAjax();
            }
        });

        function agregarVehiculoACotizacion(){
            var esNuevo = true;
            if (!$('#rbNuevo').is(':checked')) {
                esNuevo = false;
            }

            $.ajax({
                url: '/cotizacion/AgregarVehiculoPosterior',
                data: {
                    idCotizacion: '@ViewBag.idCotizacion',
                    idModelo: $('#modvh_codigo').val(),
                    anio: $('#anio').val(),
                    color: $('#colVh_id').val(),
                    valor: $('#valor').val().replace(/\./g, ""),
                    poliza: $('#costo_poliza').val().replace(/\./g, ""),
                    matricula: $('#matricula').val().replace(/\./g, ""),
                    soat: $('#soat').val().replace(/\./g, ""),
                    observacion: $('#observacion').val(),
                    esNuevo: esNuevo,
                    idVehiculoCotizado: $('#idVehiculoCotizado').val(),
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data.estado == true) {
                        calcularValorCotizacionAjax();
                        $('#modalVehiculos').modal('hide');
                        $('#observacion').val('');
                        $('#costo_poliza').val('');
                        $('#matricula').val('');
                        $('#soat').val('');
                        $('#valor').val('');
                        $("#modvh_codigo").val($("#modvh_codigo option:first").val()).select2();
                        $('#anio').empty().select2();
                        $("#colVh_id").val($("#colVh_id option:first").val()).select2();
                    } else {
                        $('#mensajeAgregarVehiculo').text(data.respuesta);
                        $('#alertAgregarVehiculo').show();
                    }
                    setTimeout(function () {
                        $("#alertAgregarVehiculo").fadeOut(1500);
                    }, 3000);
                }
            });
        }

        function agregarRetomaVehiculoACotizacion() {

            debugger
            $.ajax({
                url: '/cotizacion/agregarRetomaVehiculoACotizacion',
                data: {retomas:{
                idcot: '@ViewBag.idCotizacion',
                placa: $('#placaRetoma').val(),
                modelo: $('#modeloRetoma').val(),
                ano: $('#anioVehiculoRetoma').val().replace(/\./g, ""),
                valor: $('#valorRetoma').val().replace(/\./g, ""),
                Kilometraje: $('#kilometrajeRetoma').val().replace(/\./g, ""),
            }},
                type: "post",
                cache: false,
                success: function (data) {
                    debugger
                    if (data.estado == true) {
                        calcularValorCotizacionAjax();
                        $('#modalRetomaVehiculos').modal('hide');
                        $('#placaRetoma').val('');
                        $('#modeloRetoma').val('');
                        $('#anioVehiculoRetoma').val('');
                        $('#kilometrajeRetoma').val('');
                        //$("#modvh_codigo").val($("#modvh_codigo option:first").val()).select2();
                        //$('#anio').empty().select2();
                        //$("#colVh_id").val($("#colVh_id option:first").val()).select2();
                    } else {
                        $('#mensajeAgregarRetomaVehiculo').text(data.respuesta);
                        $('#alertAgregarRetomaVehiculo').show();
                    }
                    setTimeout(function () {
                        $("#alertAgregarRetomaVehiculo").fadeOut(1500);
                    }, 3000);
                }
            });
        }

        function EliminarVehiculo(id) {
        swal({
                title: "¿Esta Seguro de Borrar el registro?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si, finalizar!",
                cancelButtonText: "No, cancelar!",
                closeOnConfirm: true,
                closeOnCancel: false
            },
            function (isConfirm) {
                if (isConfirm)
                {
                    $.ajax({
                        url: '/cotizacion/eliminarVehiculo',
                        data: {
                            idDetalle: id,
                        },
                        type: "post",
                        cache: false,
                        success: function (data) {
                            if (data == true) {
                                calcularValorCotizacionAjax();
                            }
                        }
                    });               
                } else {
                    swal("Cancelado", "La cotización no será modificada", "error");
                }
            });         
        }

        function EliminarAccesorio(id){
            event.preventDefault();

                        swal({
                title: "¿Esta Seguro de Borrar el registro?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si, finalizar!",
                cancelButtonText: "No, cancelar!",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm)
                {

                $.ajax({
                url: '/cotizacion/eliminarAccesorio',
                data: {
                    idDetalle: id,
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data == true) {
                        calcularValorCotizacionAjax();
                    }
                }
            });

                } else {
                    swal("Cancelado", "La cotización no será modificada", "error");
                }
            });

            
        }

        $('#codigo').change(function () {
            var code=$('#codigo').val();
            if ((code.indexOf('|') > -1) || (j !== "" && j !== undefined)) {
                var codigo = "";
                if (code != "") {
                    var codigo_arr = $('#codigo').val().split("|");
                    codigo2 = codigo_arr[0].trim();
                }
            }
            $.ajax({
                url: '/cotizacion/buscarPrecioReferencia',
                data: {
                    idRepuesto: codigo2
                },
                type: "post",
                cache: false,
                success: function (data) {
                    console.log(data)
                    $('#txtCostoAccesorio').val(addCommas(data.precio1));
                },
                complete: function (data) {
                    if (data.responseText != '') {
                    } else {
                        $('#txtCostoAccesorio').val('0');
                    }
                }
            });
        });

        function EditarAccesorio(id) {
            event.preventDefault();
            $.ajax({
                url: '/cotizacion/BuscarAccesorioCotizado',
                data: {
                    idDetalle: id,
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data.encontrado == true) {
                        $('#selectRepuestos').empty();
                        $('#selectRepuestos').append($('<option>', {
                            value: data.idAccesorio,
                            text: data.descripcion
                        }));
                        $('#selectRepuestos').val($('#selectRepuestos option:first').val()).select2();
                        $('#txtCantidadAccesorio').val(data.cantidad);
                        $('#txtCostoAccesorio').val(addComas(data.valorUnitario));
                        $('#idRepuestoCotizado').val(data.detalleCotizado);
                    }
                },
                complete: function (data) {
                    $('#modalAccesorios').modal('show');
                }
            });
        }

        function EditarRetoma(id) {
            debugger
            //event.preventDefault();
            $.ajax({
                url: '/cotizacion/BuscarRetoma',
                data: {
                    idDetalle: id,
                },
                type: "post",
                cache: false,
                success: function (data) {
                    debugger
                    if (data.encontrado == true) {
                        $('#ano').val(data.ano);
                        $('#valor').val(addComas(data.valor));
                        $('#idRetomaVehiculoCotizado').val(data.id);
                        $('#modelo').val(data.modelo);
                        $('#placa').val(data.placa);
                        $('#Kilometraje').val(data.Kilometraje);
                    }
                },
                error: function (data) {
                    debugger
                    
                },
                complete: function () {
                    $('#modalRetomaVehiculos').modal('show');
                }
            });
        }

        function EliminarRetoma(id){
            event.preventDefault();
            $.ajax({
                url: '/cotizacion/eliminarRetoma',
                data: {
                    idDetalle: id,
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data == true) {
                        calcularValorCotizacionAjax();
                    }
                }
            });
        }

        function misModelos () {
        //var  codigo_modelovh = { codigo_modelovh: $(this).val() };//obtenemos el valor seleccionado en una variable

        //limpia el departamento si seleccionas otro pais o el mismo nuevamente
         $("#ListModelAccesorio").empty(); 
            debugger
            var idCotizacion = GlobalCotizacion;
            $.ajax({
                url: '/cotizacion/ModelosVehiculoCotizacion',
                //contentType: "application/json",
                method: 'Post',
                data: { idCotizacion },//{GlobalCotizacion:"12672"},// JSON.stringify(Pais),
            headers: {
                'Authorization': 'Bearer '
                    + sessionStorage.getItem("accessToken")
            },
            success: function (respuesta) {
                debugger
                $(respuesta.listaVehiculos[0]).each(function () {
                    $("#ListModelAccesorio").append('<option Value="' + respuesta.listaVehiculos[0].codigo_modelovh + '">' + respuesta.listaVehiculos[0].descripcion + "</option>");
                });
            },
            error: function (jQXHR) {
                debugger
                if (jQXHR.status == 404) {
                    toastr.error('Error List Modelo Accesorio ' + jQXHR.statusText);
                }
                if (jQXHR.status == 500) {
                    toastr.error('Error!, recurso no encontrado ' + jQXHR.statusText);
                }
                else {
                    toastr.error('Error Desconocido ListModelAccesorio' + jQXHR.responseJSON.MessageDetail);
                }
            }
        });
    };

        $('#btnAgregarVehiculo').click(function () {
            $('#idVehiculoCotizado').val('null');
            $('#observacion').val('');
            $('#costo_poliza').val('');
            $('#matricula').val('');
            $('#valor').val('');
            $('#soat').val('');

            $('#marcvh_id').val('').select2();

            $('#modvh_codigo').empty();
            $('#modvh_codigo').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#modvh_codigo').select2();

            $('#anio').empty();
            $('#anio').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#anio').select2();
            $("#colVh_id").val($("#colVh_id option:first").val()).select2();
            $('#modalVehiculos').modal('show');
        });

        $('#btnAgregarRetomaVehiculo').click(function () {
            $('#ano').val('null');
            $('#idcot').val('');
            $('#Kilometraje').val('');
            $('#modelo').val('');
            $('#valor').val('');
            $('#placa').val('');

            ////$('#marcvh_id').val('').select2();

            $('#modvh_codigo').empty();
            $('#modvh_codigo').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#modvh_codigo').select2();

            $('#anio').empty();
            $('#anio').append($('<option>', {
                value: '',
                text: ''
            }));
            $('#anio').select2();
            $("#colVh_id").val($("#colVh_id option:first").val()).select2();
            $('#modalRetomaVehiculos').modal('show');
        });


        function EditarVehiculo(id) {
            event.preventDefault();
            $.ajax({
                url: '/cotizacion/EditarVehiculo',
                data: {
                    idDetalle: id,
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data.respuesta == true) {
                        $('#idVehiculoCotizado').val(data.detalle_id)
                        if (data.esNuevo) {
                            $("#rbNuevo").prop("checked", true)
                        } else {
                            $("#rbUsado").prop("checked", true)
                        }

                        $('#marcvh_id').val(data.marcaElegida).select2();

                        $('#modvh_codigo').empty();
                        for (var i = 0 ; i < data.listaModelos.length; i++) {
                            $('#modvh_codigo').append($('<option>', {
                                value: data.listaModelos[i].Value,
                                text: data.listaModelos[i].Text
                            }));
                        }
                        $('#modvh_codigo').val(data.modeloElegido);
                        $('#modvh_codigo').select2();
                        $('#colVh_id').val(data.colorElegido);
                        $('#colVh_id').select2();

                        // Años Vehiculo
                        $('#anio').empty();
                        for (var i = 0 ; i < data.listaAnios.length; i++) {
                            $('#anio').append($('<option>', {
                                value: data.listaAnios[i].Value,
                                text: data.listaAnios[i].Text
                            }));
                        }
                        $('#anio').val(data.anioElegido);
                        $('#anio').select2();

                        // Datos escritos por el usuario - Poliza, Matricula, Valor Y Descripcion
                        $('#observacion').val(data.observacion);
                        $('#costo_poliza').val(addComas(data.poliza));
                        $('#matricula').val(addComas(data.matricula));
                        $('#valor').val(addComas(data.precio));
                        $('#soat').val(addComas(data.soat));

                        $('#modalVehiculos').modal('show');
                        debugger;
                        var permisoRol =data.permiso;
                        console.log(permisoRol)
                        debugger;
                        if (permisoRol=="No") {
                            $('#valor').attr('readonly', true);
                        } else {
                            $('#valor').attr('readonly', false);
                        }


                    }
               }
            });

        }

        function calcularValorCotizacionAjax() {
            $("#tablaDetallesCotizacion").dataTable().fnDestroy();
            $("#tablaDetallesCotizacionAccesorio").dataTable().fnDestroy();
            $.ajax({
                url: '/cotizacion/CalcularTotalCotizacion',
                data: {
                    idCotizacion: '@ViewBag.idCotizacion'
                },
                type: "post",
                cache: false,
                success: function (data) {
                    console.log(data);
                    $('#tablaDetallesCotizacion').dataTable().fnDestroy();
                    $('#tablaDetallesCotizacion').find('tbody').empty();
                    for (var i = 0; i < data.listaVehiculos.length; i++) {
                        $('#tablaDetallesCotizacion').find('tbody').append('<tr><td align="left">' + data.listaVehiculos[i].descripcion + '</td><td align="right">$ '
                                        + addComas(data.listaVehiculos[i].valor) + '</td><td align="right">$ '
                                        + addComas(data.listaVehiculos[i].poliza) + '</td><td align="right">$ '
                                        + addComas(data.listaVehiculos[i].matricula) + '</td><td align="right">$ '
                                        + addComas(data.listaVehiculos[i].soat) + '</td><td width="25%" align="center"><button class="btn btn-primary btn-xs" title="Editar vehículo cotizado" onclick="EditarVehiculo('
                                + data.listaVehiculos[i].id_detalle + ')"><i class="fa fa-pencil-square-o"></i>&nbsp;&nbsp;&nbsp;</button>&nbsp;&nbsp;'
                                +'<button class="btn btn-info btn-xs" data-toggle="tooltip" data-placement="bottom" title="Plan de Pago" onclick="planPago('
                                + data.listaVehiculos[i].valor + ',\'' + data.listaVehiculos[i].codigo_modelovh +'\',' + data.listaVehiculos[i].id_detalle+')"><i class="fa fa-money"></i></button>'
                                +'&nbsp;&nbsp;<button class="btn btn-danger btn-xs" onclick="EliminarVehiculo('
                                + data.listaVehiculos[i].id_detalle + ')"><i class="fa fa-trash"></i>&nbsp;Eliminar&nbsp;&nbsp;</button></td></tr>');
                    }

                    $('#tablaDetallesCotizacionAccesorio').dataTable().fnDestroy();
                    $('#tablaDetallesCotizacionAccesorio').find('tbody').empty();
                    for (var i = 0; i < data.listaAccesorios.length; i++) {
                        $('#tablaDetallesCotizacionAccesorio').find('tbody').append('<tr><td align="left">'
                                        + data.listaAccesorios[i].codigo_referencia + '</td><td align="left">' + data.listaAccesorios[i].descripcion + '</td><td align="right">'
                                        + addComas(data.listaAccesorios[i].cantidad) + '</td><td align="right">$ '
                                        + addComas(data.listaAccesorios[i].valor) + '</td><td align="right">$ '
                                        + addComas(data.listaAccesorios[i].valor_total) + '</td><td width="15%" align="center"><button class="btn btn-primary btn-xs" onclick="EditarAccesorio('
                                + data.listaAccesorios[i].id_detalle + ')"><i class="fa fa-pencil-square-o"></i>&nbsp;Editar&nbsp;&nbsp;</button>&nbsp;&nbsp;<button class="btn btn-danger btn-xs" onclick="EliminarAccesorio('
                                + data.listaAccesorios[i].id_detalle + ')"><i class="fa fa-trash"></i>&nbsp;Eliminar&nbsp;&nbsp;</button></td></tr>');
                    }

                    $('#tablaDetallesCotizacionRetoma').dataTable().fnDestroy();
                    $('#tablaDetallesCotizacionRetoma').find('tbody').empty();
                    for (var i = 0; i < data.listaRetomas.length; i++) {
                        $('#tablaDetallesCotizacionRetoma').find('tbody').append('<tr><td align="left">' + data.listaRetomas[i].descripcion + '</td><td align="right">'
                                        + data.listaRetomas[i].anioVhretoma + '</td><td align="left">'
                                        + data.listaRetomas[i].placaretoma + '</td><td align="right">'
                                        + addComas(data.listaRetomas[i].kilometrajeretoma) + '</td><td align="right">$ '
                                        + addComas(data.listaRetomas[i].valor) + '</td><td width="15%" align="center"><button class="btn btn-primary btn-xs" onclick="EditarRetoma('
                                        + data.listaRetomas[i].id_detalle + ')"><i class="fa fa-pencil-square-o"></i>&nbsp;Editar&nbsp;&nbsp;</button>&nbsp;&nbsp;<button class="btn btn-danger btn-xs" onclick="EliminarRetoma('
                                        + data.listaRetomas[i].id_detalle + ')"><i class="fa fa-trash"></i>&nbsp;Eliminar&nbsp;&nbsp;</button></td></tr>');                                 
                    }
                    $('#cot_valortotal').val(data.totalCotizado);
                },
                complete: function (data) {
                    $('#tablaDetallesCotizacion').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });

                    $('#tablaDetallesCotizacionAccesorio').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });
                    $('#tablaDetallesCotizacionRetoma').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });
                }
            });
        }


        function traerReferencias(id) {
            var conteo_caracteres = $('#'+id).val().length;

            if (conteo_caracteres==3) {
                $.ajax({
                    url: '/cotizacion/buscarAccesoriosConsulta',
                    data: {
                        referencia: $('#' + id).val()
                    },
                    type: "post",
                    cache: false,
                    success: function (data) {
                        var referencias = {
                            data: data,
                            list: {
                                match: {
                                    enabled: true
                                }
                            }
                        };
                        $("#codigo").easyAutocomplete(referencias);
                        $("#codigo").focus();
                    }
                });
            }

        }

        $('#btnAgregarAccesorios').click(function () {
            debugger
            $.ajax({
                url: '/cotizacion/buscarAccesorios',
                data: {},
                type: "post",
                cache: false,
                success: function (data) {
                    $("#codigo").val('');
                    $('#txtCostoAccesorio').val('');
                    $('#txtCantidadAccesorio').val('');
                    $('#idRepuestoCotizado').val('null');
                },
                complete: function (data) {
                    $('#modalAccesorios').modal('show');
                }
            });
            misModelos();
        });


        $('#btnGuardarRepuesto').click(function () {
            if ($.trim($('#codigo').val()) == '' || $.trim($('#txtCostoAccesorio').val()) == '') {

                toastr.error('Los campos marcados con (*) son obligatorios');
                
                setTimeout(function () {
                    toastr.error('Los campos marcados con (*) son obligatorios');
                }, 3000);

            } else {
                guardarAccesorio();
            }
        });

        function guardarAccesorio() {
            debugger;
            //codigo_modelovh = { codigo_modelovh: $(this).val() };

            var code=$('#codigo').val();
            if ((code.indexOf('|') > -1) || (j !== "" && j !== undefined)) {
                var codigo = "";
                if (code != "") {
                    var codigo_arr = $('#codigo').val().split("|");
                    codigo2 = codigo_arr[0].trim();
                }
            }
            var cantidad = $('#txtCantidadAccesorio').val().replace(/\./g, "");
            if (cantidad <= 0||cantidad=="") {
                toastr.error("cantidad no puede ser '0'!");
            } else if ($('#ListModelAccesorio').val() == "") {
                toastr.error("Modelo no puede ser vacio!");
            } else {

                $.ajax({
                url: '/cotizacion/agregarReferencia',
                data: {
                    idReferencia: codigo2,
                    costo: $('#txtCostoAccesorio').val().replace(/\./g, ""),
                    cantidad:cantidad,
                    idCotizacion: '@ViewBag.idCotizacion',
                    idAccesorio: $('#idRepuestoCotizado').val(),
                    codigo_modelovh:$('#ListModelAccesorio').val(),
                },
                type: "post",
                cache: false,
                success: function (data) {debugger
                    if (data.OK == true) {
                        toastr.success(data.mensaje);

                        calcularValorCotizacionAjax();

                        setTimeout(function () {
                            toastr.success(data.mensaje);
                        }, 3000);

                    } else {
                        toastr.error(data.mensaje,"Accesorio no se ha agregado, verifique su conexion...");

                        setTimeout(function () {
                            toastr.error(data.mensaje,"Accesorio no se ha agregado, verifique su conexion...");
                        }, 3000);
                    }
                },
                error: function (error) {
                    debugger
                    toastr.mensaje("error",error.mensaje);
                },
                    complete: function (data) {debugger
                        toastr.warning(data.mensaje);
                    $('#modalAccesorios').modal('hide');
                }
            });
            }

            
        }

        function valida(id) {
            buscarAnuladas()
            window.location.href = '@Url.Action("Ver", "cotizacion")?menu='+@ViewBag.id_menu+'&&id=' + id;
        }

        function Seguimiento(id) {
            window.location.href = '@Url.Action("Seguimiento", "cotizacion")?menu='+@ViewBag.id_menu+'&&id=' + id;
        }

        function activarCC(id) {
            $('#asignado').val('').select2()
            $('#observaciones').val('')
            $('#idCotActivacion').val('')
            $.ajax({
                url: '/cotizacion/buscarCallCenter',
                data: {
                },
                type: "post",
                cache: false,
                success: function (data) {
                    $('#idCotActivacion').val(id)
                    $('#asignado').empty();

                    $('#asignado').append($('<option>', {
                        value: '',
                        text: ''
                    }));
                    for (var i = 0; i < data.length; i++) {
                        $('#asignado').append($('<option>', {
                            value: data[i].id,
                            text: data[i].nombre
                        }));
                    }
                },
                complete: function (data){
                    $('#modalActivacionCC').modal('show');
                }
            });
        }

        function guardarActivacion() {
            if ($('#asignado').val() != "" && $('#observaciones').val() != "") {
                $('#msjCamposObligatorios').hide('1000')
                $.ajax({
                    url: '/cotizacion/guardarActivacion',
                    data: {
                        idCot: $('#idCotActivacion').val(),
                        usuario: $('#asignado').val(),
                        nota: $('#observaciones').val()
                    },
                    type: "post",
                    cache: false,
                    success: function (data) {
                        console.log(data)
                        if (data.exito = true) {
                            $('#modalActivacionCC').modal('hide');
                            swal("Exito!", "La activación se ha realizado con éxito", "success");
                        }else {
                            $('#modalActivacionCC').modal('hide');
                            swal("Error!", "La activación no se pudo realizar con éxito", "error");
                        }
                    },
                    complete: function (data){
                    }
                });
            }else {
                $('#msjCamposObligatorios').show('1000')
            }
        }

        // Paginacion
        function buscarAjaxCotizaciones() {
            if ($.fn.DataTable.isDataTable('#tablaPaginada') ) {
                $('#tablaPaginada').dataTable().fnDestroy();
            }
            $.ajax({
                url: '/cotizacion/BuscarCotizacionesPaginadas',
                data: {
                    inicio: $('#txtFechaInicio').val(),
                    fin: $('#txtFechaFin').val()
                },
                type: "post",
                cache: false,
                success: function (data) {
                    console.log(data)
                    $('#tablaPaginada').find('tbody').empty();

                    for (var i = 0; i < data.buscaCotizacionSQL.length; i++) {
                        var botonRol = ""
                        if ($('#rolLog').val() == 2029) {
                            botonRol = '<button class="btn btn-warning btn-xs" onclick="activarProspecto(' +  data.buscaCotizacionSQL[i].cot_idserial + ',' + 1 + ')">&nbsp;&nbsp;Activar Asesor&nbsp;&nbsp;</button>';
                        }else {
                            botonRol = '<button class="btn btn-warning btn-xs" onclick="activarProspecto(' +  data.buscaCotizacionSQL[i].cot_idserial + ',' + 2 + ')">&nbsp;&nbsp;Activar Call Center&nbsp;&nbsp;</button>';
                        }

                        $('#tablaPaginada').find('tbody').append('<tr>'
                                        +'<td align="right">' + data.buscaCotizacionSQL[i].cot_numcotizacion + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].cot_feccreacion + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].doc_tercero + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].nombre + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].celular_tercero + '</td>'
                                        +'<td align="right">' + data.buscaCotizacionSQL[i].email_tercero + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].fuente + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].subfuente + '</td>'
                                        +'<td align="left">' +  data.buscaCotizacionSQL[i].asesor + '</td>'
                                        +'<td align="right">' + data.buscaCotizacionSQL[i].desTipoUltimoSeg + '</td>'
                                        +'<td align="right">' + data.buscaCotizacionSQL[i].notaultimoSeg + '</td>'
                                        +'<td width="15%" align="center">'
                                            +'<button class="btn btn-info btn-xs" onclick="valida('+ data.buscaCotizacionSQL[i].cot_idserial +')">&nbsp;&nbsp;Ver&nbsp;&nbsp;</button>&nbsp;&nbsp;'
                                            +'<button class="btn btn-primary btn-xs" onclick="Seguimiento(' + data.buscaCotizacionSQL[i].cot_idserial + ')">&nbsp;&nbsp;Seguimiento&nbsp;&nbsp;</button>&nbsp;&nbsp;'
                                            +'<button class="btn btn-success btn-xs" onclick="generarPDF2(' +  data.buscaCotizacionSQL[i].cot_idserial + ')">&nbsp;&nbsp;PDF&nbsp;&nbsp;</button>&nbsp;&nbsp;'
                                            + botonRol
                                        +'</td>'
                                    +'</tr>');
                    }
                },
                complete: function (data) {
                    $('#tablaPaginada').dataTable({
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });
                }
            })
        };


        $('#btnPreciosRetomas').click(function () {
            $("#tablaPaginadaPrecioRetoma").dataTable().fnDestroy();
            $.ajax({
                url: '/vlisretomas/CantidadVehiculos',
                data: {
                },
                type: "post",
                cache: false,
                success: function (data) {
                    $('#tablaPaginadaPrecioRetoma').find('tbody').empty();
                    for (var i = 0; i < data.length; i++) {
                        $('#tablaPaginadaPrecioRetoma').find('tbody').append('<tr><td align="center">'
                            + data[i].marca + '</td><td align="center">'
                            + data[i].estilo + '</td><td width="5%" align="center"><button class="btn btn-info btn-xs" onclick="validaCantModelos('
                            + '\'' + data[i].estilo.toString()
                            + '\')">&nbsp;&nbsp;' + data[i].cantidad + '&nbsp;&nbsp;</button></td></tr>');
                    }
                },
                complete: function (data) {
                    $('#tablaPaginadaPrecioRetoma').dataTable({
                        //dom: "<''<'col-sm-4'l><'col-sm-4 text-center'B><'col-sm-4'f>>t<'col-sm-4'i>p",
                        dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        buttons: []
                    });
                    $('#modalPreciosRetomas').modal('show');
                }
            });
        });

        function agregarRetoma() {
            debugger
            retNumero++;
            $('#lista_retomas').val(retNumero);
            $('#tablaDetallesCotizacionRetoma').append('<tr id="rowRetoma' + retNumero + '"><td align="left"><input type="hidden" name="modeloRetoma' + retNumero + '" id="modeloRetoma' + retNumero + '" value="' + $('#modeloRetoma').val() + '"/>' + $('#modeloRetoma').val() + ''
                                     + '</td><td align="right"><input type="hidden" name="anioRetoma' + retNumero + '" id="anioRetoma' + retNumero + '" value="' + $('#anioVehiculoRetoma').val() + '"/>' + $('#anioVehiculoRetoma').val() + ''
                                     + '</td><td align="left"><input type="hidden" name="placaRetoma' + retNumero + '" id="placaRetoma' + retNumero + '" value="' + $('#placaRetoma').val() + '"/>' + $('#placaRetoma').val() + ''
                                     + '</td><td align="right"><input type="hidden" name="valorDeRetoma' + retNumero + '" id="valorDeRetoma' + retNumero + '" value="' + $('#valorRetoma').val() + '"/>$ ' + $('#valorRetoma').val() + ''
                                     + '</td><td align="right"><input type="hidden" name="kilometrajeRetoma' + retNumero + '" id="kilometrajeRetoma' + retNumero + '" value="' + $('#kilometrajeRetoma').val() + '"/>' + $('#kilometrajeRetoma').val() + ''
                                     + '</td><td align="center">'
                                     + '<button class="btn btn-danger btn-circle" type="button" onclick="eliminarRetomaCotizado(' + retNumero + ')"><i class="fa fa-remove"></i></button></td></tr>');

            $('#placaRetoma').val('');
            $('#modeloRetoma').val('');
            $('#anioVehiculoRetoma').val('');
            $('#valorRetoma').val('');
            $('#kilometrajeRetoma').val('');
        }

        function eliminarRetomaCotizado(pos) {
            $("#rowRetoma" + pos + "").remove();
        }

    </script>

    @*======================= Plan pagos ==============================*@
    <script type="text/javascript">
        // MostrarTodosPlanes(parseInt(GlobalCotizacion),GlobalModelo,GlobalIdDetallePlanDePago);
        function MostrarTodosPlanes(GlobalCotizacion, GlobalModelo, GlobalIdDetallePlanDePago) {
            //GlobalIdDetallePlanDePago = id_detalle;
            $("#informacionCredito").show();
            //$("#tablaCreditos").dataTable().fnDestroy();
            $('#tablaCreditos').find('tbody').empty();
            debugger
            $.ajax({
                url: '/cotizacion/BuscarPlanesPagoCotizacion',
                data: {
                    xcotizacionid: GlobalCotizacion,modelo:GlobalModelo,id_detalle:GlobalIdDetallePlanDePago
                },
                type: "post",
                cache: false,
                success: function (data) {
                    debugger
                    for (var i = 0; i < data.length ; i++)
                    {
                        $('#tablaCreditos').find('tbody').append('<tr>'
                                +'<td align="right">$' + addCommas(data[i].credito) + '</td>'
                                +'<td align="right">' + data[i].tasa_interes  + '%</td>'
                                +'<td align="center">'
                                    +'<input type="hidden" id="cuotax' + data[i].plazo + '" value="' + data[i].plazo + '">'
                                    + data[i].plazo
                                +'</td>'
                                +'<td align="right">'
                                    +'<input type="hidden" id="valor_cuotax'+  addCommas(data[i].valor) +'" value="' +  addCommas(data[i].valor) + '">$'
                                    + addCommas(data[i].valor)
                                +'</td>'
                                +'<td align="center">'+ data[i].plan_nombre  + '</td>'
                                +'<td align="right">'+ addCommas(data[i].valor_residual)  + '</td>'
                            + '<td align="right">' + addCommas(data[i].otros_valores) + '</td>'
                            + '<td width="15%" align="center"></button>&nbsp;&nbsp;<button type="button" class="btn btn-danger btn-xs" onclick="EliminarPlanDePago('
                            + data[i].id_plan +","+ data[i].id_plazo +')"><i class="fa fa-trash"></i>&nbsp;Eliminar&nbsp;&nbsp;</button></td>'
                            + '</tr>');debugger
                    }
                },
                complete: function (data) {
                    //$('#tablaCreditos').dataTable({
                    //    dom: "<''<'col-md-6'l><'col-md-6'f>>t<'col-md-4'i><'col-md-8 text-right'pB>",
                    //    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                    //    buttons: []
                    //});
                }
            });
        }
   
        function QuitarDePago(cuotas) {
            debugger
               $("#QuitarCuotas" + cuotas + "").remove();
   
        }

        $('#valorRetoma').change(function () {
            var dato = $('#valorRetoma').val();
            $('#valor_retoma').val(dato);
        });

        $('#cuota_inicial').change(function () {
            var valor = $('#cuota_inicial').val().replace(/\./g, "");
            var valor2 = $('#valor_total').val().replace(/\./g, "");
            //var valor_retoma = $("#valorRetoma").val();
            var valor_retoma = 0;
            var total = valor2 - valor_retoma - valor ;
            $('#credito').val(addComas(total));
        });

        $('#modalCredito').on('hidden.bs.modal', function () {
            $(this).removeData('bs.modal'); //para borrar todos los datos que tenga los input, textareas, select.
            //$("alert.success").remove();  //lo utilice para borrar la etiqueta de error del jquery validate
        });

        ////// SUBMIT OJO ////
        $('#submitpago').click(function(e)
        {
            debugger
            $("#valor_total").prop('required',true);
            //     $("#tasa_interes").val('');
            var valor_total = $("#valor_total").val().replace(/\./g, "");
            var cuota_inicial = $("#cuota_inicial").val().replace(/\./g, "");
            var credito = $("#credito").val().replace(/\./g, "");
            var cuotas = $("#cuotas").val();
            //var plan_id = $("#plan_id").val();
            var plazos = "";
            var valor_cuota12 = $("#valor_cuota12").val();
            valor_cuota12 = parseFloat(valor_cuota12);
            if(cuotas != null)
            {
                for (var i = 0; i < cuotas.length; i++)
                {
                    plazos += cuotas[i] + ",";
                }
            }
            var form=$('#formcredito');
            var valid=this.form.checkValidity();
            if(valid)
            {
                event.preventDefault();
                console.log(plazos)
                debugger
                $.ajax({
                    url: '/cotizacion/AgregarPlanPago',
                    type: 'POST',
                    data:
                        {
                            idXCot: '@ViewBag.idCotizacion',
                            valor_total: valor_total,
                            cuota_inicial: cuota_inicial,
                            cuotas: plazos,
                            credito: credito,
                            tasa_interes: $("#tasa_interes").val(),
                            plan_id: $("#plan_id").val(),
                            cuota12: $("#cuota12").val(),
                            cuota24: $("#cuota24").val(),
                            cuota36: $("#cuota36").val(),
                            cuota48: $("#cuota48").val(),
                            cuota60: $("#cuota60").val(),
                            cuota72: $("#cuota72").val(),
                            cuota84: $("#cuota84").val(),
                            valor_cuota12: valor_cuota12,
                            valor_cuota24: $("#valor_cuota24").val(),
                            valor_cuota36: $("#valor_cuota36").val(),
                            valor_cuota48: $("#valor_cuota48").val(),
                            valor_cuota60: $("#valor_cuota60").val(),
                            valor_cuota72: $("#valor_cuota72").val(),
                            valor_cuota84: $("#valor_cuota84").val(),
                            valor_residual: $("#valor_residual").val().replace(/\./g, ""),
                            otros_valores: $("#otros_valores").val().replace(/\./g, ""),
                            //   11 - 02 ojo hoy aqui         // mod:
                            mod:GlobalModelo,
                    },

                    beforeSend:function(objeto)
                    {
                        $('#mensaje_enviando').show();
                        $('#cuerpo_mensaje_enviando').html('<i class="fa fa-spinner text-center" aria-hidden="true" ></i> Enviando datos...')
                    },
                }).done(function (result) {
                    $('#mensaje_enviando').hide();
                    if (result == 1) {
                        $("#mensaje").html('<i class="fa fa-check" aria-hidden="true" ></i> Plan de pago agregado con exito');
                        $("#mensaje").show();
                        // ojo 1 ver//
                        $("#tasa_interes").val("");
                        $("#valor_residual").val('');
                        $("#otros_valores").val('');
                        $("#cuota_inicial").val('');
                        $("#credito").val('');
                        $("#mensaje").val('');
                        $("#cuotas").val('').multiselect('refresh'); // limpiar el multiselect
                        //$("#informacionCredito").hide();
                        $('#modalCredito').modal('show');
                        $("#mensaje").hide();

                        // ojo 1 ver//
                           //setTimeout(function () {
                           //    $('#modalCredito').modal('hide');
                           //}, 1500);        var  = 0;

                        planPago(GlobalPlanDePagovalor,GlobalModelo,GlobalIdDetallePlanDePago);
                        var xcc =  '@ViewBag.idCotizacion';
                        var xccc = parseInt(xcc);

                        MostrarTodosPlanes(xccc);
                    } else {
                        $("#mensaje_error").html('<i class="fa fa-times" aria-hidden="true" ></i> Error en guardar plan de pago');
                        $("#mensaje_error").show();
                    }
                });
            } else{
                $("#mensaje_error").html('<i class="fa fa-times" aria-hidden="true" ></i> Error en guardar plan de pago. Debe seleccionar mínimo un plazo');
                $("#mensaje_error").show();
            }
        });
       
        function EliminarPlanDePago(id_plan,id_plazo) {
            debugger

            $("#modal_anulacion").modal('hide');
            swal({
                title: "¿Esta Seguro de Borrar el registro?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si, finalizar!",
                cancelButtonText: "No, cancelar!",
                closeOnConfirm: true,
                closeOnCancel: false
            },
            function (isConfirm) {
                if (isConfirm)
                {

                $.ajax({
                url: '/cotizacion/EliminarPlanDePago',
                data: {id_plan,id_plazo,id_cotizacion: '@ViewBag.idCotizacion'},
                type: "post",
                cache: false,
                success: function (data) {
                    debugger
                    if (data == true) {
                        calcularValorCotizacionAjax();
                    var xcc =  '@ViewBag.idCotizacion';
                        var xccc = parseInt(xcc);
                        debugger
                        MostrarTodosPlanes(xccc,GlobalModelo,GlobalIdDetallePlanDePago);
                    }
                }
                , error: function (error) {
                    toastr.error("error al eliminar el plan de Pago!");
                    }
                })

                } else {
                    swal("Cancelado", "La cotización no será modificada", "error");
                }
            });
          
        }
        // esto de abajo no aplica
        function guardarPlanPago()
        {
            debugger
            $("#valor_total").prop('required',true);

            var valor_total = $("#valor_total").val().replace(/\./g, "");
            var cuota_inicial = $("#cuota_inicial").val().replace(/\./g, "");
            var credito = $("#credito").val().replace(/\./g, "");
            var cuotas = $("#cuotas").val();
            //var plan_id = $("#plan_id").val();
            var plazos = "";
            var valor_cuota12 = $("#valor_cuota12").val();
            valor_cuota12 = parseFloat(valor_cuota12);
            if(cuotas != null){
                for (var i = 0; i < cuotas.length; i++) {
                    plazos += cuotas[i] + ",";
                }
            }
            var form=$('#formcredito');
            form.validate();
            if(form.valid){
                event.preventDefault();
                console.log(plazos)
                debugger
                $.ajax({
                    url: '/cotizacion/AgregarPlanPago',
                    type: 'POST',
                    data: {
                        idXCot: @ViewBag.idCotizacion,/// mmmm
                        valor_total: valor_total,
                        cuota_inicial: cuota_inicial,
                        cuotas: plazos,
                        credito: credito,
                        tasa_interes: $("#tasa_interes").val(),
                        // plan_id: $("#plan_id").val(),
                        cuota12: $("#cuota12").val(),
                        cuota24: $("#cuota24").val(),
                        cuota36: $("#cuota36").val(),
                        cuota48: $("#cuota48").val(),
                        cuota60: $("#cuota60").val(),
                        cuota72: $("#cuota72").val(),
                        cuota84: $("#cuota84").val(),
                        valor_cuota12: valor_cuota12,
                        valor_cuota24: $("#valor_cuota24").val(),
                        valor_cuota36: $("#valor_cuota36").val(),
                        valor_cuota48: $("#valor_cuota48").val(),
                        valor_cuota60: $("#valor_cuota60").val(),
                        valor_cuota72: $("#valor_cuota72").val(),
                        valor_cuota84: $("#valor_cuota84").val()
                    },
                    beforeSend:function(objeto){
                        $('#mensaje_enviando').show();
                        $('#cuerpo_mensaje_enviando').html('<i class="fa fa-spinner text-center" aria-hidden="true" ></i> Enviando datos...')
                    },
                }).done(function (result) {
                    debugger
                    $('#mensaje_enviando').hide();
                    if (result == 1) {
                        $("#mensaje").html('<i class="fa fa-check" aria-hidden="true" ></i> Plan de pago agregado con exito');
                        $("#mensaje").show();

                        // ojo 2 ver//
                        $("#tasa_interes").val('');
                        $("#valor_residual").val('');
                        $("#otros_valores").val('');
                        $("#cuota_inicial").val('');
                        $("#credito").val('');
                        $("#cuotas").val('').multiselect('refresh');
                        //        $("#informacionCredito").hide();
                        // ojo 2 ver//
                        //       setTimeout(function () {
                        //          $('#modalCredito').modal('hide');
                        //      }, 1000);

                    } else {
                        $("#mensaje_error").html('<i class="fa fa-times" aria-hidden="true" ></i> Error en guardar plan de pago');
                        $("#mensaje_error").show();
                    }

                });
            } else{
                event.preventDefault();
                $("#mensaje_error").html('<i class="fa fa-times" aria-hidden="true" ></i> Error en guardar plan de pago. Debe seleccionar mínimo un plazo');
                $("#mensaje_error").show();
            }
        }

        function planPago(valor,modelo,id_detalle)
        {
            GlobalPlanDePagovalor = valor;
            GlobalIdDetallePlanDePago = id_detalle;
            GlobalModelo = modelo;
            //var xcc =  '@ViewBag.idCotizacion';
            var Cotizacion = parseInt(GlobalCotizacion);
            debugger;
            $('#valor_total').val(addComas(valor));
            
            /// ojo3
            $("#tasa_interes").val('');
            $("#cuota_inicial").val('');
            $("#credito").val('');
            $("#cuotas").val('').multiselect('refresh');

            //$("#informacionCredito").hide();

            $("#informacionCredito").show();
            

            MostrarTodosPlanes(Cotizacion,GlobalModelo,GlobalIdDetallePlanDePago);
           
            $('#modalCredito').modal('show');
        }

        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + '.' + '$2');
            }
            return x1 + x2;
        }

        function validar(e, id)	//Solo numeros y SOLO 1 punto decimal
        {
            var key = (document.all) ? e.which : e.keyCode;
            cadena =  $('#' + id + '').val();
            console.log(cadena)
            if (cadena.indexOf('.') == -1)
            {
                return (key <= 13 || (key >= 48 && key <= 57) || key == 46);
            }
            else
            {
                return (key <= 13 || (key >= 48 && key <= 57));
            }
        }

        function validarComa(e, id)	//Solo numeros y SOLO 1 punto decimal
        {
            debugger
            var key = (document.all) ? e.which : e.keyCode;
            cadena =  $('#' + id + '').val();
            console.log(cadena)
            if (cadena.indexOf(',') == -1)
            {
                return (key <= 13 || (key >= 48 && key <= 57) || key == 46);
            }
            else
            {
                return (key <= 13 || (key >= 48 && key <= 57));
            }
            debugger
        }
        $('.SoloComa').on('input', function () {
          this.value = this.value.replace(/[^0-9,]/g, '').replace(/,/g, ',');
        });
        function noPunto( event ) {  
            var e = event || window.event;
            var key = e.keyCode || e.which;
            if ( key === 110 || key === 190 ) {             
               e.preventDefault();     
            }
        }

        function AgregarQuitarFavorito()
        {
            $.ajax({
                url: '/Inicio/AgregarQuitarFavorito',
                data: {
                    id_menu: @ViewBag.id_menu,
                },
                type: "post",
                cache: false,
                success: function (data) {
                    if (data.esFavorito == true) {
                        $('#areaFavoritos').html("<i class='fa fa-close'></i>&nbsp;&nbsp;<a href='#' onclick='AgregarQuitarFavorito();return false;'>Quitar de Favoritos</a>");
                    } else {
                        $('#areaFavoritos').html("<i class='fa fa-check'></i>&nbsp;&nbsp;<a href='#' onclick='AgregarQuitarFavorito();return false;'>Agregar a Favoritos</a>");
                    }
                }
            });
        }

        $('#plan_id').change(function () {
            debugger
            if ($('#plan_id').val() != "" && $('#plan_id').val() != null) {

                $.ajax({
                    url: '/cotizacion/buscasTasaInteres',
                    data: { id_plan: $('#plan_id').val() },
                    type: 'post',
                    cache: false,
                    success: function (data) {
                        $('#tasa_interes').val(data);
                        $('#tasa_interes').trigger('change');
                    }
                });
            }
        });

    </script>
}